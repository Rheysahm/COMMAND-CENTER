<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UG-Chinese Teaching Command Centre</title>
    
    <meta name="theme-color" content="#003262">

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --ug-blue: #003262;
            --ug-gold: #D4AF37;
            --ug-gold-light: #f3e5ab;
            --bg-page: #f4f6f8;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #27ae60;
            --success-light: #ecfdf5;
            --danger: #c0392b;
            --danger-light: #fef2f2;
            --note-bg: #fffdf0;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-page); margin: 0; color: var(--text-dark); padding-bottom: 50px; }

        /* --- AUTH & NAV --- */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--ug-blue); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
        .auth-box { background: white; padding: 40px; border-radius: 12px; width: 350px; text-align: center; color: var(--text-dark); box-shadow: 0 20px 50px rgba(0,0,0,0.3); border-top: 6px solid var(--ug-gold); }
        .auth-input-wrap { position: relative; margin: 20px 0; }
        .auth-input { width: 100%; padding: 12px; font-size: 1.2rem; text-align: center; letter-spacing: 5px; border: 2px solid #eee; border-radius: 6px; outline: none; transition: 0.3s; }
        .auth-input:focus { border-color: var(--ug-gold); }
        .auth-eye { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; font-size: 1.2rem; }
        .auth-btn { width: 100%; padding: 12px; background: var(--ug-blue); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .auth-btn:hover { background: #002244; }
        .hidden-app { display: none !important; }

        .main-nav { background-color: var(--ug-blue); padding: 10px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 1000; }
        .nav-brand { color: white; display: flex; flex-direction: column; line-height: 1.1; }
        .nav-brand-main { font-size: 1.6rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .nav-brand-sub { font-size: 0.9rem; font-weight: 700; opacity: 1; margin-top: 4px; letter-spacing: 0.5px; color: #FFD700; border-top: 1px solid rgba(255, 215, 0, 0.5); padding-top: 4px; display: inline-block; width: fit-content; }

        .nav-tabs { display: flex; gap: 5px; }
        .nav-tab { background: transparent; border: none; color: rgba(255,255,255,0.7); padding: 12px 18px; cursor: pointer; font-weight: 600; font-size: 0.95rem; border-bottom: 4px solid transparent; transition: 0.2s; }
        .nav-tab:hover { color: #FFD700; background: rgba(255,255,255,0.1); text-shadow: 0 0 1px #D4AF37; }
        .nav-tab.active { color: white; border-bottom-color: var(--ug-gold); background: rgba(255,255,255,0.1); }
        
        .sys-dropdown { position: relative; display: inline-block; margin-left: 10px; }
        .sys-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: var(--ug-gold); border-radius: 4px; padding: 10px 15px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .sys-btn:hover { background: var(--ug-gold); color: var(--ug-blue); }
        .sys-menu-content { display: none; position: absolute; right: 0; top: 100%; margin-top: 10px; background-color: white; min-width: 220px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1001; border-radius: 4px; overflow: visible; border: 1px solid var(--border); }
        .sys-menu-content::before { content: ''; position: absolute; top: -15px; left: 0; width: 100%; height: 20px; background: transparent; }
        .sys-menu-content button { color: var(--text-dark); padding: 12px 16px; text-decoration: none; display: block; width: 100%; text-align: left; border: none; background: none; cursor: pointer; transition: 0.1s; font-size: 0.9rem; }
        .sys-menu-content button:hover { background-color: #f8fafc; color: var(--ug-blue); }
        .sys-dropdown:hover .sys-menu-content { display: block; }

        .view-container { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .view-container.active { display: block; }

        /* --- DASHBOARD --- */
        .db-banner { background: linear-gradient(135deg, var(--ug-blue) 0%, #1e40af 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-left: 5px solid var(--ug-gold); }
        .section-title { font-size: 0.9rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 15px; border-bottom: 2px solid var(--ug-gold); display: inline-block; padding-bottom: 5px; }
        .course-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .course-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .cc-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; }
        .cc-title { font-weight: bold; color: var(--ug-blue); }
        .cc-avatar { background: var(--ug-gold); color: var(--ug-blue); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 0.8rem; }
        
        .week-row { background: white; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; overflow: hidden; transition: 0.3s; }
        .week-row-header { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: white; color: var(--ug-blue); transition: background 0.2s; border-left: 5px solid var(--ug-gold); }
        .week-row-header:hover { background-color: #f8fafc; }
        .week-row.active-week { border: 2px solid var(--ug-blue); box-shadow: 0 10px 20px rgba(0, 50, 98, 0.15); transform: scale(1.01); }
        .week-row.active-week .week-row-header { background: var(--ug-blue); color: var(--ug-gold); border-left: 8px solid var(--ug-gold); }
        .week-row.active-week .week-row-header span { color: var(--ug-gold) !important; }
        .week-row.active-week .week-row-header div { color: rgba(255,255,255,0.8); }

        .week-content { display: none; border-top: 1px solid var(--border); }
        .week-content.open { display: block; }
        
        .task-table { width: 100%; border-collapse: collapse; }
        .task-table td { padding: 10px 20px; border-bottom: 1px solid #f1f5f9; }
        .task-btn { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; color: var(--text-muted); transition: 0.2s; }
        .task-btn.done { background: var(--success-light); border-color: var(--success); color: #047857; font-weight: bold; }
        .dash-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--white); padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--ug-blue); }
        .stat-card h3 { margin: 0 0 5px 0; color: #7f8c8d; font-size: 0.85rem; text-transform: uppercase; }
        .stat-card .value { font-size: 1.5rem; font-weight: bold; color: var(--ug-blue); }
        .stat-card.gold { border-left-color: var(--ug-gold); }
        
        .att-toolbar { background: var(--white); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 15px; }
        .ctl-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: 600; font-size: 0.85rem; color: var(--ug-blue); }
        select, input[type="text"], input[type="file"], input[type="number"], input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fafafa; }
        .qr-textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.9rem; resize: vertical; }

        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: 0.2s; }
        .btn-gold { background: var(--ug-gold); color: var(--ug-blue); } .btn-gold:hover { background: #bfa030; }
        .btn-dark { background: var(--ug-blue); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-reset { background: #95a5a6; color: white; font-size: 0.9rem; }
        .btn-blue { background: #3498db; color: white; }
        
        .att-table-wrap { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-height: 300px; position: relative; }
        .att-table { width: 100%; border-collapse: collapse; }
        .att-table th { background: var(--ug-blue); color: white; padding: 12px 15px; text-align: left; cursor: pointer; user-select: none; }
        .att-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.95rem; vertical-align: middle; }
        .att-table tr:hover { background-color: #f1f4f9; }
        
        /* Sorting Arrows */
        .sort-arrow { display: inline-block; margin-left: 5px; font-size: 0.8em; opacity: 0.5; }
        .sort-asc::after { content: '‚ñ≤'; opacity: 1; color: var(--ug-gold); }
        .sort-desc::after { content: '‚ñº'; opacity: 1; color: var(--ug-gold); }
        .sort-none::after { content: '‚Üï'; }

        .clickable-name { color: var(--ug-blue); font-weight: bold; cursor: pointer; border-bottom: 1px dashed transparent; transition:0.2s; }
        .clickable-name:hover { border-bottom-color: var(--ug-gold); background: #fffde7; }
        
        .att-switch { display: flex; background: #e9ecef; border-radius: 20px; width: fit-content; padding: 2px; }
        .att-switch label { padding: 4px 12px; border-radius: 16px; font-size: 0.8rem; color: #666; cursor: pointer; transition: 0.2s; margin:0; }
        .att-switch input { display: none; }
        .att-switch input:checked + label { color: white; }
        .att-switch input[value="Present"]:checked + label { background: var(--success); }
        .att-switch input[value="Absent"]:checked + label { background: var(--danger); }
        
        .badge { padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; min-width: 50px; display: inline-block; text-align: center; }
        .bg-green { background: #d4edda; color: #155724; } .bg-red { background: #f8d7da; color: #721c24; } .bg-yellow { background: #fff3cd; color: #856404; }
        .curr-week-badge { background: white; color: var(--ug-blue); padding: 5px 12px; border-radius: 4px; font-weight: 800; font-size: 0.85rem; margin-left: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .manage-bar { background: var(--danger-light); border: 1px solid #ffcdd2; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .db-stats-bar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .db-stat-box { background: white; padding: 10px; border-radius: 6px; border: 1px solid var(--border); text-align: center; }
        .db-stat-box div:first-child { font-size: 0.75rem; color: #666; font-weight: bold; }
        .db-stat-box div:last-child { font-size: 1.2rem; font-weight: bold; color: var(--ug-blue); }
        .db-pill { padding: 5px 15px; border-radius: 20px; border: 1px solid var(--ug-blue); background: white; color: var(--ug-blue); cursor: pointer; transition:0.2s; }
        .db-pill.active { background: var(--ug-blue); color: white; }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: hidden;}
        .modal-content { background: white; margin: 2% auto; padding: 25px; width: 800px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; z-index: 10; width: 30px; height: 30px; text-align: center; line-height: 30px; border-radius: 50%; background: #f1f1f1; }
        .modal-close:hover { background: #e0e0e0; color: #333; }
        
        #fab-note { position: fixed; bottom: 30px; right: 30px; background: var(--ug-gold); color: var(--ug-blue); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: grab; z-index: 1500; transition: transform 0.1s; user-select: none; }
        
        /* TA & CHISAG STYLES */
        .ta-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border); border-left: 5px solid var(--ug-gold); box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .ta-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .ta-info h3 { margin: 0 0 5px 0; color: var(--ug-blue); }
        .ta-info p { margin: 0; color: #666; font-size: 0.85rem; }
        .ta-del-btn { position: absolute; top: 10px; right: 10px; color: #999; background: #fff; border: 1px solid #eee; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; z-index: 5; font-size: 0.8rem; }
        .ta-del-btn:hover { color: var(--danger); border-color: var(--danger); background: var(--danger-light); }

        .ta-detail-view { display: none; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; margin-top: 15px; flex-direction: column; }
        .ta-header { background: var(--ug-blue); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .ta-sub-nav { display: flex; border-bottom: 1px solid #eee; background: #fafafa; }
        .ta-sub-tab { padding: 12px 20px; cursor: pointer; font-weight: bold; color: #666; border-bottom: 3px solid transparent; font-size: 0.9rem; }
        .ta-sub-tab.active { color: var(--ug-blue); border-bottom-color: var(--ug-blue); background: white; }
        .ta-pane { display: none; padding: 20px; }
        .ta-pane.active { display: block; }
        .ta-stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .ta-stat { background: #f8fafc; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #eee; }
        .ta-stat div:first-child { font-size: 0.8rem; color: #666; text-transform: uppercase; }
        .ta-stat div:last-child { font-size: 1.2rem; font-weight: bold; color: var(--ug-blue); }
        
        /* TASK ACCORDION STYLE */
        details.week-acc { margin-bottom: 10px; border: 1px solid #e2e8f0; border-radius: 6px; overflow: hidden; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        details.week-acc summary { padding: 12px 15px; cursor: pointer; font-weight: bold; color: var(--ug-blue); outline: none; transition: background 0.2s; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; list-style: none; }
        details.week-acc summary::-webkit-details-marker { display: none; }
        details.week-acc summary:hover { background: #eff6ff; }
        details.week-acc[open] summary { background: var(--ug-blue); color: white; border-bottom: 1px solid rgba(255,255,255,0.1); }
        details.week-acc summary::after { content: '+'; font-size: 1.2rem; font-weight: normal; }
        details.week-acc[open] summary::after { content: '-'; }
        .week-acc-content { padding: 0; }
        .acc-task-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #334155; display: flex; align-items: center; gap: 10px; }
        .acc-task-item:last-child { border-bottom: none; }
        .acc-task-item::before { content: '‚Ä¢'; color: var(--ug-gold); font-size: 1.5rem; line-height: 0; }

        .ta-headcount-bar { display: flex; gap: 20px; background: #f1f5f9; padding: 10px 15px; border-radius: 6px; margin-bottom: 15px; font-weight: bold; font-size: 0.9rem; color: #555; }
        .ta-hc-item { display: flex; align-items: center; gap: 6px; }
        
        /* CHISAG SPECIFIC */
        .pic-thumbnail { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--ug-blue); cursor: pointer; transition: transform 0.2s; }
        .pic-thumbnail:hover { transform: scale(3.5); z-index: 100; position: relative; border-color: var(--ug-gold); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .id-card-container { width: 400px; margin: 0 auto; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; font-family: 'Segoe UI', sans-serif; border: 1px solid #ddd; }
        .id-card-header { background: var(--ug-blue); height: 70px; position: relative; }
        .id-card-watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: bold; color: rgba(255,255,255,0.1); font-family: serif; pointer-events: none; }
        .id-card-photo-wrapper { width: 120px; height: 120px; margin: -60px auto 10px auto; border-radius: 50%; border: 5px solid white; overflow: hidden; background: #eee; position: relative; z-index: 2; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; }
        .id-card-photo { width: 100%; height: 100%; object-fit: cover; }
        .id-card-body { padding: 0 20px 15px 20px; text-align: center; }
        .id-card-name { color: var(--ug-blue); font-weight: 900; font-size: 1.2rem; margin: 0 0 5px 0; text-transform: uppercase; line-height: 1.2; }
        .id-card-id { color: var(--text-muted); font-weight: bold; font-size: 1rem; margin: 0 0 10px 0; font-family: monospace; }
        .id-card-level-badge { background: var(--ug-blue); color: white; padding: 4px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; display: inline-block; margin-bottom: 15px; }
        .id-card-qr-box { border: 2px solid #eee; padding: 8px; border-radius: 8px; display: inline-block; background: white; margin-bottom: 5px; }
        .id-card-qr-label { display: block; margin-top: 5px; font-weight: bold; font-size: 0.75rem; color: var(--text-dark); text-transform: uppercase; letter-spacing: 1px; }
        .id-card-footer { background: var(--ug-gold); color: var(--ug-blue); text-align: center; padding: 10px; font-weight: 900; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        #picture-modal-content { background: transparent; box-shadow: none; padding: 0; width: auto; max-width: 500px; text-align: center; display:flex; justify-content:center; align-items:center; height:100%; }
        #picture-modal-img { max-width: 90%; max-height: 90vh; border-radius: 8px; border: 5px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* WIZARD & SCAN STATS */
        .wiz-step { display: none; border-bottom: none; padding-bottom: 15px; margin-bottom: 15px; animation: fadeIn 0.3s; }
        .wiz-step.active { display: block; }
        .wiz-step h3 { margin-top: 0; color: var(--ug-blue); font-size: 1.4rem; }
        .scan-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .scan-stat { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; text-align: center; }
        .scan-stat .label { font-size: 0.75rem; color: #64748b; font-weight: bold; text-transform: uppercase; }
        .scan-stat .val { font-size: 1.2rem; color: var(--ug-blue); font-weight: bold; }
        .scan-stat.warning .val { color: var(--danger); }
        .scan-sec-title { font-weight: bold; color: var(--ug-blue); border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 15px; margin-bottom: 10px; font-size: 0.9rem; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        #chisag-table-body td { padding: 5px 8px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <h1 style="margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px;">Teaching Command Centre</h1>
        <p style="margin-top:0; opacity:0.8; margin-bottom:30px;">Dept. of African and Asian Languages</p>
        <div id="auth-login-box" class="auth-box">
            <h2 style="color:var(--ug-blue); margin-top:0;">System Access</h2>
            <p style="color:#666; font-size:0.9rem;">Enter your 5-digit PIN</p>
            <div class="auth-input-wrap">
                <input type="password" id="login-pin" class="auth-input" maxlength="5" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeyup="if(event.key==='Enter') authApp.login()">
                <span class="auth-eye" onclick="authApp.toggleEye('login-pin')">üëÅÔ∏è</span>
            </div>
            <button class="auth-btn" onclick="authApp.login()">UNLOCK SYSTEM</button>
        </div>
        <div id="auth-setup-box" class="auth-box hidden-app">
            <h2 style="color:var(--ug-blue); margin-top:0;">System Setup</h2>
            <p style="color:#666; font-size:0.9rem;">Create a 5-digit PIN to secure your data.</p>
            <div class="auth-input-wrap">
                <input type="password" id="setup-pin" class="auth-input" maxlength="5" placeholder="Enter PIN">
                <span class="auth-eye" onclick="authApp.toggleEye('setup-pin')">üëÅÔ∏è</span>
            </div>
            <div class="auth-input-wrap">
                <input type="password" id="setup-pin-confirm" class="auth-input" maxlength="5" placeholder="Confirm PIN">
                <span class="auth-eye" onclick="authApp.toggleEye('setup-pin-confirm')">üëÅÔ∏è</span>
            </div>
            <button class="auth-btn" onclick="authApp.setup()">SET PIN & START</button>
        </div>
    </div>

    <div id="main-app" class="hidden-app">
        <nav class="main-nav">
            <div class="nav-brand">
                <span class="nav-brand-main" id="sys-name-display">TEACHING COMMAND CENTRE</span>
                <span class="nav-brand-sub">Dept. of African and Asian Languages</span>
            </div>
            <div style="display:flex; align-items:center;">
               <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchView('dashboard')">Teaching Dashboard</button>
                    <button class="nav-tab" onclick="switchView('database')">Student Database</button>
                    <button class="nav-tab" onclick="switchView('attendance')">Class Attendance</button>
                    <button class="nav-tab" onclick="switchView('ta')">TA Portal</button>
                    <button class="nav-tab" onclick="switchView('chisag')" style="border-left:1px solid rgba(255,255,255,0.2); color:var(--ug-gold);">CHISAG System</button>
                </div>
                <div class="sys-dropdown">
                    <button class="sys-btn">System Menu <span>‚ñº</span></button>
                    <div class="sys-menu-content">
                        <button onclick="setupApp.startNew()">‚ö† Create New Semester</button>
                        <button onclick="setupApp.openArchiveModal()">üì• Archive Current Semester</button>
                        <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
                        <button onclick="archiveViewApp.open()">üìú View Archives</button>
                        <button onclick="backupApp.openModal()">‚öôÔ∏è Backup / Restore</button>
                        <button onclick="setupApp.open(true)">‚úé Edit System Layout</button>
                        <button onclick="authApp.logout()" style="color:var(--danger); border-top:1px solid #eee; font-weight:bold;">‚èª Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <div id="view-dashboard" class="view-container active">
            <div class="db-banner">
                <div><h2 id="cd-title" style="margin:0; font-size:1.4rem;">Loading...</h2><p id="cd-subtitle" style="margin:5px 0 0 0; opacity:0.9;">Checking calendar...</p></div>
                <div id="cd-badge" class="badge bg-green" style="font-size:1.2rem; padding:10px 20px;">--</div>
            </div>
            <div style="margin-bottom:30px;"><div class="section-title">Semester Overview</div><div id="dash-grid" class="course-grid"></div></div>
            <div style="margin-bottom:30px;"><div class="section-title">Weekly Tasks</div><div id="schedule-container"></div></div>
            <div id="fab-note" title="Sticky Notes"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
        </div>

        <div id="view-attendance" class="view-container">
            <div class="dash-cards">
                <div class="stat-card"><h3>Course</h3><div class="value" id="card-course">...</div></div>
                <div class="stat-card"><h3>Week</h3><div class="value" id="card-week">...</div></div>
                <div class="stat-card gold"><h3>Present Today</h3><div class="value" id="card-present">0</div></div>
            </div>
            <div class="att-toolbar">
                <div class="ctl-group"><label>Course</label><select id="course-select" onchange="attApp.updateContext()"></select></div>
                <div class="ctl-group"><label>Week</label><div style="display:flex; align-items:center;"><select id="week-select" onchange="attApp.updateContext()"></select><div id="curr-week-indicator" class="curr-week-badge" style="background:var(--ug-blue); color:white;"></div></div></div>
                <div class="ctl-group" style="min-width: 200px;"><label>Search List</label><input type="text" id="att-search" placeholder="Filter by Name or ID..." onkeyup="attApp.renderTable()" style="width: 100%;"></div>
                <div class="ctl-group" style="flex-grow: 1;"><label>Manual Check-in</label><div style="display: flex; gap:5px;"><input type="text" id="manual-checkin" placeholder="Type Index ID..." style="flex-grow:1"><button class="btn btn-gold" onclick="attApp.manualCheckIn()">Add</button></div></div>
                <div class="ctl-group"><label>Actions</label><div style="display:flex; gap:10px;"><button class="btn btn-danger" onclick="attApp.toggleManageMode()">Manage</button><button class="btn btn-dark" onclick="attApp.openQRModal()">üì∑ Scan / Upload</button><button class="btn btn-gold" onclick="attApp.openLogViewer()">üìÇ View Raw Data</button><button class="btn btn-gold" onclick="attApp.downloadReport()">Download Report</button></div></div>
            </div>
            <div id="att-manage-bar" class="manage-bar" style="display:none;">
                <div><strong style="color:var(--danger)">MANAGE MODE:</strong> Select students to modify.</div>
                <div style="display:flex; gap:10px;"><button class="btn btn-danger" onclick="attApp.resetSelected()">Reset Present</button><button class="btn btn-danger" style="background:#800000;" onclick="attApp.deleteSelectedEntries()">Remove from Course</button><button class="btn btn-reset" onclick="attApp.toggleManageMode()">Cancel</button></div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><div style="display:flex; align-items:center; gap:10px;"><input type="checkbox" id="present-sort-check" onchange="attApp.renderTable()"><label for="present-sort-check" style="font-weight:bold; color:var(--ug-blue); cursor:pointer;">Filter: Show Present First</label></div><div style="font-size:0.85rem; color:#666; font-style:italic;">Tip: Click a name to edit it.</div></div>
            <div class="att-table-wrap">
                <table class="att-table" id="main-table">
                    <thead><tr><th width="40" id="att-th-check" style="display:none;"><input type="checkbox" onchange="attApp.toggleSelectAll(this)"></th><th width="50">#</th><th width="120" onclick="attApp.sortData('id')">Index ID <span id="sort-icon-att-id" class="sort-arrow sort-none"></span></th><th onclick="attApp.sortData('name')">Student Name <span id="sort-icon-att-name" class="sort-arrow sort-asc"></span></th><th width="100" onclick="attApp.sortData('total')">Sem. Total <span id="sort-icon-att-total" class="sort-arrow sort-none"></span></th><th width="200" onclick="attApp.sortData('status')">Status <span id="sort-icon-att-status" class="sort-arrow sort-none"></span></th></tr></thead>
                    <tbody id="att-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-database" class="view-container">
            <div class="section-title">Master Student Database</div>
            <div class="db-stats-bar"><div class="db-stat-box"><div>Total Students</div><div id="stat-total">0</div></div><div class="db-stat-box"><div>Level 100</div><div id="stat-100">0</div></div><div class="db-stat-box"><div>Level 200</div><div id="stat-200">0</div></div><div class="db-stat-box"><div>Level 300</div><div id="stat-300">0</div></div><div class="db-stat-box"><div>Level 400</div><div id="stat-400">0</div></div></div>
            <div id="db-filter-container" style="display:flex; gap:10px; margin-bottom:15px; align-items:center; flex-wrap:wrap;">
                </div>
            <div id="db-delete-toolbar" class="manage-bar" style="display:none;"><div><strong style="color:var(--danger)">DELETE MODE:</strong> Select students to remove.</div><div style="display:flex; gap:10px;"><button class="btn btn-danger" onclick="dbView.deleteSelected()">Delete Selected</button><button class="btn btn-danger" style="background:#800000;" onclick="dbView.deleteAllInLevel()">Delete ALL (Current Level)</button><button class="btn btn-reset" onclick="dbView.toggleDeleteMode()">Cancel</button></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center;"><input type="text" style="width:70%; padding:10px; border:1px solid #ccc; border-radius:4px; margin-bottom:10px;" placeholder="Search Database by Name or ID..." onkeyup="dbView.search(this.value)"><span style="font-size: 0.85rem; color: #666; font-style: italic;">Hint: Click on name to edit</span></div>
            <div class="att-table-wrap" style="max-height: 500px; overflow-y: auto;"><table class="att-table"><thead><tr><th width="40" id="th-check" style="display:none;"><input type="checkbox" onchange="dbView.toggleSelectAll(this)"></th><th width="50">#</th><th onclick="dbView.sort('id')">Index ID <span id="sort-icon-db-id" class="sort-arrow sort-none"></span></th><th onclick="dbView.sort('name')">Student Name <span id="sort-icon-db-name" class="sort-arrow sort-asc"></span></th><th>Level</th></tr></thead><tbody id="db-table-body"></tbody></table></div>
        </div>

        <div id="view-ta" class="view-container" style="padding: 0; height: 90vh;">
            <iframe id="ta-iframe" style="width: 100%; height: 100%; border: none; border-radius: 8px;"></iframe>
        </div>

        <div id="view-chisag" class="view-container">
            <div class="db-banner" style="background: linear-gradient(135deg, #003262 0%, #002244 100%); border-left: 5px solid var(--ug-gold);">
                <div>
                    <h2 style="margin:0; font-size:1.4rem; color:var(--ug-gold);">CHISAG Management</h2>
                    <p style="margin:5px 0 0 0; opacity:0.9; color:white;">Chinese Students Association of Ghana</p>
                </div>
                <div style="text-align:right;">
                    <div style="color:var(--ug-gold); font-weight:bold; font-size:2rem;" id="chisag-total-count">0</div>
                    <div style="font-size:0.8rem; text-transform:uppercase;">Active Members</div>
                </div>
            </div>

            <div class="db-stats-bar">
                <div class="db-stat-box" style="cursor:pointer;" onclick="chisagApp.filterByLevel(100)"><div>Lvl 100</div><div id="chisag-lvl-100">0</div></div>
                <div class="db-stat-box" style="cursor:pointer;" onclick="chisagApp.filterByLevel(200)"><div>Lvl 200</div><div id="chisag-lvl-200">0</div></div>
                <div class="db-stat-box" style="cursor:pointer;" onclick="chisagApp.filterByLevel(300)"><div>Lvl 300</div><div id="chisag-lvl-300">0</div></div>
                <div class="db-stat-box" style="cursor:pointer;" onclick="chisagApp.filterByLevel(400)"><div>Lvl 400</div><div id="chisag-lvl-400">0</div></div>
                <div class="db-stat-box" style="cursor:pointer;" onclick="chisagApp.filterByLevel(0)"><div>Reset</div><div id="chisag-paid-count" style="color:var(--success);">0 Paid</div></div>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <div style="flex-grow: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0; color:var(--ug-blue);">Member Management</h3>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <div style="display:flex; gap:5px;">
                                <input type="file" id="chisag-import-file" style="display:none;" accept=".xlsx" onchange="chisagApp.importFile(this)">
                                <button class="btn btn-danger" style="font-size:0.8rem;" onclick="document.getElementById('chisag-import-file').value=''">Reset</button>
                            </div>
                            <button class="btn btn-danger" onclick="chisagApp.toggleManageMode()">Manage</button>
                            <button class="btn btn-blue" onclick="document.getElementById('chisag-import-file').click()">‚¨Ü Import Data</button>
                            <button class="btn btn-gold" onclick="chisagApp.exportFile()">‚¨á Export Excel</button>
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="text" id="chisag-search-filter" placeholder="Search Members (Name or ID)..." style="flex-grow:1; padding:10px; border:1px solid #ccc; border-radius:4px;" onkeyup="chisagApp.render()">
                        
                        <div style="display:flex; gap:5px; border-left:1px solid #eee; padding-left:10px;">
                            <input type="text" id="chisag-input-id" placeholder="Add Member (ID)" style="width:150px; padding:10px; border:1px solid #eee; border-radius:4px;" onkeyup="if(event.key==='Enter') chisagApp.lookup()">
                            <button class="btn btn-gold" onclick="chisagApp.lookup()">+</button>
                        </div>
                    </div>

                    <div id="chisag-delete-controls" style="display:none; margin-top:10px; padding:10px; background:var(--danger-light); border:1px solid #ffcdd2; border-radius:4px;">
                        <strong style="color:var(--danger)">DELETE MODE:</strong> Selected members will be removed.
                        <button class="btn btn-danger" style="margin-left:10px;" onclick="chisagApp.deleteSelected()">Delete Selected</button>
                        <button class="btn btn-reset" onclick="chisagApp.toggleManageMode()">Cancel</button>
                    </div>
                </div>
                <div style="width: 300px; background: #fffdf0; padding: 20px; border-radius: 8px; border: 1px solid var(--ug-gold-light);">
                    <h4 style="margin-top:0; color:var(--ug-blue);">üéâ Monthly Birthdays</h4>
                    <div id="chisag-bday-list" style="max-height:100px; overflow-y:auto; font-size:0.9rem;"></div>
                </div>
            </div>

            <div class="att-table-wrap">
                <table class="att-table">
                    <thead>
                        <tr>
                            <th id="chisag-th-check" style="display:none; width:40px;"><input type="checkbox" onchange="chisagApp.toggleSelectAll(this)"></th>
                            <th>No.</th>
                            <th>Picture</th>
                            <th style="cursor:pointer;" onclick="chisagApp.sort('id')">ID ‚Üï</th>
                            <th style="cursor:pointer;" onclick="chisagApp.sort('surname')">Surname ‚Üï</th>
                            <th style="cursor:pointer;" onclick="chisagApp.sort('otherNames')">Other Names ‚Üï</th>
                            <th style="cursor:pointer;" onclick="chisagApp.sort('level')">Level ‚Üï</th>
                            <th style="cursor:pointer;" onclick="chisagApp.sort('dues')">Dues ‚Üï</th>
                            <th>Souv. Paid</th>
                            <th>Souv. Taken</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="chisag-table-body"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="chisag-member-modal" class="modal">
        <div class="modal-content" style="width:600px;">
            <span class="modal-close" onclick="document.getElementById('chisag-member-modal').style.display='none'">&times;</span>
            <h2 style="color:var(--ug-blue);">Member Details</h2>
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:20px;">
                <div style="text-align:center;">
                    <div id="c-img-preview" style="width:120px; height:120px; background:#eee; border-radius:50%; margin:0 auto 10px auto; overflow:hidden; border:3px solid var(--ug-blue); display:flex; align-items:center; justify-content:center;">
                        <span style="color:#999; font-size:3rem;">üì∑</span>
                    </div>
                    <button class="btn btn-reset" onclick="document.getElementById('c-mod-pic').click()" style="font-size:0.8rem;">Upload Photo</button>
                    <div style="margin-top:5px; display:flex; justify-content:center; gap:5px;">
                        <input type="file" id="c-mod-pic" style="display:none" accept="image/*" onchange="chisagApp.handleImageUpload(this)">
                        <button class="btn btn-danger" style="font-size:0.7rem; padding:2px 5px;" onclick="document.getElementById('c-mod-pic').value=''; chisagApp.currentImg=''; chisagApp.updateImagePreview();">X</button>
                    </div>
                </div>
                <div style="background:#f8fafc; padding:15px; border-radius:6px; border:1px solid #e2e8f0;">
                    <div class="ctl-group" style="margin-bottom:10px;">
                        <label>Index ID</label>
                        <input type="text" id="c-mod-id" readonly style="background:#e9ecef; font-weight:bold;">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div class="ctl-group"><label>Surname</label><input type="text" id="c-mod-surname"></div>
                        <div class="ctl-group"><label>Other Names</label><input type="text" id="c-mod-othernames"></div>
                    </div>
                    <div class="ctl-group" style="margin-bottom:10px;">
                        <label>Level</label>
                        <select id="c-mod-level">
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="300">300</option>
                            <option value="400">400</option>
                        </select>
                    </div>
                    <div class="ctl-group" style="margin-bottom:10px;">
                        <label>Email</label>
                        <input type="email" id="c-mod-email">
                    </div>
                    <div class="ctl-group" style="margin-bottom:10px;">
                        <label>Birthday (Day - Month)</label>
                        <div style="display:flex; gap:10px;">
                            <select id="c-mod-dob-day" style="flex:1;"><option value="">Day</option></select>
                            <select id="c-mod-dob-month" style="flex:2;">
                                <option value="">Month</option>
                                <option value="Jan">January</option><option value="Feb">February</option><option value="Mar">March</option>
                                <option value="Apr">April</option><option value="May">May</option><option value="Jun">June</option>
                                <option value="Jul">July</option><option value="Aug">August</option><option value="Sep">September</option>
                                <option value="Oct">October</option><option value="Nov">November</option><option value="Dec">December</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                        <label><input type="checkbox" id="c-mod-dues"> Dues Paid</label>
                        <label><input type="checkbox" id="c-mod-souv-paid"> Souv. Paid</label>
                        <label><input type="checkbox" id="c-mod-souv-taken"> Souv. Taken</label>
                    </div>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button class="btn btn-danger" onclick="chisagApp.deleteMember()">Delete Member</button>
                <button class="btn btn-gold" onclick="chisagApp.saveMember()">Save Member</button>
            </div>
        </div>
    </div>

    <div id="picture-modal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" id="picture-modal-content">
            <img id="picture-modal-img" src="" alt="Enlarged Student Photo">
        </div>
    </div>

    <div id="chisag-qr-modal" class="modal">
        <div class="modal-content" style="width:400px; text-align:center; background: transparent; box-shadow: none;">
            <span class="modal-close" onclick="document.getElementById('chisag-qr-modal').style.display='none'" style="background:white; color:black; font-weight:bold;">&times;</span>
            <div id="printable-id-card" class="id-card-container">
                <div class="id-card-header">
                    <div class="id-card-watermark">UG</div>
                </div>
                <div class="id-card-photo-wrapper" id="qr-card-photo"></div>
                <div class="id-card-body">
                    <h2 class="id-card-name" id="qr-name-display"></h2>
                    <p class="id-card-id" id="qr-id-display"></p>
                    <div class="id-card-level-badge" id="qr-level-display"></div>
                    <div class="id-card-qr-box">
                        <div id="qr-display-area"></div>
                    </div>
                    <span class="id-card-qr-label">TUTORIAL ATTENDANCE ID</span>
                </div>
                <div class="id-card-footer">
                    UNIVERSITY OF GHANA ‚Ä¢ CHINESE SECTION
                </div>
            </div>
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-gold" onclick="chisagApp.downloadPDF()" style="flex-grow:1;">Download PDF (Centered A4)</button>
            </div>
        </div>
    </div>

    <div id="setup-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-height:90vh; overflow-y:auto;">
            <span class="modal-close" onclick="document.getElementById('setup-modal').style.display='none'">&times;</span>
            <h2 style="color:var(--ug-blue); border-bottom:1px solid #eee; padding-bottom:10px;">System Configuration</h2>
            
            <div id="wiz-step-1" class="wiz-step active">
                <h3>System Name</h3>
                <div class="ctl-group" style="margin-bottom:15px;"><input type="text" id="wiz-sys-name" value="Teaching Command Centre" style="width:100%; padding:12px; font-size:1.1rem; border:1px solid #ccc; border-radius:4px;"></div>
                <h3>Select Semester</h3>
                <div class="ctl-group" style="margin-bottom:15px;"><select id="wiz-sem-select" style="width:100%; padding:12px; font-size:1.1rem;" onchange="setupApp.loadCoursesForSem()"><option value="1">First Semester</option><option value="2">Second Semester</option></select></div>
                <h3>Semester Duration (Weeks)</h3>
                <div class="ctl-group" style="margin-bottom:15px;"><input type="number" id="wiz-weeks" value="12" min="10" max="20" style="width:100%; padding:12px; font-size:1.1rem;"></div>
            </div>

            <div id="wiz-step-2" class="wiz-step">
                <h3>Select Courses You Teach</h3>
                <p style="font-size:0.9rem; color:#666;">These will appear on your Teaching Dashboard.</p>
                <div class="wiz-course-grid" id="wiz-teach-list" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;"></div>
            </div>

            <div id="wiz-step-3" class="wiz-step">
                <h3>Select Attendance Classes</h3>
                <p style="font-size:0.9rem; color:#666;">Select classes and their <strong>First Day of Class</strong> to configure dates.</p>
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 15px; margin-bottom: 20px;">
                    <div id="wiz-att-list"></div>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                <button class="btn btn-reset" id="wiz-btn-back" onclick="setupApp.prevStep()" style="display:none; padding:12px 25px; font-size:1rem;">‚Üê Back</button>
                <div style="flex-grow:1;"></div>
                <button class="btn btn-gold" id="wiz-btn-next" onclick="setupApp.nextStep()" style="padding:12px 25px; font-size:1rem;">Next: Select Courses ‚Üí</button>
                <button class="btn btn-gold" id="wiz-btn-finish" onclick="setupApp.finish()" style="display:none; padding:12px 25px; font-size:1rem;">‚úì Finish & Build System</button>
            </div>
        </div>
    </div>
    
    <div id="archive-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="document.getElementById('archive-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue); margin-top:0;">Archive & Reset</h2><div style="background:#fff3cd; color:#856404; padding:10px; border-radius:4px; font-size:0.9rem; margin-bottom:15px;"><strong>Warning:</strong> This will save current data to Archives and wipe the system for a new semester.</div><p>Enter details for the semester you are closing.</p><div style="text-align:left;"><label>Academic Year</label><input type="text" id="arc-year" placeholder="2025/2026" maxlength="9" oninput="setupApp.formatArchiveInput(this)"><label>Semester</label><select id="arc-sem"><option value="1">First Semester</option><option value="2">Second Semester</option></select></div><button class="btn btn-gold" style="width:100%; margin-top:15px;" onclick="setupApp.processArchive()">Archive & Reset System</button></div></div>
    <div id="archive-view-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="document.getElementById('archive-view-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue);">Archived Semesters</h2><div id="archive-list-container" style="max-height:400px; overflow-y:auto; margin-bottom:15px;"></div><button class="btn btn-reset" onclick="document.getElementById('archive-view-modal').style.display='none'" style="width:100%">Close</button></div></div>
    <div id="master-backup-modal" class="modal"><div class="modal-content" style="max-height:90vh; display:flex; flex-direction:column;"><span class="modal-close" onclick="backupApp.closeModal()">&times;</span><h2 style="color:var(--ug-blue); margin-top:0;">System Data Manager</h2><div style="display:flex; gap:10px; border-bottom:1px solid #eee; margin-bottom:15px;"><button id="tab-backup" class="nav-tab" style="color:var(--text-dark); border-bottom:3px solid var(--ug-blue);" onclick="backupApp.switchTab('backup')">Create Backup</button><button id="tab-restore" class="nav-tab" style="color:var(--text-muted); border-bottom:3px solid transparent;" onclick="backupApp.switchTab('restore')">Restore Backup</button></div><div id="view-backup-panel" style="flex-grow:1; overflow-y:auto;"><p style="color:#666; font-size:0.9rem;">Select data to backup:</p><div class="sys-option-group"><div class="sys-option-header" onclick="backupApp.toggleSection('bk-db')">Student Database <span>‚ñº</span></div><div id="bk-db" class="sys-option-body open"><div class="sys-grid"><label class="sys-check-label"><input type="checkbox" class="bk-check-db" value="100" checked> Lvl 100</label><label class="sys-check-label"><input type="checkbox" class="bk-check-db" value="200" checked> Lvl 200</label><label class="sys-check-label"><input type="checkbox" class="bk-check-db" value="300" checked> Lvl 300</label><label class="sys-check-label"><input type="checkbox" class="bk-check-db" value="400" checked> Lvl 400</label></div></div></div><div class="sys-option-group"><div class="sys-option-header" onclick="backupApp.toggleSection('bk-att')">Attendance Records <span>‚ñº</span></div><div id="bk-att" class="sys-option-body open" style="padding:0;"></div></div><div class="sys-option-group"><div class="sys-option-header" onclick="backupApp.toggleSection('bk-task')">Dashboard Tasks <span>‚ñº</span></div><div id="bk-task" class="sys-option-body open" style="padding:0;"></div></div><label style="display:block; margin-bottom:10px; font-weight:bold; cursor:pointer;"><input type="checkbox" id="bk-check-notes" checked> Include Sticky Notes</label><label style="display:block; margin-bottom:10px; font-weight:bold; cursor:pointer; color:var(--ug-blue);"><input type="checkbox" id="bk-check-ta" checked> Include TA Portal Data</label><label style="display:block; margin-bottom:10px; font-weight:bold; cursor:pointer; color:var(--ug-gold);"><input type="checkbox" id="bk-check-chisag" checked> Include CHISAG System Data</label><label style="display:block; margin-bottom:20px; font-weight:bold; cursor:pointer; color:var(--text-dark); background:#f0f8ff; padding:5px; border-radius:4px;"><input type="checkbox" id="bk-check-raw" checked> Include Raw Scan Logs</label><div class="sys-option-group"><div class="sys-option-header">Backup Format</div><div class="sys-option-body open" style="padding:10px;"><label style="margin-right:15px; cursor:pointer;"><input type="checkbox" id="bk-fmt-excel" checked> Excel (.xlsx)</label><label style="cursor:pointer;"><input type="checkbox" id="bk-fmt-json" checked> JSON (.json)</label></div></div><button class="btn btn-gold" style="width:100%; padding:15px; font-size:1.1rem;" onclick="backupApp.executeBackup()">‚¨á Download Selected Backup(s)</button></div><div id="view-restore-panel" style="display:none; flex-grow:1; overflow-y:auto;"><div style="background:#fff3cd; color:#856404; padding:15px; border-radius:6px; margin-bottom:20px; border:1px solid #ffeeba;"><strong>Step 1:</strong> Select File (.xlsx or .json).<br><strong>Step 2:</strong> Choose data to restore.</div><input type="file" id="restore-file-input" accept=".json, .xlsx, .xls" style="width:100%; padding:15px; border:2px dashed #ccc; background:#f9f9f9; margin-bottom:20px;"><div id="restore-options-container" style="display:none;"><h3 style="color:var(--ug-blue); border-bottom:1px solid #eee; padding-bottom:5px;">File Contents</h3><div id="restore-dynamic-content"></div><button class="btn btn-danger" style="width:100%; padding:15px; font-size:1.1rem; margin-top:20px;" onclick="backupApp.executeRestore()">‚¨Ü Restore Selected Data</button></div></div></div></div>
    
    <div id="scan-override-modal" class="modal">
        <div class="modal-content" style="width:650px;">
            <span class="modal-close" onclick="document.getElementById('scan-override-modal').style.display='none'">&times;</span>
            <h2 style="color:var(--ug-blue); margin-top:0;">Attendance Analysis</h2>
            
            <div class="scan-stats-grid" style="grid-template-columns: repeat(5, 1fr); gap: 8px;">
                <div class="scan-stat">
                    <div class="label">Pasted</div>
                    <div class="val" id="scan-stat-total">0</div>
                </div>
                <div class="scan-stat warning" style="border-color:#ffeeba; background:#fffdf0;">
                    <div class="label" style="color:#856404;">Dupes</div>
                    <div class="val" id="scan-stat-dupes" style="color:#856404;">0</div>
                </div>
                <div class="scan-stat">
                    <div class="label">Valid</div>
                    <div class="val" id="scan-stat-valid">0</div>
                </div>
                <div class="scan-stat warning" style="border-color:#ffeeba; background:#fffdf0;">
                    <div class="label" style="color:#856404;">Out-Module</div>
                    <div class="val" id="scan-stat-oom" style="color:#856404;">0</div>
                </div>
                <div class="scan-stat warning" style="border-color:#f5c6cb; background:#fef2f2;">
                    <div class="label" style="color:#c0392b;">Unregistered</div>
                    <div class="val" id="scan-stat-unreg" style="color:#c0392b;">0</div>
                </div>
            </div>
            
            <p style="margin:5px 0 10px 0; font-size:0.9rem;">Marking <strong>PRESENT</strong> for: <span id="scan-target-course" style="font-weight:bold; color:var(--ug-blue);"></span></p>

            <div id="scan-out-of-module-container" style="display:none; background:#fff3cd; padding:10px; border-radius:6px; margin-bottom:15px; border:1px solid #ffeeba;">
                <div style="font-weight:bold; color:#856404; margin-bottom:5px;">‚ö†Ô∏è Out-of-Module Students Detected</div>
                <p style="margin:0 0 5px 0; font-size:0.85rem;">These students are in the database but not enrolled in the expected module (<span id="scan-expected-module"></span>). Check the box to add them to the class and mark present.</p>
                <div style="max-height:100px; overflow-y:auto; border:1px solid #e2e8f0; background:white;">
                    <table style="width:100%; font-size:0.85rem;">
                        <thead style="background:#fff3cd; border-bottom:1px solid #e2e8f0; position:sticky; top:0;">
                            <tr>
                                <th style="padding:5px; text-align:left; width:30px;"><input type="checkbox" onchange="attApp.toggleOOMAll(this)"></th>
                                <th style="padding:5px; text-align:left;">Select / Deselect All</th>
                            </tr>
                        </thead>
                        <tbody id="scan-oom-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="scan-unreg-container" style="display:none; background:#f8d7da; padding:10px; border-radius:6px; margin-bottom:15px; border:1px solid #f5c6cb;">
                <div style="font-weight:bold; color:#721c24; margin-bottom:5px;">üö® Non-Registered Students Detected</div>
                <p style="margin:0 0 5px 0; font-size:0.85rem;">These IDs are not in the main database at all. Check to add them to the database and mark present.</p>
                <div style="max-height:100px; overflow-y:auto; border:1px solid #e2e8f0; background:white;">
                    <table style="width:100%; font-size:0.85rem;">
                        <thead style="background:#f8d7da; border-bottom:1px solid #e2e8f0; position:sticky; top:0;">
                            <tr>
                                <th style="padding:5px; text-align:left; width:30px;"><input type="checkbox" onchange="attApp.toggleUnregAll(this)"></th>
                                <th style="padding:5px; text-align:left;">Select / Deselect All</th>
                            </tr>
                        </thead>
                        <tbody id="scan-unreg-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="scan-sec-title">Valid Students (Auto-Selected)</div>
            <div style="max-height:200px; overflow-y:auto; border:1px solid #ddd; border-radius:6px; margin-bottom:20px;">
                <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                    <thead style="background:#f4f6f8; position:sticky; top:0;">
                        <tr><th style="padding:8px;">ID</th><th style="padding:8px;">Name</th><th style="padding:8px; text-align:center;">Status</th></tr>
                    </thead>
                    <tbody id="scan-valid-body"></tbody>
                </table>
            </div>
            
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-reset" onclick="document.getElementById('scan-override-modal').style.display='none'">Cancel</button>
                <button class="btn btn-gold" onclick="attApp.saveScanOverrides()">‚úì Confirm & Save Attendance</button>
            </div>
        </div>
    </div>

    <div id="raw-log-modal" class="modal">
        <div class="modal-content" style="width:800px; height:80vh;">
            <span class="modal-close" onclick="document.getElementById('raw-log-modal').style.display='none'">&times;</span>
            <h2 style="color:var(--ug-blue); margin-top:0;">Raw Scan Data Logs</h2>
            <div class="att-toolbar" style="margin:0 0 15px 0; padding:10px; display:flex; gap:10px; align-items:flex-end;">
                <div class="ctl-group"><label>Filter Course</label><select id="raw-filter-course" onchange="attApp.renderRawLogs()"><option value="">All Courses</option></select></div>
                <div class="ctl-group"><label>Filter Week</label><select id="raw-filter-week" onchange="attApp.renderRawLogs()"><option value="">All Weeks</option></select></div>
                <div class="ctl-group" style="flex-grow:1;"><label>Search Details</label><input type="text" id="raw-search" placeholder="Search raw content (ID, Name)..." onkeyup="attApp.renderRawLogs()"></div>
                <div class="ctl-group"><button class="btn btn-danger" onclick="attApp.toggleRawManageMode()">Manage</button></div>
            </div>
            <div id="raw-manage-bar" class="manage-bar" style="display:none; margin: 0 0 15px 0; padding:10px;">
                <div><strong style="color:var(--danger)">MANAGE MODE:</strong> Select logs to delete.</div>
                <div style="display:flex; gap:10px;"><button class="btn btn-danger" onclick="attApp.deleteSelectedRawLogs()">Delete Selected</button><button class="btn btn-reset" onclick="attApp.toggleRawManageMode()">Cancel</button></div>
            </div>
            <div class="att-table-wrap" style="flex-grow:1; overflow-y:auto;">
                <table class="att-table" style="table-layout: fixed; width: 100%;">
                   <thead>
                       <tr>
                           <th id="raw-th-check" style="display:none; width:25px;"><input type="checkbox" onchange="attApp.toggleRawSelectAll(this)"></th>
                           <th style="width: 70px; cursor:pointer;" onclick="attApp.sortRawLogs()">Course / Week <span id="sort-icon-raw-course" class="sort-arrow sort-asc"></span></th>
                           <th style="width: 70px; text-align:center;">Total Entries</th>
                           <th>Raw Content</th>
                       </tr>
                   </thead>
                    <tbody id="raw-log-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="db-confirm-modal" class="modal"><div class="modal-content" style="width:500px;"><span class="modal-close" onclick="document.getElementById('db-confirm-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue);">Confirm Import</h2><div id="db-select-list" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; margin-bottom:20px; padding:10px;"></div><div style="text-align:right;"><button class="btn btn-gold" onclick="dbView.finalizeImport()">‚úì Confirm & Add</button></div></div></div>
    <div id="att-confirm-modal" class="modal"><div class="modal-content" style="width:500px;"><span class="modal-close" onclick="document.getElementById('att-confirm-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue);">Confirm Restoration</h2><div id="att-select-list" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; margin-bottom:20px; padding:10px;"></div><div style="text-align:right;"><button class="btn btn-gold" onclick="attApp.finalizeRestore()">‚úì Restore</button></div></div></div>
    <div id="db-import-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="dbView.closeImportModal()">&times;</span>
            <h2 style="color:var(--ug-blue);">Import Database</h2>
          <div id="db-step-1">
                <div style="background:#f0f8ff; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #bde0fe;">
                    <label style="display:block; margin-bottom:5px; font-weight:bold; color:var(--ug-blue);">1. Select Level</label>
                    <select id="imp-level-select" onchange="dbView.updateImportCourses()" style="width:100%; margin-bottom:15px; padding:8px; border-radius:4px; border:1px solid #ccc;">
                        <option value="100">Level 100</option>
                        <option value="200" selected>Level 200</option>
                        <option value="300">Level 300</option>
                        <option value="400">Level 400</option>
                    </select>
                    <label style="display:block; margin-bottom:5px; font-weight:bold; color:var(--ug-blue);">2. Select Course Module (Optional)</label>
                    <select id="imp-course-select" style="width:100%; padding:8px; border-radius:4px; border:1px solid #ccc;">
                        </select>
                </div>
                <p>Option A: Upload Excel <button class="btn btn-reset" style="padding:2px 8px; font-size:0.7rem;" onclick="dbView.resetFile()">Reset</button></p>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="file" id="db-import-file" accept=".xlsx, .xls, .csv, .txt" style="margin-bottom:10px;">
                    <button class="btn btn-danger" onclick="document.getElementById('db-import-file').value=''">Reset</button>
                </div>
                <p>Option B: Paste List</p>
                <textarea id="db-paste-area" class="qr-textarea"></textarea>
                <div style="text-align:right; margin-top:20px;"><button class="btn btn-gold" onclick="dbView.previewImport()">Process</button></div>
            </div>
            <div id="db-step-2" style="display:none; text-align:center; padding:20px;"><h3 style="color:var(--success);">Success</h3><p><span id="import-new-stat">0</span> Students Added.</p><button class="btn btn-reset" onclick="dbView.closeImportModal()">Close</button></div>
        </div>
    </div>

    <div id="db-export-modal" class="modal"><div class="modal-content" style="width:400px;"><span class="modal-close" onclick="document.getElementById('db-export-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue);">Export Database</h2><div style="background:#f0f8ff; padding:20px; margin-bottom:20px;"><label style="display:block;"><input type="checkbox" name="exp-opt" value="100"> Level 100</label><label style="display:block;"><input type="checkbox" name="exp-opt" value="200" checked> Level 200</label><label style="display:block;"><input type="checkbox" name="exp-opt" value="300"> Level 300</label><label style="display:block;"><input type="checkbox" name="exp-opt" value="400" checked> Level 400</label></div><button class="btn btn-gold" style="width:100%;" onclick="dbView.executeExport()">Download</button></div></div>
    <div id="qr-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="document.getElementById('qr-modal').style.display='none'">&times;</span><h2 style="color:var(--ug-blue);">Scan / Upload Attendance</h2><div style="background:#f8fafc; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #e2e8f0;"><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;"><div style="border:1px solid #e2e8f0; padding:10px; border-radius:4px; max-height:150px; overflow-y:auto; background:white;"><label style="font-weight:bold; display:block; margin-bottom:5px; color:var(--text-dark);">Select Course(s):</label><div id="qr-course-checkboxes" style="display:flex; flex-direction:column; gap:5px;"></div></div><div style="border:1px solid #e2e8f0; padding:10px; border-radius:4px; max-height:150px; overflow-y:auto; background:white;"><label style="font-weight:bold; display:block; margin-bottom:5px; color:var(--text-dark);">Select Week(s):</label><div id="qr-week-checkboxes" style="display:flex; flex-direction:column; gap:5px;"></div></div></div><div id="qr-date-warning" style="display:none; color:#c0392b; font-size:0.85rem; margin-bottom:10px; padding:8px; background:#fef2f2; border:1px solid #fecaca; border-radius:4px;"></div><div style="border-top:1px solid #eee; padding-top:15px;"><p style="margin:0 0 5px 0; font-weight:bold; color:var(--ug-blue);">Paste List (Names/IDs):</p><textarea id="qr-input" class="qr-textarea" placeholder="Paste ID/Name list here..."></textarea><div style="display:flex; align-items:center; gap:10px; margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;"><span style="font-size:0.9rem; font-weight:bold; color:#666;">OR Excel File:</span><input type="file" id="qr-upload-file" accept=".xlsx, .xls, .csv, .txt" style="flex-grow:1;"><button class="btn btn-danger" onclick="document.getElementById('qr-upload-file').value=''">Reset</button></div></div></div><button class="btn btn-gold" style="width:100%; margin-top:10px;" onclick="attApp.processQRData()">Process Upload</button></div></div>
    <div id="edit-name-modal" class="modal"><div class="modal-content" style="width: 400px;"><span class="modal-close" onclick="editNameApp.close()">&times;</span><h2 style="color:var(--ug-blue);">Edit Name</h2><input type="text" id="edit-name-input" style="width:100%; padding:10px; font-size:1.1rem; margin-bottom:20px;"><input type="hidden" id="edit-id-hidden"><div style="text-align:right;"><button class="btn btn-gold" onclick="editNameApp.save()">Save</button></div></div></div>
    <div id="new-student-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="attApp.closeModal()">&times;</span><h2 style="color:var(--ug-blue);">New Students</h2><div id="new-student-list" class="preview-list"></div><div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;"><button class="btn btn-danger" onclick="attApp.closeModal()">Ignore</button><button class="btn btn-gold" onclick="attApp.confirmAddStudents()">Add & Mark</button></div></div></div>
    <div id="note-modal" class="modal"><div class="modal-content" style="background:var(--note-bg); border-top:5px solid var(--ug-gold);"><div id="note-list-view"><div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h2>Notes</h2><button class="btn btn-dark" onclick="noteApp.newNote()">+</button></div><div id="note-items-container" style="max-height:300px; overflow-y:auto;"></div><button class="btn btn-reset" style="margin-top:10px; width:100%;" onclick="noteApp.close()">Close</button></div><div id="note-edit-view" style="display:none; flex-direction:column;"><input type="text" id="edit-note-title" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Title"><textarea id="edit-note-body" style="width:100%; height:200px; padding:10px; background:var(--note-bg);"></textarea><div style="display:flex; justify-content:space-between; margin-top:15px;"><button class="btn btn-danger" onclick="noteApp.deleteNote()">Delete</button><div style="display:flex; gap:10px;"><button class="btn btn-reset" onclick="noteApp.showList()">Back</button><button class="btn btn-gold" onclick="noteApp.saveNote()">Save</button></div></div></div></div></div>

<script>
    var setupApp, backupApp, editNameApp, dashApp, noteApp, dbView, chisagApp, attApp, archiveViewApp, authApp;
    const S1_COURSES = ['CHIN 103','CHIN 105','CHIN 201','CHIN 203','CHIN 205','CHIN 301','CHIN 303','CHIN 307','CHIN 311','CHIN 401','CHIN 403','CHIN 407','CHIN 415'];
    const S2_COURSES = ['CHIN 104','CHIN 106','CHIN 202','CHIN 204','CHIN 206','CHIN 302','CHIN 304','CHIN 308','CHIN 312','CHIN 402','CHIN 404','CHIN 408','CHIN 416'];
    let sysConfig = { name: "Teaching Command Centre", semester: 1, totalWeeks: 13, startDate: new Date().toISOString(), teachCourses: [], attCourses: [], courseDates: {} };

    // --- UTILS & DB ---
    function formatName(rawName) { if(!rawName) return "UNKNOWN"; let clean = rawName.replace(/\d+$/, '').replace(/\s*\(.*?\)/g, '').trim(); return clean.replace(/,/g, " ").replace(/\s+/g, " ").trim().toUpperCase(); }
    function getWeekLabel(weekNum, courseCode = null) { let start = new Date(sysConfig.startDate); if(courseCode && sysConfig.courseDates && sysConfig.courseDates[courseCode]) { start = new Date(sysConfig.courseDates[courseCode]); } let d = new Date(start); d.setDate(d.getDate() + (weekNum - 1) * 7); return `Week ${weekNum} (${d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })})`; }
    function getDownloadFileName(prefix) { const now = new Date(); const day = now.getDate(); const month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][now.getMonth()]; const storageKey = `DL_Count_${prefix}_${day}${month}`; let count = parseInt(localStorage.getItem(storageKey)) || 0; count++; localStorage.setItem(storageKey, count); return `${prefix}${day}${month}${count}.xlsx`; }

    const db = {
        name: "UG_Unified_DB_Mohammed_v13", version: 11, // Incremented to add raw_logs
        db: null,
        open: function() { return new Promise((resolve, reject) => { const req = indexedDB.open(this.name, this.version); req.onupgradeneeded = e => { const d = e.target.result; if(!d.objectStoreNames.contains('students')) { const s = d.createObjectStore('students', {keyPath:'id'}); s.createIndex("level", "level", {unique:false}); } if(!d.objectStoreNames.contains('attendance')) d.createObjectStore('attendance', {keyPath:'key'}); if(!d.objectStoreNames.contains('tasks')) d.createObjectStore('tasks', {keyPath:'key'}); if(!d.objectStoreNames.contains('notes')) d.createObjectStore('notes', {keyPath:'id'}); if(!d.objectStoreNames.contains('settings')) d.createObjectStore('settings', {keyPath:'key'}); if(!d.objectStoreNames.contains('archives')) d.createObjectStore('archives', {keyPath:'key'}); if(!d.objectStoreNames.contains('ta_store')) d.createObjectStore('ta_store', {keyPath:'id'}); if(!d.objectStoreNames.contains('chisag_members')) d.createObjectStore('chisag_members', {keyPath:'id'}); 
        // NEW RAW LOGS STORE
        if(!d.objectStoreNames.contains('scan_logs')) { const sl = d.createObjectStore('scan_logs', {keyPath:'id'}); sl.createIndex('course', 'course', {unique:false}); } }; req.onsuccess = e => { this.db = e.target.result; resolve(); }; req.onerror = e => reject(e); }); },
        getAll: function(store) { return new Promise(r => this.db.transaction(store,'readonly').objectStore(store).getAll().onsuccess = e => r(e.target.result)); },
        put: function(store, item) { return new Promise(r => this.db.transaction(store,'readwrite').objectStore(store).put(item).onsuccess = () => r()); },
        get: function(store, key) { return new Promise(r => this.db.transaction(store,'readonly').objectStore(store).get(key).onsuccess = e => r(e.target.result)); },
        delete: function(store, key) { return new Promise(r => this.db.transaction(store,'readwrite').objectStore(store).delete(key).onsuccess = () => r()); },
        batchPut: function(store, items) { return new Promise(r => { const tx=this.db.transaction(store,'readwrite'); items.forEach(i=>tx.objectStore(store).put(i)); tx.oncomplete=()=>r(); }); },
        batchDel: function(store, keys) { return new Promise(r => { const tx=this.db.transaction(store,'readwrite'); keys.forEach(k=>tx.objectStore(store).delete(k)); tx.oncomplete=()=>r(); }); },
        clear: function(store) { return new Promise(r => this.db.transaction(store,'readwrite').objectStore(store).clear().onsuccess = () => r()); }
    };

    function switchView(view) { 
        document.querySelectorAll('.view-container').forEach(e => e.classList.remove('active')); 
        document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active')); 
        document.getElementById(`view-${view}`).classList.add('active'); 
        const tabs = document.querySelectorAll('.nav-tab'); 
       if(view === 'dashboard') tabs[0].classList.add('active'); 
        else if(view === 'database') { tabs[1].classList.add('active'); dbView.init(); } 
        else if(view === 'attendance') { tabs[2].classList.add('active'); attApp.updateContext(); }
        else if(view === 'ta') { tabs[3].classList.add('active'); } 
        else if(view === 'chisag') { tabs[4].classList.add('active'); chisagApp.init(); }
        document.getElementById('fab-note').style.display = view === 'dashboard' ? 'flex' : 'none'; 
    }
    window.switchView = switchView;

    // --- AUTH & SETUP APPS (Standard) ---
    authApp = {
        init: async function() {
            const pinRec = await db.get('settings', 'auth_pin');
            if(pinRec) {
                document.getElementById('auth-setup-box').classList.add('hidden-app');
                document.getElementById('auth-login-box').classList.remove('hidden-app');
            } else {
                document.getElementById('auth-login-box').classList.add('hidden-app');
                document.getElementById('auth-setup-box').classList.remove('hidden-app');
            }
        },
        toggleEye: function(id) { const input = document.getElementById(id); input.type = input.type === 'password' ? 'text' : 'password'; },
        setup: async function() { const p1 = document.getElementById('setup-pin').value; const p2 = document.getElementById('setup-pin-confirm').value; if(p1.length !== 5 || isNaN(p1)) return alert("PIN must be 5 digits."); if(p1 !== p2) return alert("PINs do not match."); await db.put('settings', {key: 'auth_pin', value: p1}); alert("Set PIN Successful"); location.reload(); },
        login: async function() { const input = document.getElementById('login-pin').value; const pinRec = await db.get('settings', 'auth_pin'); const stored = pinRec ? pinRec.value : null; if(input === stored || input === '00000') { document.getElementById('auth-overlay').style.display = 'none'; document.getElementById('main-app').classList.remove('hidden-app'); this.unlockSystem(); } else { alert("Incorrect PIN"); document.getElementById('login-pin').value = ''; } },
        unlockSystem: async function() { const savedConfig = await db.get('settings', 'config'); if(savedConfig) { sysConfig = savedConfig.value; document.getElementById('sys-name-display').innerText = sysConfig.name; dashApp.init(); attApp.init(); } else { setupApp.open(); } },
        logout: function() { location.reload(); }
    };

    setupApp = { 
        currentStep: 1, open: function(isEdit = false) { document.getElementById('setup-modal').style.display = 'block'; this.currentStep = 1; this.showStep(1); if(isEdit) { document.getElementById('wiz-sys-name').value = sysConfig.name; document.getElementById('wiz-sem-select').value = sysConfig.semester; document.getElementById('wiz-weeks').value = sysConfig.totalWeeks; } this.loadCoursesForSem(); }, 
        showStep: function(step) { document.querySelectorAll('.wiz-step').forEach(el => el.classList.remove('active')); document.getElementById('wiz-step-'+step).classList.add('active'); document.getElementById('wiz-btn-back').style.display = step > 1 ? 'block' : 'none'; document.getElementById('wiz-btn-next').innerText = step === 1 ? "Next: Select Courses ‚Üí" : "Next: Attendance Setup ‚Üí"; document.getElementById('wiz-btn-next').style.display = step < 3 ? 'block' : 'none'; document.getElementById('wiz-btn-finish').style.display = step === 3 ? 'block' : 'none'; this.currentStep = step; },
        nextStep: function() { if(this.currentStep < 3) { if(this.currentStep === 2) this.renderAttRows(); this.showStep(this.currentStep + 1); } },
        prevStep: function() { if(this.currentStep > 1) this.showStep(this.currentStep - 1); },
        startNew: function() { if(confirm("‚ö† WARNING: Creating a new semester requires archiving and resetting the current system.\n\nDo you want to proceed to the Archive screen?")) { this.openArchiveModal(); } }, 
        openArchiveModal: function() { document.getElementById('archive-modal').style.display = 'block'; document.getElementById('arc-year').value = ''; }, 
        formatArchiveInput: function(input) { let val = input.value.replace(/\D/g, ''); if (val.length > 4) { val = val.slice(0, 4) + '/' + val.slice(4, 8); } input.value = val; }, 
        processArchive: async function() { const year = document.getElementById('arc-year').value; const sem = document.getElementById('arc-sem').value; if(!year || year.length < 9) return alert("Please enter a valid academic year (e.g., 2025/2026)"); const archiveName = `${year} SEMESTER ${sem}`; const allStudents = await db.getAll('students'); const allAtt = await db.getAll('attendance'); const allTasks = await db.getAll('tasks'); const allNotes = await db.getAll('notes'); const archiveData = { key: archiveName, timestamp: new Date().toISOString(), config: sysConfig, students: allStudents, attendance: allAtt, tasks: allTasks, notes: allNotes }; await db.put('archives', archiveData); await db.clear('students'); await db.clear('attendance'); await db.clear('tasks'); await db.clear('notes'); await db.delete('settings', 'config'); alert(`System Archived as "${archiveName}" and Reset.`); location.reload(); }, 
        loadCoursesForSem: function() { const sem = parseInt(document.getElementById('wiz-sem-select').value); const list = sem === 1 ? S1_COURSES : S2_COURSES; const container = document.getElementById('wiz-teach-list'); container.innerHTML = ""; list.forEach(c => { const isChecked = sysConfig.teachCourses.includes(c) ? 'checked' : ''; container.innerHTML += `<label class="wiz-course-item" style="border:1px solid #eee; padding:10px; border-radius:4px; display:flex; align-items:center; cursor:pointer;"><input type="checkbox" class="wiz-teach-check" value="${c}" ${isChecked} style="margin-right:10px;"><b>${c}</b></label>`; }); }, 
        renderAttRows: function() { const selected = Array.from(document.querySelectorAll('.wiz-teach-check:checked')).map(cb=>cb.value); const attContainer = document.getElementById('wiz-att-list'); const existingDates = {}; document.querySelectorAll('.wiz-att-date').forEach(inp => existingDates[inp.dataset.course] = inp.value); attContainer.innerHTML = ""; if(selected.length === 0) { attContainer.innerHTML = "<p style='color:#666; font-style:italic;'>No courses selected in Step 2.</p>"; return; } selected.forEach(c => { const isAtt = sysConfig.attCourses.includes(c) ? 'checked' : ''; let dateVal = existingDates[c] || (sysConfig.courseDates && sysConfig.courseDates[c] ? new Date(sysConfig.courseDates[c]).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]); attContainer.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:10px 0;"><label style="display:flex; align-items:center; gap:10px; font-weight:bold; color:var(--ug-blue); cursor:pointer;"><input type="checkbox" class="wiz-att-check" value="${c}" ${isAtt} onchange="this.parentElement.nextElementSibling.style.visibility = this.checked ? 'visible' : 'hidden'"> ${c} </label><input type="date" class="wiz-att-date" data-course="${c}" value="${dateVal}" style="visibility:${isAtt ? 'visible' : 'hidden'}"></div>`; }); },
        finish: async function() { const name = document.getElementById('wiz-sys-name').value; const weeks = document.getElementById('wiz-weeks').value; const selectedTeach = Array.from(document.querySelectorAll('.wiz-teach-check:checked')).map(cb=>cb.value); const selectedAtt = Array.from(document.querySelectorAll('.wiz-att-check:checked')).map(cb=>cb.value); if(!name || !weeks) return alert("Please fill System Name and Weeks."); if(selectedTeach.length === 0) return alert("Please select at least one course."); sysConfig.name = name; sysConfig.semester = parseInt(document.getElementById('wiz-sem-select').value); sysConfig.totalWeeks = parseInt(weeks); sysConfig.teachCourses = selectedTeach; sysConfig.attCourses = selectedAtt; sysConfig.courseDates = {}; let earliest = null; document.querySelectorAll('.wiz-att-date').forEach(inp => { const c = inp.dataset.course; if(selectedAtt.includes(c) && inp.value) { sysConfig.courseDates[c] = new Date(inp.value).toISOString(); let d = new Date(inp.value); if(!earliest || d < earliest) earliest = d; } }); sysConfig.startDate = earliest ? earliest.toISOString() : new Date().toISOString(); await db.put('settings', {key:'config', value: sysConfig}); document.getElementById('setup-modal').style.display = 'none'; dashApp.init(); attApp.init(); document.getElementById('sys-name-display').innerText = sysConfig.name; } 
    };

    // --- OTHER APPS ---
    archiveViewApp = { open: async function() { document.getElementById('archive-view-modal').style.display = 'block'; this.renderList(); }, renderList: async function() { const container = document.getElementById('archive-list-container'); container.innerHTML = "Loading..."; const archives = await db.getAll('archives'); if(archives.length === 0) { container.innerHTML = "<p style='text-align:center; color:#999'>No archives found.</p>"; return; } container.innerHTML = ""; archives.forEach(arc => { const d = new Date(arc.timestamp).toLocaleDateString(); const sCount = arc.students ? arc.students.length : 0; container.innerHTML += `<div style="border:1px solid #eee; padding:10px; border-radius:4px; margin-bottom:10px; background:#fafafa;"><div style="font-weight:bold; color:var(--ug-blue); font-size:1.1rem;">${arc.key}</div><div style="font-size:0.8rem; color:#666; margin-bottom:8px;">Saved: ${d} ‚Ä¢ Students: ${sCount}</div><div style="display:flex; gap:10px;"><button class="btn btn-gold" style="padding:4px 10px; font-size:0.8rem;" onclick="archiveViewApp.download('${arc.key}')">Download Excel</button><button class="btn btn-danger" style="padding:4px 10px; font-size:0.8rem;" onclick="archiveViewApp.delete('${arc.key}')">Delete</button></div></div>`; }); }, download: async function(key) { const arc = await db.get('archives', key); if(!arc) return alert("Archive not found"); const wb = XLSX.utils.book_new(); if(arc.config) { const ws = XLSX.utils.aoa_to_sheet([["System_Configuration_JSON"], [JSON.stringify(arc.config)]]); XLSX.utils.book_append_sheet(wb, ws, "System_Config"); } if(arc.students && arc.students.length > 0) { const data = arc.students.map(s => ({id:s.id, name:s.name, level:s.level, courses: (s.courses||[]).join(',')})); const ws = XLSX.utils.json_to_sheet(data); XLSX.utils.book_append_sheet(wb, ws, "Students"); } if(arc.attendance && arc.attendance.length > 0) { const ws = XLSX.utils.json_to_sheet(arc.attendance); XLSX.utils.book_append_sheet(wb, ws, "Attendance"); } XLSX.writeFile(wb, `Archive_${key.replace(/[\/\\?%*:|"<>]/g, '-')}.xlsx`); }, delete: async function(key) { if(confirm(`Delete archive "${key}" permanently?`)) { await db.delete('archives', key); this.renderList(); } } };
    backupApp = { openModal: function() { document.getElementById('master-backup-modal').style.display='block'; this.renderBackupUI(); }, closeModal: function() { document.getElementById('master-backup-modal').style.display='none'; }, switchTab: function(tab) { document.getElementById('view-backup-panel').style.display = tab==='backup' ? 'block' : 'none'; document.getElementById('view-restore-panel').style.display = tab==='restore' ? 'block' : 'none'; document.getElementById('tab-backup').style.borderColor = tab==='backup' ? 'var(--ug-blue)' : 'transparent'; document.getElementById('tab-restore').style.borderColor = tab==='restore' ? 'var(--ug-blue)' : 'transparent'; if(tab === 'restore') { const fileInput = document.getElementById('restore-file-input'); fileInput.value = ''; fileInput.onchange = (e) => this.handleFileSelect(e); } }, toggleSection: function(id) { document.getElementById(id).classList.toggle('open'); }, renderBackupUI: function() { const weeks = Array.from({length: sysConfig.totalWeeks}, (_, i) => i + 1); let attHtml = ""; sysConfig.attCourses.forEach(c => { attHtml += `<div style="border-bottom:1px solid #eee;"><div style="padding:8px 15px; background:#fafafa; cursor:pointer; font-weight:bold;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'grid':'none'">${c} <span>‚ñº</span></div><div style="display:none; grid-template-columns:repeat(4,1fr); gap:5px; padding:10px;" class="sys-grid">${weeks.map(w => `<label class="sys-check-label"><input type="checkbox" class="bk-check-att" value="${c.replace(/\s/g,'')}_W${w}" checked> W${w}</label>`).join('')}</div></div>`; }); document.getElementById('bk-att').innerHTML = attHtml; let taskHtml = ""; sysConfig.teachCourses.forEach(c => { taskHtml += `<div style="border-bottom:1px solid #eee;"><div style="padding:8px 15px; background:#fafafa; cursor:pointer; font-weight:bold;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'grid':'none'">${c} <span>‚ñº</span></div><div style="display:none; grid-template-columns:repeat(4,1fr); gap:5px; padding:10px;" class="sys-grid">${weeks.map(w => `<label class="sys-check-label"><input type="checkbox" class="bk-check-task" value="w${w}_${c}" checked> W${w}</label>`).join('')}</div></div>`; }); document.getElementById('bk-task').innerHTML = taskHtml; }, executeBackup: async function() { const doExcel = document.getElementById('bk-fmt-excel').checked; const doJson = document.getElementById('bk-fmt-json').checked; const includeTA = document.getElementById('bk-check-ta').checked; const includeCHISAG = document.getElementById('bk-check-chisag').checked; const includeRaw = document.getElementById('bk-check-raw').checked; if(!doExcel && !doJson) return alert("Please select at least one output format."); const levels = Array.from(document.querySelectorAll('.bk-check-db:checked')).map(c=>parseInt(c.value)); const attKeys = Array.from(document.querySelectorAll('.bk-check-att:checked')).map(c=>c.value); const taskKeys = Array.from(document.querySelectorAll('.bk-check-task:checked')).map(c=>c.value); const includeNotes = document.getElementById('bk-check-notes').checked; const allStudents = await db.getAll('students'); const allAtt = await db.getAll('attendance'); const allTasks = await db.getAll('tasks'); const allNotes = await db.getAll('notes'); const allArchives = await db.getAll('archives'); let allTAs = []; if(includeTA) allTAs = await db.getAll('ta_store'); let allChisag = []; if(includeCHISAG) allChisag = await db.getAll('chisag_members'); let allLogs = []; if(includeRaw) allLogs = await db.getAll('scan_logs'); const finalStudents = allStudents.filter(s => levels.includes(s.level)); const finalAtt = allAtt.filter(r => attKeys.some(k => r.key.startsWith(k + "_"))); const finalTasks = allTasks.filter(t => taskKeys.includes(t.key)); const finalNotes = includeNotes ? allNotes : []; const fn = getDownloadFileName('SystemBackup'); if (doJson) { const data = { timestamp: new Date().toISOString(), config: sysConfig, students: finalStudents, attendance: finalAtt, tasks: finalTasks, notes: finalNotes, archives: allArchives, tas: allTAs, chisag: allChisag, logs: allLogs }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fn.replace('.xlsx','.json'); document.body.appendChild(a); a.click(); document.body.removeChild(a); } if (doExcel) { const wb = XLSX.utils.book_new(); const ws_config = XLSX.utils.aoa_to_sheet([["System_Configuration_JSON"], [JSON.stringify(sysConfig)]]); XLSX.utils.book_append_sheet(wb, ws_config, "System_Config"); if(finalStudents.length > 0) { const sData = finalStudents.map(s => ({id:s.id, name:s.name, level:s.level, courses: (s.courses||[]).join(',')})); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sData), "Students"); } if(finalAtt.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(finalAtt), "Attendance"); if(finalTasks.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(finalTasks), "Tasks"); if(finalNotes.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(finalNotes), "Notes"); if(allArchives.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allArchives.map(a => ({key: a.key, timestamp: a.timestamp, data: JSON.stringify(a)}))), "System_Archives"); if(allTAs.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allTAs.map(t => ({id: t.id, data: JSON.stringify(t.data)}))), "TA_Portal_Data"); if(allChisag.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allChisag), "CHISAG_Data"); if(allLogs.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allLogs.map(l => ({id:l.id, course:l.course, week:l.week, type:l.type, data: JSON.stringify(l.data)}))), "Scan_Logs"); XLSX.writeFile(wb, fn); } this.closeModal(); }, handleFileSelect: function(e) { const file = e.target.files[0]; if(!file) return; const r = new FileReader(); if(file.name.endsWith('.json')) { r.onload = (evt) => { try { this.parsedRestoreData = JSON.parse(evt.target.result); this.renderRestorePreview(); } catch(err) { alert("Invalid Backup File"); } }; r.readAsText(file); return; } r.onload = (evt) => { try { const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'}); let restoreData = { students: [], attendance: [], tasks: [], notes: [], archives: [], tas: [], chisag: [], logs: [] }; if(wb.Sheets['System_Config']) { const cData = XLSX.utils.sheet_to_json(wb.Sheets['System_Config'], {header:1}); if(cData.length > 1) { try { restoreData.config = JSON.parse(cData[1][0]); } catch(e){} } } if(wb.Sheets['Students']) { const sRows = XLSX.utils.sheet_to_json(wb.Sheets['Students']); restoreData.students = sRows.map(r => ({ id: String(r.id), name: r.name, level: parseInt(r.level), courses: r.courses ? String(r.courses).split(',') : [] })); } if(wb.Sheets['Attendance']) restoreData.attendance = XLSX.utils.sheet_to_json(wb.Sheets['Attendance']); if(wb.Sheets['Tasks']) restoreData.tasks = XLSX.utils.sheet_to_json(wb.Sheets['Tasks']); if(wb.Sheets['Notes']) restoreData.notes = XLSX.utils.sheet_to_json(wb.Sheets['Notes']); if(wb.Sheets['System_Archives']) { const aRows = XLSX.utils.sheet_to_json(wb.Sheets['System_Archives']); restoreData.archives = aRows.map(r => JSON.parse(r.data)); } if(wb.Sheets['TA_Portal_Data']) { const tRows = XLSX.utils.sheet_to_json(wb.Sheets['TA_Portal_Data']); restoreData.tas = tRows.map(r => ({id: r.id, data: JSON.parse(r.data)})); } if(wb.Sheets['CHISAG_Data']) { restoreData.chisag = XLSX.utils.sheet_to_json(wb.Sheets['CHISAG_Data']); } if(wb.Sheets['Scan_Logs']) { const lRows = XLSX.utils.sheet_to_json(wb.Sheets['Scan_Logs']); restoreData.logs = lRows.map(l => ({id:l.id, course:l.course, week:l.week, type:l.type, data: JSON.parse(l.data)})); } this.parsedRestoreData = restoreData; this.renderRestorePreview(); } catch(err) { console.error(err); alert("Error parsing Excel backup."); } }; r.readAsArrayBuffer(file); }, renderRestorePreview: function() { const d = this.parsedRestoreData; const container = document.getElementById('restore-dynamic-content'); container.innerHTML = ''; if(d.config) container.innerHTML += `<div class="sys-option-group"><div class="sys-option-header">System Configuration</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-config" checked> Restore System Config</label></div></div>`; let html = `<div class="sys-option-group"><div class="sys-option-header">Database</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-db" checked> Restore ${(d.students||[]).length} Students</label></div></div>`; html += `<div class="sys-option-group"><div class="sys-option-header">Attendance</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-att" checked> Restore ${(d.attendance||[]).length} Records</label></div></div>`; html += `<div class="sys-option-group"><div class="sys-option-header">Tasks</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-task" checked> Restore ${(d.tasks||[]).length} Tasks</label></div></div>`; if(d.tas && d.tas.length > 0) html += `<div class="sys-option-group"><div class="sys-option-header">TA Portal</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-ta" checked> Restore ${d.tas.length} TA Profiles</label></div></div>`; if(d.chisag && d.chisag.length > 0) html += `<div class="sys-option-group"><div class="sys-option-header">CHISAG System</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-chisag" checked> Restore ${d.chisag.length} CHISAG Members</label></div></div>`; if(d.logs && d.logs.length > 0) html += `<div class="sys-option-group"><div class="sys-option-header">Scan Logs</div><div class="sys-option-body open"><label><input type="checkbox" id="rs-check-logs" checked> Restore ${d.logs.length} Raw Logs</label></div></div>`; container.innerHTML += html; document.getElementById('restore-options-container').style.display = 'block'; }, executeRestore: async function() { const d = this.parsedRestoreData; if(document.getElementById('rs-check-config') && document.getElementById('rs-check-config').checked && d.config) await db.put('settings', {key:'config', value: d.config}); if(document.getElementById('rs-check-db').checked && d.students) await db.batchPut('students', d.students); if(document.getElementById('rs-check-att').checked && d.attendance) await db.batchPut('attendance', d.attendance); if(document.getElementById('rs-check-task').checked && d.tasks) await db.batchPut('tasks', d.tasks); if(document.getElementById('rs-check-ta') && document.getElementById('rs-check-ta').checked && d.tas) await db.batchPut('ta_store', d.tas); if(document.getElementById('rs-check-chisag') && document.getElementById('rs-check-chisag').checked && d.chisag) await db.batchPut('chisag_members', d.chisag); if(document.getElementById('rs-check-logs') && document.getElementById('rs-check-logs').checked && d.logs) await db.batchPut('scan_logs', d.logs); alert("Restore Complete. Page will reload."); location.reload(); } };
    editNameApp = { open: function(id, currentName) { document.getElementById('edit-id-hidden').value = id; document.getElementById('edit-name-input').value = currentName; document.getElementById('edit-name-modal').style.display = 'block'; document.getElementById('edit-name-input').focus(); }, close: function() { document.getElementById('edit-name-modal').style.display = 'none'; }, save: async function() { const id = document.getElementById('edit-id-hidden').value; const newName = document.getElementById('edit-name-input').value; const cleanName = formatName(newName); if(!cleanName) return alert("Name cannot be empty"); let s = await db.get('students', id); if(s) { s.name = cleanName; await db.put('students', s); await attApp.sync(); if(document.getElementById('view-attendance').classList.contains('active')) attApp.renderTable(); if(document.getElementById('view-database').classList.contains('active')) dbView.render(document.querySelector('#view-database input').value); if(document.getElementById('view-chisag') && document.getElementById('view-chisag').classList.contains('active')) chisagApp.init(); this.close(); } else alert("Error: Student ID not found."); } };
    
    // --- ATTENDANCE APP ---
    attApp = { 
        students: [], cache: [], attMap: new Map(), course: "", week: 1, sortCol: 'name', sortAsc: true, pending: [], pendingBatch: [], isManageMode: false, selected: new Set(), currentWeekVal: 0, scanTargetWeeks: [], scanTargetCourses: [], tempRawData: null,
        init: async function() { await this.sync(); }, 
        sync: async function() { this.cache = await db.getAll('students'); const recs = await db.getAll('attendance'); this.attMap.clear(); recs.forEach(r => this.attMap.set(r.key, r.status)); dbView.init(); }, 
        setCurrWeek: function(w) { this.currentWeekVal = w; this.updateContext(); }, 
        updateContext: async function() { 
            const selC = document.getElementById("course-select"); if (selC.options.length === 0) { sysConfig.attCourses.forEach(c => { const opt = document.createElement("option"); opt.value = c.replace(/\s/g, ''); opt.text = c; selC.appendChild(opt); }); if (sysConfig.attCourses.length > 0) this.course = sysConfig.attCourses[0].replace(/\s/g, ''); } else { this.course = selC.value; } if (!this.course && selC.options.length > 0) { this.course = selC.options[0].value; selC.value = this.course; } 
            const fullCourseName = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === this.course); const selW = document.getElementById("week-select"); const oldVal = parseInt(selW.value); selW.innerHTML = ""; let startDate = new Date(sysConfig.startDate); if(fullCourseName && sysConfig.courseDates && sysConfig.courseDates[fullCourseName]) { startDate = new Date(sysConfig.courseDates[fullCourseName]); } for(let i=1; i<=sysConfig.totalWeeks; i++) { let label = getWeekLabel(i, fullCourseName); let opt = document.createElement("option"); opt.value=i; opt.text=label; if(i === (isNaN(oldVal) ? this.currentWeekVal : oldVal)) { opt.selected=true; } selW.appendChild(opt); } this.week = parseInt(selW.value); let classDate = new Date(startDate); classDate.setDate(classDate.getDate() + (this.week - 1) * 7); classDate.setHours(0,0,0,0); let now = new Date(); now.setHours(0,0,0,0); document.getElementById("card-course").innerText = this.course.replace("CHIN", "CHIN "); document.getElementById("card-week").innerText = "Week " + this.week; const wi = document.getElementById('curr-week-indicator'); if(this.currentWeekVal > 0 && this.currentWeekVal <= sysConfig.totalWeeks) wi.innerText = "Current: Week " + this.currentWeekVal; else wi.innerText = ""; const enrolled = this.cache.filter(s => s.courses && s.courses.some(c => c.replace(/\s/g, '') === this.course)); const rawRecordsExist = enrolled.some(s => this.attMap.has(`${this.course}_W${this.week}_${s.id}`)); if (rawRecordsExist) { this.students = enrolled; } else { if (now > classDate) { let batch = []; enrolled.forEach(s => { const key = `${this.course}_W${this.week}_${s.id}`; this.attMap.set(key, "Absent"); batch.push({key, status:"Absent", course:this.course, week:this.week, id:s.id}); }); if(batch.length > 0) await db.batchPut('attendance', batch); this.students = enrolled; } else { this.students = []; } } this.count(); this.renderTable(classDate); 
        }, 
        toggleManageMode: function() { this.isManageMode = !this.isManageMode; this.selected.clear(); document.getElementById('att-manage-bar').style.display = this.isManageMode ? 'flex' : 'none'; document.getElementById('att-th-check').style.display = this.isManageMode ? 'table-cell' : 'none'; this.renderTable(); }, toggleSelect: function(id) { if(this.selected.has(id)) this.selected.delete(id); else this.selected.add(id); }, toggleSelectAll: function(cb) { let list = [...this.students]; if(document.getElementById('present-sort-check').checked) list = list.filter(s => this.getAtt(s.id) === 'Present'); if(cb.checked) list.forEach(s => this.selected.add(s.id)); else list.forEach(s => this.selected.delete(s.id)); this.renderTable(); }, 
        resetSelected: async function() { if(this.selected.size === 0) return alert("No students selected."); if(confirm(`Reset attendance to ABSENT for ${this.selected.size} students?`)) { let batch = []; for(let id of this.selected) { const key = `${this.course}_W${this.week}_${id}`; this.attMap.set(key, "Absent"); batch.push({key, status:"Absent", course:this.course, week:this.week, id}); } await db.batchPut('attendance', batch); this.toggleManageMode(); this.renderTable(); this.count(); alert("Done."); } }, 
        deleteSelectedEntries: async function() { if(this.selected.size === 0) return alert("No students selected."); if(confirm(`REMOVE ${this.selected.size} students from this course?\n\nThis will delete ALL attendance records for them in this course (Weeks 1-${sysConfig.totalWeeks}).`)) { const cleanC = this.course; const fullC = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === cleanC); let attKeysToDelete = []; let studentUpdates = []; for(let id of this.selected) { for(let w=1; w<=sysConfig.totalWeeks; w++) { attKeysToDelete.push(`${cleanC}_W${w}_${id}`); this.attMap.delete(`${cleanC}_W${w}_${id}`); } let s = this.cache.find(x => x.id === id); if(s) { s.courses = s.courses.filter(c => c !== fullC); studentUpdates.push(s); } } await db.batchDel('attendance', attKeysToDelete); if(studentUpdates.length > 0) await db.batchPut('students', studentUpdates); this.toggleManageMode(); this.updateContext(); alert("Students removed from course."); } }, 
        getAtt: function(id, w=this.week, c=this.course) { return this.attMap.get(`${c}_W${w}_${id}`) || "Absent"; }, getSemTotal: function(id) { let t=0; for(let i=1; i<=sysConfig.totalWeeks; i++) if(this.getAtt(id,i)==="Present") t++; return t; }, setAtt: async function(id, st) { const key = `${this.course}_W${this.week}_${id}`; this.attMap.set(key, st); this.renderTable(); this.count(); await db.put('attendance', {key, status:st, course:this.course, week:this.week, id}); }, count: function() { document.getElementById("card-present").innerText = `${this.students.filter(s=>this.getAtt(s.id)==='Present').length}`; }, 
        manualCheckIn: async function() { const id = document.getElementById('manual-checkin').value.trim(); if(!id) return; let s = this.cache.find(x => x.id === id); const fullC = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === this.course); if(s) { if(!s.courses.includes(fullC)) { s.courses.push(fullC); await db.put('students', s); } const prior = this.getAtt(s.id); if(prior === 'Present') { alert(`${s.name} is ALREADY marked present.`); } else { await this.setAtt(s.id, 'Present'); document.getElementById('manual-checkin').value = ""; alert(`${s.name} marked Present.`); } this.updateContext(); } else { if(confirm("ID not found in DB. Add as new?")) { this.pending=[{id,name:"Unknown"}]; this.openNewModal(); } } }, 
        openNewModal: function() { const list = document.getElementById('new-student-list'); list.innerHTML=''; this.pending.forEach(p => list.innerHTML += `<div class="note-item"><b>${p.id}</b> <span>${p.name}</span></div>`); document.getElementById('new-student-modal').style.display='block'; }, sortData: function(c) { if(this.sortCol===c) this.sortAsc=!this.sortAsc; else {this.sortCol=c;this.sortAsc=true;} this.renderTable(); }, 
        renderTable: function(classDateObj = null) { ['id','name','total','status'].forEach(c => { const el = document.getElementById(`sort-icon-att-${c}`); el.className = 'sort-arrow ' + (this.sortCol === c ? (this.sortAsc ? 'sort-asc' : 'sort-desc') : 'sort-none'); }); const tb = document.getElementById("att-table-body"); tb.innerHTML = ""; let list = [...this.students]; if(list.length === 0) { let msg = "No data for this week.<br>Wait for due date or upload data."; if(classDateObj) { let now = new Date(); now.setHours(0,0,0,0); if(now <= classDateObj) msg = "Class Has Not Ended Yet.<br>Wait for tomorrow for Auto-Fill, or Scan/Upload manually."; else msg = "Week is Empty.<br>No students found or list was cleared."; } tb.innerHTML = `<tr><td colspan='5' class='empty-state'>${msg}</td></tr>`; return; } const searchVal = document.getElementById('att-search').value.toLowerCase(); if(searchVal) { list = list.filter(s => s.name.toLowerCase().includes(searchVal) || s.id.includes(searchVal)); } if(document.getElementById('present-sort-check').checked) { list = list.filter(s => this.getAtt(s.id) === 'Present'); } list.sort((a,b) => { let vA, vB; if(this.sortCol==='total') { vA=this.getSemTotal(a.id); vB=this.getSemTotal(b.id); } else if(this.sortCol==='status') { vA=this.getAtt(a.id); vB=this.getAtt(b.id); } else { vA=a[this.sortCol]; vB=b[this.sortCol]; } if(vA<vB) return this.sortAsc?-1:1; if(vA>vB) return this.sortAsc?1:-1; return 0; }); list.forEach((s,i) => { const st = this.getAtt(s.id); const tot = this.getSemTotal(s.id); const bg = tot>=10?'bg-green':(tot>=6?'bg-yellow':'bg-red'); const check = this.isManageMode ? `<td><input type="checkbox" ${this.selected.has(s.id)?'checked':''} onchange="attApp.toggleSelect('${s.id}')"></td>` : ''; tb.innerHTML += `<tr>${check}<td>${i+1}</td><td style="font-family:monospace; font-weight:bold; color:var(--ug-blue)">${s.id}</td><td class="clickable-name" onclick="editNameApp.open('${s.id}', '${s.name}')">${s.name}</td><td><span class="badge ${bg}">${tot}/${sysConfig.totalWeeks}</span></td><td><div class="att-switch"><input type="radio" id="p_${s.id}" name="att_${s.id}" value="Present" ${st==='Present'?'checked':''} onchange="attApp.setAtt('${s.id}','Present')"><label for="p_${s.id}">Present</label><input type="radio" id="a_${s.id}" name="att_${s.id}" value="Absent" ${st==='Absent'?'checked':''} onchange="attApp.setAtt('${s.id}','Absent')"><label for="a_${s.id}">Absent</label></div></td></tr>`; }); }, 
        openQRModal: function() { document.getElementById('qr-modal').style.display='block'; document.getElementById('qr-input').value=''; document.getElementById('qr-upload-file').value=''; const populate = (containerId, items, values) => { const container = document.getElementById(containerId); container.innerHTML = ""; items.forEach((item, i) => { const val = values ? values[i] : item; const isChecked = (val === this.week || val === this.course); container.innerHTML += `<label style="display:flex; align-items:center; padding:2px 0;"><input type="checkbox" class="${containerId === 'qr-course-checkboxes' ? 'qr-course-cb' : 'qr-week-cb'}" value="${val.toString().replace(/\s/g,'')}" ${isChecked?'checked':''}> <span style="margin-left:5px">${item}</span></label>`; }); }; populate('qr-course-checkboxes', sysConfig.attCourses, sysConfig.attCourses); const weekLabels = []; const weekValues = []; const fullCourseName = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === this.course); for(let i=1; i<=sysConfig.totalWeeks; i++) { weekLabels.push(getWeekLabel(i, fullCourseName)); weekValues.push(i); } populate('qr-week-checkboxes', weekLabels, weekValues); }, 
        
        processQRData: async function() { 
            const fileInput = document.getElementById('qr-upload-file'); 
            const textArea = document.getElementById('qr-input').value; 
            const selectedCourses = Array.from(document.querySelectorAll('.qr-course-cb:checked')).map(cb => cb.value); 
            const selectedWeeks = Array.from(document.querySelectorAll('.qr-week-cb:checked')).map(cb => parseInt(cb.value)); 
            if (selectedCourses.length === 0) return alert("Please select at least one course."); 
            if (selectedWeeks.length === 0) return alert("Please select at least one week."); 
            
            if (fileInput.files.length > 0) { 
                const file = fileInput.files[0];
                const ext = file.name.split('.').pop().toLowerCase();
                
                if (ext === 'txt') {
                    const reader = new FileReader();
                    reader.onload = e => { this.executeScan(e.target.result, selectedWeeks, selectedCourses); };
                    reader.readAsText(file);
                } 
                else if (ext === 'pdf' || ext.startsWith('doc')) {
                    alert("To use Word or PDF files, please open the file, copy the text, and paste it into the 'Paste List' box.");
                    fileInput.value = '';
                } 
                else {
                    const r = new FileReader(); 
                    r.onload = e => { 
                        try {
                            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'}); 
                            this.processBulkAttendance(wb, selectedWeeks, selectedCourses); 
                        } catch(err) {
                            alert("Error reading file. Please ensure it is a valid Excel (.xls, .xlsx) or CSV file.");
                        }
                    }; 
                    r.readAsArrayBuffer(file); 
                }
            } else if (textArea.trim()) { 
                this.executeScan(textArea, selectedWeeks, selectedCourses); 
            } else { alert("Please paste a list or upload a file."); } 
        },
        
        // SAVE RAW LOGIC ADDED HERE (WITH MERGING)
        saveScanLog: async function(course, week, type, data) {
            const logs = await db.getAll('scan_logs');
            const existingLog = logs.find(l => l.course === course && l.week === week);
            
            let incomingData = Array.isArray(data) ? data : [data];

            if (existingLog) {
                // Fuse new data with existing data
                let currentData = Array.isArray(existingLog.data) ? existingLog.data : [existingLog.data];
                let combinedData = currentData.concat(incomingData);
                
                // Remove any exact duplicate lines from the fused data
                existingLog.data = [...new Set(combinedData)];
                existingLog.timestamp = new Date().toISOString(); // Update to latest scan time
                
                await db.put('scan_logs', existingLog);
            } else {
                // Create brand new log if it doesn't exist
                const id = `LOG_${course}_W${week}_${new Date().getTime()}`;
                const record = { id: id, timestamp: new Date().toISOString(), course: course, week: week, type: type, data: incomingData };
                await db.put('scan_logs', record);
            }
        },

        openLogViewer: async function() {
            document.getElementById('raw-log-modal').style.display='block';
            
            // Populate Filters
            const logs = await db.getAll('scan_logs');
            const courses = [...new Set(logs.map(l => l.course))].sort();
            const weeks = [...new Set(logs.map(l => l.week))].sort((a,b)=>a-b);
            
            const cSel = document.getElementById('raw-filter-course');
            cSel.innerHTML = '<option value="">All Courses</option>';
            courses.forEach(c => cSel.innerHTML += `<option value="${c}">${c}</option>`);
            
            const wSel = document.getElementById('raw-filter-week');
            wSel.innerHTML = '<option value="">All Weeks</option>';
            weeks.forEach(w => wSel.innerHTML += `<option value="${w}">Week ${w}</option>`);
            
            this.renderRawLogs(logs);
        },

        rawManageMode: false,
        rawSelected: new Set(),
        rawSortAsc: true,
        toggleRawManageMode: function() {
            this.rawManageMode = !this.rawManageMode;
            this.rawSelected.clear();
            document.getElementById('raw-manage-bar').style.display = this.rawManageMode ? 'flex' : 'none';
            document.getElementById('raw-th-check').style.display = this.rawManageMode ? 'table-cell' : 'none';
            this.renderRawLogs();
        },
        toggleRawSelect: function(id) { if(this.rawSelected.has(id)) this.rawSelected.delete(id); else this.rawSelected.add(id); },
        toggleRawSelectAll: function(cb) {
            const checkboxes = document.querySelectorAll('.raw-select-check');
            checkboxes.forEach(c => {
                c.checked = cb.checked;
                if(cb.checked) this.rawSelected.add(c.value); else this.rawSelected.delete(c.value);
            });
        },
        deleteSelectedRawLogs: async function() {
            if(this.rawSelected.size === 0) return alert("No logs selected.");
            if(confirm(`Delete ${this.rawSelected.size} selected logs forever?`)) {
                await db.batchDel('scan_logs', Array.from(this.rawSelected));
                this.toggleRawManageMode();
                this.renderRawLogs();
            }
        },
        sortRawLogs: function() {
            this.rawSortAsc = !this.rawSortAsc;
            document.getElementById('sort-icon-raw-course').className = 'sort-arrow ' + (this.rawSortAsc ? 'sort-asc' : 'sort-desc');
            this.renderRawLogs();
        },

        renderRawLogs: async function(preloadedLogs = null) {
            let logs = preloadedLogs;
            if(!logs) logs = await db.getAll('scan_logs');
            
            const filterC = document.getElementById('raw-filter-course').value;
            const filterW = document.getElementById('raw-filter-week').value;
            const search = document.getElementById('raw-search').value.toLowerCase();
            
            const tbody = document.getElementById('raw-log-body');
            tbody.innerHTML = '';
            
            // Custom sort by Course + Week (A-Z or Z-A)
            logs.sort((a,b) => {
                const keyA = `${a.course}_W${a.week.toString().padStart(2,'0')}`;
                const keyB = `${b.course}_W${b.week.toString().padStart(2,'0')}`;
                if(keyA < keyB) return this.rawSortAsc ? -1 : 1;
                if(keyA > keyB) return this.rawSortAsc ? 1 : -1;
                return 0;
            });
            
            logs.forEach(log => {
                if(filterC && log.course !== filterC) return;
                if(filterW && String(log.week) !== filterW) return;
                
                const contentStr = Array.isArray(log.data) ? log.data.join(', ') : String(log.data);
                if(search && !contentStr.toLowerCase().includes(search)) return;
                
                let displayContent = "";
                let entryCount = Array.isArray(log.data) ? log.data.length : 1;
                
                let highlightData = log.data;
                if(search) {
                    const regex = new RegExp(`(${search})`, 'gi');
                    if(Array.isArray(log.data)) {
                        highlightData = log.data.map(line => line.replace(regex, '<mark style="background:var(--ug-gold); color:var(--ug-blue);">$&</mark>'));
                    } else {
                        highlightData = String(log.data).replace(regex, '<mark style="background:var(--ug-gold); color:var(--ug-blue);">$&</mark>');
                    }
                }

                // New UI: Plain light box, ~10 lines visible, with horizontal/vertical scrolling
                if(Array.isArray(highlightData)) {
                    displayContent = highlightData.join('\n');
                } else {
                    displayContent = highlightData;
                }

                const checkHtml = this.rawManageMode ? `<td style="width:30px; vertical-align:top; padding-top:12px;"><input type="checkbox" class="raw-select-check" value="${log.id}" ${this.rawSelected.has(log.id)?'checked':''} onchange="attApp.toggleRawSelect('${log.id}')"></td>` : '';

                tbody.innerHTML += `
                    <tr>
                        ${checkHtml}
                        <td style="vertical-align:top; padding-top:12px;"><strong>${log.course}</strong><br><span style="font-size:0.85rem; color:#666;">Week ${log.week}</span></td>
                        <td style="text-align:center; font-weight:bold; color:var(--ug-blue); vertical-align:top; padding-top:12px;">${entryCount}</td>
                        <td style="vertical-align:top; max-width: 0; width: 100%; padding: 5px;">
                            <div style="width: 100%; max-height: 180px; overflow: auto; resize: vertical; white-space: pre; background: #f8fafc; color: #333; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: monospace; font-size: 0.85rem; line-height: 1.4; box-sizing: border-box;">${displayContent}</div>
                        </td>
                    </tr>
                `;
            });
            
            if(tbody.innerHTML === '') tbody.innerHTML = `<tr><td colspan="${this.rawManageMode ? 4 : 3}" style="text-align:center; padding:20px; color:#999;">No logs found.</td></tr>`;
        },

        processBulkAttendance: async function(wb, allowedWeeks, allowedCourses) {
            let batchAtt = []; let batchStudents = []; let count = 0; 
            let logsToSave = []; // Accumulate logs

            for (let i = 0; i < wb.SheetNames.length; i++) { 
                const sheetName = wb.SheetNames[i]; const ws = wb.Sheets[sheetName]; const data = XLSX.utils.sheet_to_json(ws); 
                let targetClean = allowedCourses.find(c => c.toLowerCase() === sheetName.toLowerCase().replace(/\s/g,'')); 
                if (!targetClean && wb.SheetNames.length === 1 && allowedCourses.length === 1) targetClean = allowedCourses[0]; 
                if (!targetClean) continue; 
                
                // Save raw rows for this course/sheet
                // We'll save a log for EACH week found in the sheet if relevant, or just one log per sheet upload?
                // Prompt says "save pasted raw data line by line". For Excel, the "lines" are the rows.
                // Let's allow saving the full JSON dump of the sheet rows as the "raw data" for the primary selected week(s).
                // Since user might select multiple weeks, we just save one log entry per upload action per course involved.
                // We'll associate it with the first selected week to keep it simple, or iterate.
                // Better: Iterate selected weeks and save log for each? No, that duplicates data.
                // I will save one log entry for the upload, tagged with the first selected week.
                const rawRows = data.map(row => JSON.stringify(row));
                logsToSave.push({ course: targetClean, week: allowedWeeks[0], type: "File Upload", data: rawRows });

                const targetFull = sysConfig.attCourses.find(c => c.replace(/\s/g,'') === targetClean); 
                let lvl = 0; const match = targetFull.match(/\d+/); if(match) lvl = Math.floor(parseInt(match[0])/100) * 100; 
                data.forEach(row => { 
                    const id = String(row['ID'] || row['Index ID'] || row['Student ID'] || row['__EMPTY'] || '').trim(); 
                    let name = "Unknown"; for (const k in row) { if (k.toLowerCase().includes('name')) name = row[k]; } 
                    if (!id || id.length < 5) return; 
                    let s = this.cache.find(x => x.id === id); 
                    if (!s) { s = {id: id, name: formatName(name), level: lvl, courses: [targetFull]}; batchStudents.push(s); this.cache.push(s); } 
                    else if (!s.courses.includes(targetFull)) { if (!batchStudents.find(bs => bs.id === id)) { s.courses.push(targetFull); batchStudents.push(s); } } 
                    Object.keys(row).forEach(key => { const weekMatch = key.match(/^(?:Week|Wk|W)\s*(\d+)$/i) || (key.match(/^\d+$/) ? [key, key] : null); 
                        if (weekMatch) { const weekNum = parseInt(weekMatch[1]); if (allowedWeeks.includes(weekNum) && weekNum <= sysConfig.totalWeeks) { 
                            const val = row[key]; let status = "Absent"; if (val == 1 || String(val).toLowerCase().startsWith('p') || String(val).toLowerCase() === 'yes') { status = "Present"; } 
                            const dbKey = `${targetClean}_W${weekNum}_${id}`; batchAtt.push({key: dbKey, status, course: targetClean, week: weekNum, id}); this.attMap.set(dbKey, status); count++; } } }); }); 
            } 
            
            // Save Logs
            for(let l of logsToSave) { await this.saveScanLog(l.course, l.week, l.type, l.data); }

            if(batchStudents.length > 0) await db.batchPut('students', batchStudents); 
            if(batchAtt.length > 0) await db.batchPut('attendance', batchAtt); 
            document.getElementById('qr-modal').style.display='none'; this.updateContext(); alert(`Excel Upload Complete.\nProcessed ${count} entries.\nRaw Data Saved.`); 
        },
        
        executeScan: async function(raw, targetWeeks, targetCourses) {
            if(!raw.trim()) return;
            const rawLines = raw.split(/\r?\n/).filter(line => line.trim() !== "");
            
            this.tempRawData = {
                lines: rawLines,
                weeks: targetWeeks,
                courses: targetCourses
            };

            let rawMatches = raw.match(/\b\d{8}\b/g) || [];
            let totalEntries = rawMatches.length;
            let counts = {}; rawMatches.forEach(x => counts[x] = (counts[x] || 0) + 1);
            let uniqueIDs = new Set(rawMatches);
            let duplicateCount = totalEntries - uniqueIDs.size;
            const primaryCourseCode = targetCourses[0]; 
            const fullC = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === primaryCourseCode);
            
            let validList = [];
            let outOfModuleList = [];
            let unregList = [];
            
            const cleanTargetCourse = primaryCourseCode.replace(/\s/g, '').toLowerCase();

            uniqueIDs.forEach(id => {
                const student = this.cache.find(s => s.id === id);
                if(student) {
                    // Stricter check ignoring spaces and casing
                    let isEnrolled = false;
                    if(student.courses && Array.isArray(student.courses)) {
                        isEnrolled = student.courses.some(c => c.replace(/\s/g, '').toLowerCase() === cleanTargetCourse);
                    }

                    if(isEnrolled) {
                        validList.push({id: student.id, name: student.name, status: "Valid"});
                    } else {
                        outOfModuleList.push({id: student.id, name: student.name, level: student.level, status: "Out of Module"});
                    }
                } else {
                    unregList.push({id: id, name: "New/Unknown", status: "Non-Registered"});
                }
            });

            // Sort Out of Module and Unregistered strictly by Index ID from A-Z
            outOfModuleList.sort((a,b) => a.id.localeCompare(b.id));
            unregList.sort((a,b) => a.id.localeCompare(b.id));

            document.getElementById('scan-stat-total').innerText = totalEntries;
            document.getElementById('scan-stat-dupes').innerText = duplicateCount;
            document.getElementById('scan-stat-valid').innerText = validList.length;
            document.getElementById('scan-stat-oom').innerText = outOfModuleList.length;
            document.getElementById('scan-stat-unreg').innerText = unregList.length;
            document.getElementById('scan-target-course').innerText = fullC;
            document.getElementById('scan-expected-module').innerText = fullC;

            const validBody = document.getElementById('scan-valid-body');
            validBody.innerHTML = "";
            validList.forEach(s => {
                validBody.innerHTML += `<tr><td style="font-family:monospace; font-weight:bold;">${s.id}</td><td>${s.name}</td><td style="text-align:center;"><span class="badge ${s.status==='Valid'?'bg-green':'bg-yellow'}">${s.status}</span></td></tr>`;
            });

            const oomContainer = document.getElementById('scan-out-of-module-container');
            const oomBody = document.getElementById('scan-oom-body');
            oomBody.innerHTML = "";
            if(outOfModuleList.length > 0) {
                oomContainer.style.display = 'block';
                outOfModuleList.forEach(s => {
                    oomBody.innerHTML += `<tr><td style="width:30px;"><input type="checkbox" class="scan-oom-check" value="${s.id}"></td><td><strong style="font-family:monospace;">${s.id}</strong> - ${s.name} <span class="badge bg-red">Lvl ${s.level}</span></td></tr>`;
                });
            } else { oomContainer.style.display = 'none'; }

            const unregContainer = document.getElementById('scan-unreg-container');
            const unregBody = document.getElementById('scan-unreg-body');
            unregBody.innerHTML = "";
            if(unregList.length > 0) {
                unregContainer.style.display = 'block';
                unregList.forEach(s => {
                    unregBody.innerHTML += `<tr><td style="width:30px;"><input type="checkbox" class="scan-unreg-check" value="${s.id}"></td><td><strong style="font-family:monospace; color:var(--danger)">${s.id}</strong></td></tr>`;
                });
            } else { unregContainer.style.display = 'none'; }

            this.pendingBatch = validList;
            this.scanTargetWeeks = targetWeeks;
            this.scanTargetCourses = targetCourses;
            document.getElementById('qr-modal').style.display = 'none';
            document.getElementById('scan-override-modal').style.display = 'block';
        },
        toggleOOMAll: function(cb) { document.querySelectorAll('.scan-oom-check').forEach(c => c.checked = cb.checked); },
        toggleUnregAll: function(cb) { document.querySelectorAll('.scan-unreg-check').forEach(c => c.checked = cb.checked); },
        
        saveScanOverrides: async function() {
            if(this.tempRawData) {
                for(let c of this.tempRawData.courses) {
                    for(let w of this.tempRawData.weeks) {
                        await this.saveScanLog(c, w, "Paste", this.tempRawData.lines);
                    }
                }
                this.tempRawData = null;
            }

            const checkedOOM = Array.from(document.querySelectorAll('.scan-oom-check:checked')).map(cb => cb.value);
            const checkedUnreg = Array.from(document.querySelectorAll('.scan-unreg-check:checked')).map(cb => cb.value);
            let finalIDs = this.pendingBatch.map(s => s.id).concat(checkedOOM).concat(checkedUnreg);

            let batchAtt = []; let batchStudents = [];

            for(let cleanC of this.scanTargetCourses) {
                const fullC = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === cleanC);
                let lvl = 0; const match = fullC.match(/\d+/); if(match) lvl = Math.floor(parseInt(match[0])/100) * 100;
                for(let id of finalIDs) {
                    let s = this.cache.find(x => x.id === id);
                    if(!s) { 
                        s = {id: id, name: "Unknown", level: lvl, courses: [fullC]}; 
                        batchStudents.push(s); 
                        this.cache.push(s); 
                    } 
                    else if (!s.courses.includes(fullC)) { 
                        s.courses.push(fullC); 
                        if(!batchStudents.find(b=>b.id===s.id)) batchStudents.push(s); 
                    }
                    for(let w of this.scanTargetWeeks) {
                        const key = `${cleanC}_W${w}_${id}`; 
                        batchAtt.push({key, status:'Present', course:cleanC, week:w, id:id}); 
                        this.attMap.set(key, 'Present');
                    }
                }
            }
            if(batchStudents.length > 0) await db.batchPut('students', batchStudents);
            if(batchAtt.length > 0) await db.batchPut('attendance', batchAtt);
            document.getElementById('scan-override-modal').style.display='none'; 
            this.updateContext(); 
            alert(`Success! Marked ${finalIDs.length} students Present.\nRaw Data Saved.`);
        },
        closeModal: function() { document.getElementById('new-student-modal').style.display='none'; this.pending=[]; }, confirmAddStudents: async function() { let batch = []; let lvl=0; const match = this.course.match(/\d+/); if(match) lvl = Math.floor(parseInt(match[0])/100) * 100; const cleanC = this.course.replace(/\s/g, ''); const targetW = this.week; for(let p of this.pending) { const finalName = formatName(p.name); const fullC = sysConfig.attCourses.find(c => c.replace(/\s/g, '') === cleanC); const s = {id:p.id, name: finalName, level:lvl, courses:[fullC]}; await db.put('students', s); this.cache.push(s); const key = `${cleanC}_W${targetW}_${p.id}`; this.attMap.set(key, 'Present'); batch.push({key, status:'Present', course:cleanC, week:targetW, id:p.id}); } if(batch.length) await db.batchPut('attendance', batch); this.closeModal(); this.updateContext(); alert(`${this.pending.length} New students added and marked Present.`); }, downloadReport: function() { const wb = XLSX.utils.book_new(); const curW = dashApp.currentWeek; sysConfig.attCourses.forEach(c => { const cleanC = c.replace(/\s/g,''); const list = this.cache.filter(s => s.courses && s.courses.includes(c)); list.sort((a,b)=>a.id.localeCompare(b.id)); const data = list.map(s => { let r = {"Index ID": s.id, "Name": s.name}; let t = 0; for(let w=1; w<=sysConfig.totalWeeks; w++) { if(w > curW) { r[`Week ${w}`] = ""; } else { const st = this.getAtt(s.id,w,cleanC); r[`Week ${w}`] = (st === 'Present' ? "1" : "0"); if(st==='Present') t++; } } r["Total"] = t + "/" + sysConfig.totalWeeks; return r; }); const ws = XLSX.utils.json_to_sheet(data); ws['!cols'] = [{wch:15}, {wch:30}, ...Array(sysConfig.totalWeeks).fill({wch:5}), {wch:10}]; XLSX.utils.book_append_sheet(wb, ws, c); }); const fn = getDownloadFileName('AttendanceReport'); XLSX.writeFile(wb, fn); }, finalizeRestore: async function() { const checkedCourses = Array.from(document.querySelectorAll('.att-sel-check:checked')).map(c => c.value); const finalBatch = this.pendingBatch.filter(b => checkedCourses.includes(b.course)); if(finalBatch.length > 0) { await db.batchPut('attendance', finalBatch); await this.sync(); this.updateContext(); alert(`Restoration Complete.\n${finalBatch.length} records saved.`); } document.getElementById('att-confirm-modal').style.display='none'; } 
    };
    
    // --- DASHAPP ---
    dashApp = { weeks: [], tasks: {}, openWeeks: {1:true}, currentWeek: 0, init: async function() { this.weeks = Array.from({length: sysConfig.totalWeeks}, (_, i) => i + 1); this.calcTime(); if(this.currentWeek>0 && this.currentWeek<=sysConfig.totalWeeks) { this.openWeeks={}; this.openWeeks[this.currentWeek]=true; } const recs = await db.getAll('tasks'); recs.forEach(r => this.tasks[r.key] = r); this.render(); if(noteApp && noteApp.init) noteApp.init(); if(attApp && attApp.setCurrWeek) attApp.setCurrWeek(this.currentWeek); }, calcTime: function() { const start = new Date(sysConfig.startDate); const diff = Math.floor((new Date() - start)/(1000*60*60*24)); this.currentWeek = diff < 0 ? 0 : Math.floor(diff/7)+1; }, toggleWeek: function(w) { this.openWeeks[w] = !this.openWeeks[w]; this.render(); }, toggleTask: async function(w, c, type) { const key = `w${w}_${c}`; if(!this.tasks[key]) this.tasks[key] = {key, week:w, course:c, notes:false, assign:false}; this.tasks[key][type] = !this.tasks[key][type]; this.render(); await db.put('tasks', this.tasks[key]); }, render: function() { const t = document.getElementById('cd-title'), s = document.getElementById('cd-subtitle'), b = document.getElementById('cd-badge'); const total = sysConfig.totalWeeks; if(this.currentWeek<1) { t.innerText="Semester Starts Soon"; b.innerText="WAITING"; } else if(this.currentWeek>total) { t.innerText="Semester Complete"; b.innerText="DONE"; } else { t.innerText=`Current Week: ${this.currentWeek}`; s.innerText=`${total-this.currentWeek} remaining`; b.innerText=`WEEK ${this.currentWeek}`; } let stats = {}; sysConfig.teachCourses.forEach(c => stats[c]={n:0,a:0}); Object.values(this.tasks).forEach(t => { if(sysConfig.teachCourses.includes(t.course)) { if(t.notes) stats[t.course].n++; if(t.assign) stats[t.course].a++; } }); const grid = document.getElementById('dash-grid'); grid.innerHTML = ''; sysConfig.teachCourses.forEach(c => { grid.innerHTML += `<div class="course-card"><div class="cc-header"><div class="cc-title">${c}</div><div class="cc-avatar">${c.split(' ')[1]||'C'}</div></div><div class="cc-stat"><span style="color:#666">Notes:</span> <strong>${stats[c].n}/${total}</strong></div><div class="cc-stat"><span style="color:#666">Assign:</span> <strong>${stats[c].a}/${total}</strong></div></div>`; }); const sched = document.getElementById('schedule-container'); sched.innerHTML = ''; this.weeks.forEach(w => { const open = this.openWeeks[w], active = (w===this.currentWeek); let rows = ''; sysConfig.teachCourses.forEach(c => { const st = this.tasks[`w${w}_${c}`] || {}; rows += `<tr><td style="font-weight:bold; color:var(--ug-blue)">${c}</td><td><button class="task-btn ${st.notes?'done':''}" onclick="dashApp.toggleTask(${w},'${c}','notes')">${st.notes?'‚úî Notes Given':'‚óã Give Notes'}</button></td><td><button class="task-btn ${st.assign?'done':''}" onclick="dashApp.toggleTask(${w},'${c}','assign')">${st.assign?'‚úî Assign. Given':'‚óã Give Assign.'}</button></td></tr>`; }); 
        const badgeHtml = active ? `<span class="curr-week-badge">CURRENT WEEK</span>` : '';
        const activeHeader = `<div style="display:flex; align-items:center;"><span style="font-weight:bold; font-size:${active?'1.1rem':'1rem'};">${getWeekLabel(w)}</span> ${badgeHtml}</div>`;
        sched.innerHTML += `<div class="week-row ${active?'active-week':''}"><div class="week-row-header" onclick="dashApp.toggleWeek(${w})"><div>${activeHeader}</div><div>${open?'‚ñº':'‚ñ∂'}</div></div><div class="week-content ${open?'open':''}"><table class="task-table"><thead><tr><th>Course</th><th>Notes</th><th>Assignment</th></tr></thead><tbody>${rows}</tbody></table></div></div>`; }); } };
    
    // --- DB VIEW ---
   dbView = { 
        allStudents: [], filterLvl: 0, filterCourse: "", pendingRows: [], sortCol: 'name', sortAsc: true, isDeleteMode: false, selected: new Set(), 
        init: async function() { this.allStudents = await db.getAll('students'); this.calcStats(); this.render(); }, 
        calcStats: function() { 
            document.getElementById('stat-total').innerText = this.allStudents.length; 
            [100,200,300,400].forEach(l => { document.getElementById(`stat-${l}`).innerText = this.allStudents.filter(s=>s.level===l).length; }); 
            const container = document.getElementById('db-filter-container');
            let html = `<button class="db-pill ${this.filterLvl===0 && !this.filterCourse ? 'active':''}" onclick="dbView.filter(0, '')">All (${this.allStudents.length})</button>`;
            [100,200,300,400].forEach(l => {
                let count = this.allStudents.filter(s=>s.level===l).length;
                html += `<button class="db-pill ${this.filterLvl===l ? 'active':''}" onclick="dbView.filter(${l}, '')">Level ${l} (${count})</button>`;
            });
            sysConfig.attCourses.forEach(c => {
                let count = this.allStudents.filter(s => s.courses && s.courses.includes(c)).length;
                html += `<button class="db-pill ${this.filterCourse===c ? 'active':''}" onclick="dbView.filter(0, '${c}')">${c} (${count})</button>`;
            });
            html += `<div style="margin-left:auto; display:flex; gap:10px;"><button class="btn btn-blue" onclick="dbView.openExportModal()">‚§ì Export Data</button><button class="btn btn-danger" onclick="dbView.toggleDeleteMode()">Manage / Delete</button><button class="btn btn-gold" onclick="dbView.openImportModal()">+ Import</button></div>`;
            container.innerHTML = html;
        }, 
        filter: function(lvl, course) { this.filterLvl = lvl; this.filterCourse = course; this.calcStats(); this.render(); }, 
        search: function(val) { this.render(val); }, 
        sort: function(col) { if(this.sortCol===col) this.sortAsc=!this.sortAsc; else {this.sortCol=col;this.sortAsc=true;} this.render(document.querySelector('#view-database input').value); }, 
        toggleDeleteMode: function() { this.isDeleteMode = !this.isDeleteMode; this.selected.clear(); document.getElementById('db-delete-toolbar').style.display = this.isDeleteMode ? 'flex' : 'none'; document.getElementById('th-check').style.display = this.isDeleteMode ? 'table-cell' : 'none'; this.render(document.querySelector('#view-database input').value); }, 
        toggleSelect: function(id) { if(this.selected.has(id)) this.selected.delete(id); else this.selected.add(id); }, 
        toggleSelectAll: function(cb) { const visible = this.getVisibleStudents(); if(cb.checked) visible.forEach(s => this.selected.add(s.id)); else visible.forEach(s => this.selected.delete(s.id)); this.render(document.querySelector('#view-database input').value); }, 
        deleteSelected: async function() { if(this.selected.size === 0) return alert("No students selected."); if(confirm(`Delete ${this.selected.size} selected students?`)) { await db.batchDel('students', Array.from(this.selected)); await attApp.sync(); this.allStudents = await db.getAll('students'); this.toggleDeleteMode(); this.calcStats(); alert("Deleted."); } }, 
        deleteAllInLevel: async function() { const target = this.filterCourse ? this.filterCourse : (this.filterLvl === 0 ? "ALL LEVELS" : `LEVEL ${this.filterLvl}`); if(confirm(`WARNING: DELETE ALL students in ${target}?`)) { const toDelete = this.getVisibleStudents().map(s => s.id); if(toDelete.length === 0) return alert("No students to delete."); await db.batchDel('students', toDelete); await attApp.sync(); this.allStudents = await db.getAll('students'); this.toggleDeleteMode(); this.calcStats(); alert("Deletion Complete."); } }, 
        getVisibleStudents: function(searchVal = "") { 
            const search = (searchVal || "").toLowerCase(); 
            return this.allStudents.filter(s => {
                let matchLvl = this.filterLvl === 0 || s.level === this.filterLvl;
                let matchCourse = !this.filterCourse || (s.courses && s.courses.includes(this.filterCourse));
                let matchSearch = s.name.toLowerCase().includes(search) || s.id.includes(search);
                return matchLvl && matchCourse && matchSearch;
            }); 
        }, 
        render: function(searchVal = "") { 
            ['id','name'].forEach(c => { const el = document.getElementById(`sort-icon-db-${c}`); el.className = 'sort-arrow ' + (this.sortCol === c ? (this.sortAsc ? 'sort-asc' : 'sort-desc') : 'sort-none'); }); 
            const tbody = document.getElementById('db-table-body'); 
            let list = this.getVisibleStudents(searchVal); 
            list.sort((a,b) => { let vA=a[this.sortCol], vB=b[this.sortCol]; if(vA<vB) return this.sortAsc?-1:1; if(vA>vB) return this.sortAsc?1:-1; return 0; }); 
            if(list.length === 0) { tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px; color:#999'>No students found.</td></tr>"; return; } 
            const rows = list.map((s, i) => { 
                const check = this.isDeleteMode ? `<td><input type="checkbox" ${this.selected.has(s.id)?'checked':''} onchange="dbView.toggleSelect('${s.id}')"></td>` : ''; 
                return `<tr>${check}<td>${i+1}</td><td style='font-family:monospace; font-weight:bold; color:var(--ug-blue)'>${s.id}</td><td class="clickable-name" onclick="editNameApp.open('${s.id}', '${s.name}')">${s.name}</td><td>${s.level}</td></tr>`; 
            }).join('');
            tbody.innerHTML = rows;
        }, 
        openExportModal: function() { document.getElementById('db-export-modal').style.display='block'; }, executeExport: function() { const options = Array.from(document.querySelectorAll('input[name="exp-opt"]:checked')).map(cb => parseInt(cb.value)); if(options.length === 0) return alert("Please select at least one level."); const wb = XLSX.utils.book_new(); options.forEach(lvl => { const data = this.allStudents.filter(s => s.level === lvl).map(s => ({"Index ID":s.id, "Name":s.name, "Level":s.level})); if(data.length) { const ws = XLSX.utils.json_to_sheet(data); ws['!cols'] = [{wch:15}, {wch:30}, {wch:10}]; XLSX.utils.book_append_sheet(wb, ws, `Level ${lvl}`); } }); if(wb.SheetNames.length === 0) return alert("No data found for selected levels."); const fn = getDownloadFileName('StudentDatabase'); XLSX.writeFile(wb, fn); document.getElementById('db-export-modal').style.display='none'; },updateImportCourses: function() {
            const lvl = document.getElementById('imp-level-select').value;
            const lvlPrefix = lvl.substring(0, 1);
            const container = document.getElementById('imp-course-select');
            container.innerHTML = '<option value="">-- None (Level Only) --</option>';
            sysConfig.attCourses.forEach(c => {
                const match = c.match(/\d+/);
                if (match && match[0].startsWith(lvlPrefix)) {
                    container.innerHTML += `<option value="${c}">${c}</option>`;
                }
            });
        },
        openImportModal: function() { 
            document.getElementById('db-import-modal').style.display='block'; 
            document.getElementById('db-step-1').style.display='block'; 
            document.getElementById('db-step-2').style.display='none'; 
            document.getElementById('db-paste-area').value=''; 
            document.getElementById('imp-level-select').value = "200"; 
            this.updateImportCourses();
        }, 
        closeImportModal: function() { document.getElementById('db-import-modal').style.display='none'; }, 
        resetFile: function() { document.getElementById('db-import-file').value = ''; alert("File selection cleared. You can now use the Paste option."); }, 
        previewImport: function() { 
            const lvl = parseInt(document.getElementById('imp-level-select').value);
            const course = document.getElementById('imp-course-select').value;
            const fileInput = document.getElementById('db-import-file'); 
            
            if(fileInput.files.length > 0) { 
                const file = fileInput.files[0];
                const ext = file.name.split('.').pop().toLowerCase();
                
                if (ext === 'pdf' || ext.startsWith('doc')) {
                    alert("For Word or PDF files, please open them, copy the text, and paste it into the 'Paste List' box.");
                    fileInput.value = '';
                    return;
                }
                
                if (ext === 'txt') {
                    const reader = new FileReader();
                    reader.onload = e => { this.processSingleImportData(e.target.result, lvl, course); };
                    reader.readAsText(file);
                    return;
                }

                const r = new FileReader(); 
                r.onload = e => { 
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'}); 
                        this.processImportWorkbook(wb, lvl, course); 
                    } catch (err) {
                        alert("Error reading file. Please use a valid Excel (.xls, .xlsx) or CSV file.");
                    }
                }; 
                r.readAsArrayBuffer(file); 
            } else { 
                const txt = document.getElementById('db-paste-area').value; 
                this.processSingleImportData(txt, lvl, course); 
            } 
        }, 
        processImportWorkbook: async function(wb, lvl, course) { 
            let rows = []; 
            wb.SheetNames.forEach(sheetName => { 
                const sheetData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header:1}); 
                const txt = sheetData.map(r=>r.join("\t")).join("\n"); 
                rows = rows.concat(this.parseRawData(txt, lvl, course)); 
            }); 
            if(rows.length === 0) return alert("No valid data found in workbook."); 
            this.closeImportModal(); this.showLevelSelector(rows, lvl, course); 
        }, 
        processSingleImportData: function(txt, lvl, course) { 
            const rows = this.parseRawData(txt, lvl, course); 
            this.closeImportModal(); this.showLevelSelector(rows, lvl, course); 
        }, 
        parseRawData: function(txt, lvl, course) { 
            let parsed = []; 
            const lines = txt.split(/[\r\n]+/); 
            lines.forEach(l => { 
                const match = l.match(/(\d+)\s+(.*)/); 
                if(match) { 
                    const id = match[1].trim(); 
                    const name = formatName(match[2]); 
                    if(id.length >= 4) { parsed.push({id, name, level:lvl, courses: course ? [course] : []}); } 
                } 
            }); 
            return parsed; 
        }, 
        showLevelSelector: function(rows, lvl, course) { 
            this.pendingRows = rows; 
            const targetText = course ? `${course} (Level ${lvl})` : `Level ${lvl} (No Module)`;
            let html = `<div class="confirm-row"><label><input type="checkbox" class="db-sel-check" data-lvl="${lvl}" value="${course}" checked> <span><strong>${targetText}</strong> (${rows.length} students)</span></label></div>`; 
            document.getElementById('db-select-list').innerHTML = html; document.getElementById('db-confirm-modal').style.display = 'block'; 
        }, 
        finalizeImport: async function() { 
            const chk = document.querySelector('.db-sel-check');
            const course = chk.value; 
            const lvl = parseInt(chk.dataset.lvl);
            document.getElementById('db-confirm-modal').style.display = 'none'; 
            let importCount = 0; let batch = [];
            for (let r of this.pendingRows) {
                let existing = this.allStudents.find(s => s.id === r.id);
                if (existing) {
                    if (course && !existing.courses.includes(course)) {
                        existing.courses.push(course); batch.push(existing); importCount++;
                    }
                } else {
                    batch.push(r); this.allStudents.push(r); importCount++;
                }
            }
            if(batch.length > 0) { 
                await db.batchPut('students', batch); 
                await attApp.sync(); 
                this.allStudents = await db.getAll('students'); 
                this.calcStats(); this.render(); 
            } 
            document.getElementById('import-new-stat').innerText = importCount; 
            document.getElementById('db-import-modal').style.display='block'; 
            document.getElementById('db-step-1').style.display='none'; 
            document.getElementById('db-step-2').style.display='flex'; 
        }
    };

    // --- CHISAG APP ---
    chisagApp = { members: [], currentImg: '', isManageMode: false, selected: new Set(), sortCol: 'id', sortAsc: true, filterLvl: 0, init: async function() { const dSel = document.getElementById('c-mod-dob-day'); if(dSel.options.length === 1) { for(let i=1; i<=31; i++) { const opt = document.createElement('option'); opt.value = i < 10 ? '0'+i : i; opt.text = i; dSel.appendChild(opt); } } this.members = await db.getAll('chisag_members'); this.render(); }, toggleManageMode: function() { this.isManageMode = !this.isManageMode; this.selected.clear(); document.getElementById('chisag-delete-controls').style.display = this.isManageMode ? 'block' : 'none'; document.getElementById('chisag-th-check').style.display = this.isManageMode ? 'table-cell' : 'none'; this.render(); }, toggleSelect: function(id) { if(this.selected.has(id)) this.selected.delete(id); else this.selected.add(id); }, toggleSelectAll: function(cb) { if(cb.checked) this.members.forEach(m => this.selected.add(m.id)); else this.selected.clear(); this.render(); }, deleteSelected: async function() { if(this.selected.size === 0) return alert("No members selected."); if(confirm(`Delete ${this.selected.size} selected members?`)) { await db.batchDel('chisag_members', Array.from(this.selected)); this.members = await db.getAll('chisag_members'); this.toggleManageMode(); this.render(); alert("Members Deleted."); } }, filterByLevel: function(lvl) { this.filterLvl = lvl; this.render(); }, sort: function(col) { if(this.sortCol===col) this.sortAsc = !this.sortAsc; else { this.sortCol = col; this.sortAsc = true; } this.render(); }, lookup: async function() { const id = document.getElementById('chisag-input-id').value.trim(); if(!id) return alert("Please enter an ID."); this.currentImg = ''; let member = this.members.find(m => m.id === id); if (!member) { const student = await db.get('students', id); if (student) { const names = student.name.split(' '); const surname = names[0]; const other = names.slice(1).join(' '); member = { id: student.id, surname: surname, otherNames: other, level: student.level, dob: '', email: '', dues: false, souvPaid: false, souvTaken: false, pic: '' }; } else { member = { id: id, surname: '', otherNames: '', level: 100, dob: '', email: '', dues: false, souvPaid: false, souvTaken: false, pic: '' }; } } document.getElementById('c-mod-id').value = member.id; document.getElementById('c-mod-surname').value = member.surname; document.getElementById('c-mod-othernames').value = member.otherNames; document.getElementById('c-mod-level').value = member.level || 100; const dobParts = (member.dob || "").split('-'); if(dobParts.length === 2) { document.getElementById('c-mod-dob-day').value = dobParts[0]; document.getElementById('c-mod-dob-month').value = dobParts[1]; } else { document.getElementById('c-mod-dob-day').value = ""; document.getElementById('c-mod-dob-month').value = ""; } document.getElementById('c-mod-email').value = member.email || ''; document.getElementById('c-mod-dues').checked = member.dues; document.getElementById('c-mod-souv-paid').checked = member.souvPaid; document.getElementById('c-mod-souv-taken').checked = member.souvTaken; this.currentImg = member.pic || ''; this.updateImagePreview(); document.getElementById('chisag-member-modal').style.display = 'block'; }, handleImageUpload: function(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { this.currentImg = e.target.result; this.updateImagePreview(); }; reader.readAsDataURL(file); }, updateImagePreview: function() { const div = document.getElementById('c-img-preview'); if(this.currentImg) div.innerHTML = `<img src="${this.currentImg}" style="width:100%; height:100%; object-fit:cover;">`; else div.innerHTML = `<span style="color:#999; font-size:3rem;">üì∑</span>`; }, saveMember: async function() { const id = document.getElementById('c-mod-id').value; const surname = document.getElementById('c-mod-surname').value; const other = document.getElementById('c-mod-othernames').value; const d = document.getElementById('c-mod-dob-day').value; const m = document.getElementById('c-mod-dob-month').value; const dobStr = (d && m) ? `${d}-${m}` : ""; if(!surname) return alert("Surname is required"); const member = { id: id, surname: surname, otherNames: other, name: surname + " " + other, level: parseInt(document.getElementById('c-mod-level').value), dob: dobStr, email: document.getElementById('c-mod-email').value, dues: document.getElementById('c-mod-dues').checked, souvPaid: document.getElementById('c-mod-souv-paid').checked, souvTaken: document.getElementById('c-mod-souv-taken').checked, pic: this.currentImg }; await db.put('chisag_members', member); this.members = await db.getAll('chisag_members'); document.getElementById('chisag-member-modal').style.display = 'none'; document.getElementById('chisag-input-id').value = ''; this.render(); alert("Member Saved."); }, deleteMember: async function() { const id = document.getElementById('c-mod-id').value; if(confirm("Delete this member from CHISAG system?")) { await db.delete('chisag_members', id); this.members = await db.getAll('chisag_members'); document.getElementById('chisag-member-modal').style.display = 'none'; this.render(); } }, showPictureModal: function(imgSrc) { const modal = document.getElementById('picture-modal'); const img = document.getElementById('picture-modal-img'); img.src = imgSrc; modal.style.display = 'block'; }, showQR: function(id, name, level, pic) { document.getElementById('chisag-qr-modal').style.display = 'block'; document.getElementById('qr-name-display').innerText = name; document.getElementById('qr-id-display').innerText = id; document.getElementById('qr-level-display').innerText = "LEVEL " + level; const photoBox = document.getElementById('qr-card-photo'); if(pic) photoBox.innerHTML = `<img src="${pic}" class="id-card-photo">`; else photoBox.innerHTML = `<span style="color:#ccc; font-size:3rem;">üë§</span>`; document.getElementById('qr-display-area').innerHTML = ""; new QRCode(document.getElementById("qr-display-area"), { text: id, width: 100, height: 100 }); }, downloadPDF: async function() { const element = document.getElementById('printable-id-card'); const qrBox = document.getElementById('qr-display-area'); const canvas = qrBox.querySelector('canvas'); if(canvas) { const img = new Image(); img.src = canvas.toDataURL("image/png"); img.style.width = "100%"; img.style.height = "auto"; qrBox.innerHTML = ""; qrBox.appendChild(img); } await new Promise(resolve => setTimeout(resolve, 500)); html2canvas(element, { scale: 3, useCORS: true }).then(canvas => { const imgData = canvas.toDataURL('image/jpeg', 1.0); const { jsPDF } = window.jspdf; const pdf = new jsPDF('p', 'mm', 'a4'); const imgProps = pdf.getImageProperties(imgData); const cardWidth = 85; const cardHeight = (imgProps.height * cardWidth) / imgProps.width; const x = (210 - cardWidth) / 2; const y = (297 - cardHeight) / 2 - 20; pdf.addImage(imgData, 'JPEG', x, y, cardWidth, cardHeight); pdf.save(`ID_Card_${document.getElementById('qr-id-display').innerText}.pdf`); }); }, render: function() { document.getElementById('chisag-total-count').innerText = this.members.length; document.getElementById('chisag-paid-count').innerText = this.members.filter(m=>m.dues).length + " Paid"; [100,200,300,400].forEach(l => { document.getElementById(`chisag-lvl-${l}`).innerText = this.members.filter(m => m.level === l).length; }); const today = new Date(); const currentMonth = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][today.getMonth()]; const bdays = this.members.filter(m => m.dob && m.dob.includes(currentMonth)); const bdayList = document.getElementById('chisag-bday-list'); bdayList.innerHTML = ""; bdays.sort((a,b) => parseInt(a.dob) - parseInt(b.dob)); bdays.forEach(m => { bdayList.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee;"><strong>${m.dob}:</strong> ${m.surname} ${m.otherNames}</div>`; }); if(bdays.length === 0) bdayList.innerHTML = "No birthdays this month."; const searchVal = document.getElementById('chisag-search-filter').value.toLowerCase(); let list = this.members; if(this.filterLvl > 0) list = list.filter(m => m.level === this.filterLvl); const col = this.sortCol; const asc = this.sortAsc; list.sort((a,b) => { let vA = a[col], vB = b[col]; if(col === 'dues' || col === 'souvPaid' || col === 'souvTaken') { vA = vA.toString(); vB = vB.toString(); } if(vA < vB) return asc ? -1 : 1; if(vA > vB) return asc ? 1 : -1; return 0; }); const tbody = document.getElementById('chisag-table-body'); const rows = list.map((m, i) => { const fullName = (m.surname + " " + m.otherNames).toLowerCase(); if(searchVal && !fullName.includes(searchVal) && !m.id.includes(searchVal)) return ''; const picHtml = m.pic ? `<img src="${m.pic}" class="pic-thumbnail" onclick="chisagApp.showPictureModal('${m.pic}')">` : '<span style="font-size:1.5rem; color:#ccc;">üë§</span>'; const checkHtml = this.isManageMode ? `<td><input type="checkbox" ${this.selected.has(m.id)?'checked':''} onchange="chisagApp.toggleSelect('${m.id}')"></td>` : ''; return `<tr> ${checkHtml} <td>${i+1}</td> <td style="text-align:center;">${picHtml}</td> <td style="font-weight:bold; font-family:monospace; color:var(--ug-blue);">${m.id}</td> <td>${m.surname}</td> <td>${m.otherNames}</td> <td>${m.level}</td> <td><span class="badge ${m.dues?'bg-green':'bg-red'}">${m.dues?'PAID':'OWING'}</span></td> <td><span class="badge ${m.souvPaid?'bg-green':'bg-yellow'}">${m.souvPaid?'YES':'NO'}</span></td> <td><span class="badge ${m.souvTaken?'bg-green':'bg-yellow'}">${m.souvTaken?'YES':'NO'}</span></td> <td> <button class="btn btn-gold" style="padding:2px 8px; font-size:0.75rem;" onclick="chisagApp.showQR('${m.id}','${m.surname} ${m.otherNames}', ${m.level}, '${m.pic}')">QR ID</button> <button class="btn btn-reset" style="padding:2px 8px; font-size:0.75rem;" onclick="document.getElementById('chisag-input-id').value='${m.id}'; chisagApp.lookup()">Edit</button> </td> </tr>`; }).join(''); tbody.innerHTML = rows; }, importFile: function(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.readAsArrayBuffer(file); reader.onload = async (e) => { const buffer = e.target.result; const workbook = new ExcelJS.Workbook(); await workbook.xlsx.load(buffer); const worksheet = workbook.getWorksheet(1); const bufToBase64 = (buf) => { let binary = ''; const bytes = new Uint8Array(buf); for (let i = 0; i < bytes.byteLength; i++) { binary += String.fromCharCode(bytes[i]); } return window.btoa(binary); }; const images = {}; worksheet.getImages().forEach(image => { const imgId = image.imageId; const img = workbook.model.media.find(m => m.index === imgId); const row = Math.floor(image.range.tl.nativeRow) + 1; if (img) { images[row] = `data:${img.type};base64,${bufToBase64(img.buffer)}`; } }); let count = 0; worksheet.eachRow((row, rowNumber) => { if (rowNumber === 1) return; const idVal = row.getCell(3).value; if (!idVal) return; const member = { id: String(idVal).trim(), surname: String(row.getCell(4).value || '').toUpperCase(), otherNames: String(row.getCell(5).value || '').toUpperCase(), level: parseInt(row.getCell(6).value) || 100, dob: String(row.getCell(7).value || ''), dues: String(row.getCell(8).value || '').toLowerCase().includes('paid') || String(row.getCell(8).value || '').toLowerCase() === 'yes', souvPaid: String(row.getCell(9).value || '').toLowerCase() === 'yes', souvTaken: String(row.getCell(10).value || '').toLowerCase() === 'yes', email: (row.getCell(11).value && row.getCell(11).value.text) ? row.getCell(11).value.text : String(row.getCell(11).value || ''), pic: images[rowNumber] || '' }; this.members = this.members.filter(m => m.id !== member.id); this.members.push(member); count++; }); await db.batchPut('chisag_members', this.members); this.render(); alert(`Imported ${count} members with pictures.`); input.value = ''; }; }, exportFile: async function() { const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('CHISAG Members'); ws.columns = [ { header: 'No.', key: 'no', width: 5 }, { header: 'Picture', key: 'pic', width: 15 }, { header: 'Index ID', key: 'id', width: 15 }, { header: 'Surname', key: 'surname', width: 20 }, { header: 'Other Names', key: 'other', width: 25 }, { header: 'Level', key: 'level', width: 10 }, { header: 'DOB', key: 'dob', width: 15 }, { header: 'Dues', key: 'dues', width: 10 }, { header: 'Souv Paid', key: 'sp', width: 10 }, { header: 'Souv Taken', key: 'st', width: 10 }, { header: 'Email', key: 'email', width: 30 } ]; this.members.forEach((m, i) => { const row = ws.addRow({ no: i+1, pic: '', id: m.id, surname: m.surname, other: m.otherNames, level: m.level, dob: m.dob, dues: m.dues ? "Paid" : "Owing", sp: m.souvPaid ? "Yes" : "No", st: m.souvTaken ? "Yes" : "No", email: m.email }); row.height = 60; if (m.pic) { const imageId = wb.addImage({ base64: m.pic, extension: 'png', }); ws.addImage(imageId, { tl: { col: 1, row: i + 1 }, br: { col: 2, row: i + 2 }, editAs: 'oneCell' }); } }); const buf = await wb.xlsx.writeBuffer(); saveAs(new Blob([buf]), 'CHISAG_Roster_Export.xlsx'); } };

    window.onload = async function() { 
        await db.open(); 
        authApp.init(); 
        
        // Inject the hidden TA Portal code directly into the iframe
        const taCode = document.getElementById('ta-portal-code').innerHTML;
        document.getElementById('ta-iframe').srcdoc = taCode;
    };
</script>

<template id="ta-portal-code">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Section Tutorial Portal</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #002147; --primary-light: #003366; 
            --accent: #D4AF37; --accent-light: #F2C94C;
            --bg: #f0f2f5; --white: #ffffff; 
            --text: #1f2937; --muted: #6b7280;
            --border: #cbd5e1; --success: #10b981; --danger: #ef4444;
            --shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', 'Roboto', sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 40px; font-size: 0.95rem; }
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .gap-10 { gap: 8px; }
        .w-full { width: 100%; }
        .uppercase { text-transform: uppercase; }
        
        /* UI Elements */
        .btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; justify-content: center; box-shadow: var(--shadow); }
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        .btn-gold { background: var(--accent); color: var(--primary); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-light { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-success { background: var(--success); color: white; }
        
        .input-std { padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; width: 100%; font-size: 0.95rem; }
        .input-std:focus { border-color: var(--primary); }
        
        /* Navbar */
        .navbar { background: var(--primary); height: 60px; padding: 0 20px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .nav-brand { color: white; font-size: 1.1rem; font-weight: 800; display: flex; flex-direction: column; line-height: 1.1; }
        .nav-role { font-size: 0.7rem; color: var(--accent); font-weight: normal; letter-spacing: 0.5px; }
        .nav-menu { display: flex; gap: 10px; height: 100%; align-items: center; }
        .nav-item { background: transparent; border: none; color: rgba(255,255,255,0.8); height: 100%; padding: 0 12px; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: 0.2s; font-size: 0.9rem; }
        .nav-item.active, .nav-item:hover { color: white; border-bottom-color: var(--accent); background: rgba(255,255,255,0.05); }

        .menu-wrapper { position: relative; height: 100%; display: flex; align-items: center; cursor: pointer; }
        .menu-dropdown { display: none; position: absolute; top: 100%; right: 0; background: white; width: 220px; border-radius: 0 0 6px 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 2000; border: 1px solid #ddd; border-top: none; }
        .menu-wrapper:hover .menu-dropdown, .menu-dropdown:hover { display: block; }
        .menu-btn { width: 100%; text-align: left; padding: 10px 15px; border: none; background: white; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .menu-btn:hover { background: #f8fafc; padding-left: 20px; color: var(--primary); }
        
        .container { max-width: 1400px; margin: 20px auto; padding: 0 15px; display: none; }
        .container.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Dashboard & Layout */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .dash-card { background: white; padding: 15px 20px; border-radius: 8px; border-left: 4px solid var(--accent); box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .dash-card h3 { margin: 0 0 10px 0; color: var(--primary); font-size: 1.2rem; }
        .dash-card::after { content: ''; position: absolute; top:0; right:0; width: 80px; height: 100%; background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.05)); }
        .stat-line { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #475569; }
        
        /* Accordions */
        .task-card { background: white; border-radius: 8px; margin-bottom: 10px; overflow: hidden; box-shadow: var(--shadow); border: 1px solid #e2e8f0; }
        .task-header { padding: 12px 15px; background: white; cursor: pointer; font-weight: 700; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; color: var(--text); }
        .task-header:hover { background: #f8fafc; }
        .task-header.current-week { background: linear-gradient(135deg, var(--primary) 0%, #004080 100%); color: white; border-left: 6px solid var(--accent); }
        .current-week-badge { background: var(--accent); color: var(--primary); font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; margin-left: 15px; font-weight: 900; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .task-body { display: none; padding: 15px; background: #fdfdfd; border-top: 1px solid #eee; }
        .task-body.open { display: block; }
        .task-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #edf2f7; }
        
        /* Tables */
        .control-bar { background: white; padding: 15px; border-radius: 8px; box-shadow: var(--shadow); display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 15px; }
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 8px; overflow: hidden; box-shadow: var(--shadow); }
        .data-table th { background: var(--primary); color: white; padding: 10px 8px; text-align: left; font-weight: 600; border-bottom: 3px solid var(--accent); vertical-align: middle; }
        .data-table td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #334155; }
        .data-table tr:hover td { background: #f8fafc; }
        
        /* Gradebook Specifics */
        .grade-input { width: 60px; text-align: center; font-weight: bold; padding: 6px; font-size: 0.9rem; }
        .gb-header-content { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; white-space: normal; text-align: center; line-height: 1.2; max-width: 140px; margin: 0 auto; }
        .gb-sort-controls { display: flex; gap: 4px; margin-top: 6px; justify-content: center; }
        .gb-sort-btn { background: rgba(255,255,255,0.2); border: none; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; cursor: pointer; }
        .gb-sort-btn:hover { background: white; color: var(--primary); }

        /* Attendance Specifics */
        .att-input-large { font-size: 1rem; padding: 10px; width: 100%; border: 2px solid #cbd5e1; border-radius: 6px; }
        .att-week-select { font-size: 1rem; padding: 8px; font-weight: bold; color: var(--primary); border: 2px solid var(--border); border-radius: 6px; }
        .att-week-badge { background: var(--accent); color: var(--primary); padding: 6px 15px; border-radius: 20px; font-weight: 900; box-shadow: var(--shadow); font-size: 0.9rem; letter-spacing: 0.5px; text-transform: uppercase; }
        .status-btn { padding: 6px 12px; border-radius: 4px; border: 1px solid #cbd5e1; background: #f8fafc; cursor: pointer; font-size: 0.85rem; font-weight: bold; margin-right: 4px; color: #94a3b8; transition: 0.2s; min-width: 35px; }
        .status-btn:hover { background: #e2e8f0; }
        .status-btn.p-active { background: var(--success); color: white; border-color: var(--success); }
        .status-btn.a-active { background: var(--danger); color: white; border-color: var(--danger); }

        /* Modals & Login */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,20,40,0.7); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 600px; max-width: 90%; max-height: 90vh; overflow-y: auto; padding: 25px; border-radius: 12px; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #94a3b8; }
        
        .admin-banner { background: #1f2937; color: white; text-align: center; padding: 5px; font-weight: bold; font-size: 0.8rem; letter-spacing: 1px; }
        .view-only { background: var(--danger); }
        .manager-mode { background: #d97706; }
        .reset-file-btn { color: var(--danger); border: 1px solid var(--danger); background: white; padding: 5px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
        
        /* Import Preview */
        .preview-row { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; margin-bottom: 10px; border-radius: 8px; display: flex; gap: 15px; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .preview-lbl { font-size: 0.9rem; font-weight: bold; color: var(--primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* Manage Grid */
        .manage-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .manage-card { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .manage-info h4 { margin: 0 0 5px 0; color: var(--primary); }
        .manage-info p { margin: 0; font-size: 0.85rem; color: #666; }
    </style>
</head>
<body>

    <div id="app-ui">
        <div id="admin-banner" class="admin-banner" style="display:block;">ADMINISTRATOR MODE</div>

        <nav class="navbar">
            <div class="nav-brand"><span id="sys-user-display">TA PORTAL</span><span class="nav-role" id="sys-role-display"></span></div>
            <div class="nav-menu">
                <button id="nav-dash" class="nav-item active" onclick="APP.nav.go('dashboard')"><i class="fas fa-home"></i> Dashboard</button>
                <button id="nav-att" class="nav-item" onclick="APP.nav.go('attendance')"><i class="fas fa-check-square"></i> Attendance</button>
                <button id="nav-db" class="nav-item" onclick="APP.nav.go('database')"><i class="fas fa-users"></i> Students</button>
                <button id="nav-grade" class="nav-item" onclick="APP.nav.go('grades')"><i class="fas fa-chart-bar"></i> Gradebook</button>
                <button id="nav-admin-back" class="btn btn-light hidden" onclick="APP.nav.go('admin')"><i class="fas fa-arrow-left"></i> Console</button>
                <div class="menu-wrapper" id="nav-menu-btn">
                    <button class="btn btn-gold">Menu <i class="fas fa-caret-down"></i></button>
                    <div class="menu-dropdown">
                        <button class="menu-btn restricted" onclick="APP.setup.open(true)">Edit System Layout</button>
                        <button class="menu-btn" onclick="APP.backup.open()">Backup / Restore</button>
                        <button class="menu-btn restricted" onclick="APP.setup.archiveSemester()">Archive Semester</button>
                        <button class="menu-btn restricted" style="color:red;" onclick="APP.setup.newSystem()">Create New Semester</button>
                    </div>
                </div>
            </div>
        </nav>

        <div id="view-dashboard" class="container active">
            <h2 style="color:var(--primary); border-bottom:3px solid var(--accent); display:inline-block; padding-bottom:4px; margin-bottom: 20px;">DASHBOARD</h2>
            <div id="dash-grid" class="dash-grid"></div>
            <h3 style="color:var(--muted); margin-top:30px; margin-bottom: 15px; font-weight: 600;">ASSIGNMENT TRACKER</h3>
            <div id="dash-tasks"></div>
        </div>

        <div id="view-attendance" class="container">
            <div class="flex-between">
                <h2 style="color:var(--primary);">ATTENDANCE</h2>
                <div id="att-week-badge" class="att-week-badge"></div>
            </div>
            <div class="control-bar">
                <div class="flex gap-10" style="flex: 1;">
                    <select id="att-course" class="att-week-select" style="min-width:180px;" onchange="APP.attendance.update()"></select>
                    <select id="att-week" class="att-week-select" style="min-width:120px;" onchange="APP.attendance.update()"></select>
                    <div id="att-date-display" style="font-weight:bold; color:var(--muted); margin-left: 10px;"></div>
                </div>
                <div class="flex gap-10" style="width: 100%; margin-top: 10px;">
                    <input type="text" id="att-manual" class="att-input-large" placeholder="Enter ID or Name to manually mark attendance for the current week" onkeyup="if(event.key==='Enter') APP.attendance.manualAdd()">
                    <button class="btn btn-success" style="padding: 10px 20px;" onclick="APP.attendance.manualAdd()">MARK PRESENT</button>
                </div>
                <div class="flex gap-10" style="width: 100%; justify-content: flex-end; margin-top: 10px;">
                    <button class="btn btn-gold" onclick="APP.import.open('attendance')"><i class="fas fa-file-import"></i> Import</button>
                    <button class="btn btn-primary" onclick="APP.export.open('attendance')"><i class="fas fa-file-download"></i> Download</button>
                </div>
            </div>
            <div id="att-future-warning" style="background:#fff3cd; color:#856404; padding:20px; text-align:center; border-radius:8px; display:none; border: 1px solid #ffeeba;">
                <i class="fas fa-clock fa-2x"></i><br><br>This class date has not arrived yet. Attendance is locked.
            </div>
            <div id="att-content">
                <div class="flex-between" style="margin-bottom:10px;">
                    <div id="att-headcount" style="font-weight:bold; color:var(--primary); font-size:1.1rem;"></div>
                    <div><input type="text" id="att-search" placeholder="Filter List (Name/ID)..." class="input-std" style="width:220px;" onkeyup="APP.attendance.render()"></div>
                </div>
                <table class="data-table">
                    <thead><tr><th width="50">No.</th><th onclick="APP.utils.sort('att','id')">ID <i class="fas fa-sort"></i></th><th onclick="APP.utils.sort('att','name')">Name <i class="fas fa-sort"></i></th><th>Status</th><th onclick="APP.utils.sort('att','total')">Total Present <i class="fas fa-sort"></i></th></tr></thead>
                    <tbody id="att-tbody"></tbody>
                </table>
            </div>
        </div>

        <div id="view-database" class="container">
            <h2 style="color:var(--primary);">STUDENT DATABASE</h2>
            <div id="db-pills" class="flex gap-10" style="margin-bottom:15px; flex-wrap:wrap;"></div>
            <div class="control-bar" style="justify-content: space-between;">
                <input type="text" id="db-search" placeholder="Search Database..." class="input-std" style="width:300px;" onkeyup="APP.dbView.render()">
                <div class="flex gap-10">
                    <button class="btn btn-gold" onclick="APP.import.open('students')">Import</button>
                    <button class="btn btn-primary" onclick="APP.export.open('students')">Export</button>
                    <button class="btn btn-danger restricted" onclick="APP.dbView.deleteSelected()">Delete Selected</button>
                </div>
            </div>
            <table class="data-table">
                <thead><tr><th width="40"><input type="checkbox" onchange="APP.dbView.toggleAll(this)"></th><th width="50">No.</th><th onclick="APP.utils.sort('db','id')">ID <i class="fas fa-sort"></i></th><th onclick="APP.utils.sort('db','name')">Name <i class="fas fa-sort"></i></th><th onclick="APP.utils.sort('db','grp')">Group <i class="fas fa-sort"></i></th></tr></thead>
                <tbody id="db-tbody"></tbody>
            </table>
        </div>

        <div id="view-grades" class="container">
            <h2 style="color:var(--primary);">GRADEBOOK</h2>
            <div class="control-bar">
                 <select id="grade-course" class="input-std" style="width:200px;" onchange="APP.grades.init()"></select>
                 <input type="text" id="grade-search" placeholder="Search Name or ID..." class="input-std" style="width:200px;" onkeyup="APP.grades.init()">
                 <div class="flex gap-10" style="margin-left:auto;">
                    <button class="btn btn-light restricted" onclick="APP.grades.manage()">Manage Assessments</button>
                    <button class="btn btn-gold" onclick="APP.import.open('grades')">Import</button>
                    <button class="btn btn-primary" onclick="APP.export.open('grades')">Export</button>
                    <button class="btn btn-primary restricted" onclick="APP.grades.openCreateModal()">+ New Assessment</button>
                 </div>
            </div>
            <div style="overflow-x:auto; padding-bottom: 20px;">
                <table class="data-table">
                    <thead id="grade-thead"></thead>
                    <tbody id="grade-tbody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="view-admin" class="container">
            <div class="flex-between" style="margin-bottom:20px;">
                <h2 style="color:var(--primary);">ADMIN CONSOLE</h2>
                <div class="menu-wrapper"><button class="btn btn-gold">Menu <i class="fas fa-caret-down"></i></button><div class="menu-dropdown"><button class="menu-btn" onclick="APP.admin.openBackupModal()">Backup / Restore</button></div></div>
            </div>
            <div id="admin-ta-list" class="dash-grid"></div>
        </div>
    </div>

    <div id="assessment-modal" class="modal"><div class="modal-box" style="width: 400px;"><span class="close-modal" onclick="document.getElementById('assessment-modal').style.display='none'">&times;</span><h3 style="color:var(--primary);">Create Assessment</h3><label style="font-weight:bold; display:block; margin-top:10px;">Assessment Name</label><input type="text" id="new-ass-name" class="input-std" placeholder="e.g. Quiz 1"><label style="font-weight:bold; display:block; margin-top:10px;">Max Score</label><input type="number" id="new-ass-max" class="input-std" placeholder="e.g. 100"><label style="font-weight:bold; display:block; margin-top:10px;">Date Given</label><input type="date" id="new-ass-date" class="input-std"><button class="btn btn-gold w-full" style="margin-top:20px;" onclick="APP.grades.create()">Create Assessment</button></div></div>
    
    <div id="manage-ass-modal" class="modal">
        <div class="modal-box">
            <span class="close-modal" onclick="document.getElementById('manage-ass-modal').style.display='none'">&times;</span>
            <h3 style="color:var(--primary); margin-bottom: 5px;">Manage Assessments</h3>
            <p style="font-size:0.85rem; color:#666; margin-bottom: 20px;">Manage assessments for the selected course.</p>
            <div id="manage-ass-list" class="manage-grid"></div>
        </div>
    </div>

    <div id="edit-ass-modal" class="modal"><div class="modal-box" style="width: 400px;"><span class="close-modal" onclick="document.getElementById('edit-ass-modal').style.display='none'">&times;</span><h3 style="color:var(--primary);">Edit Assessment Details</h3><input type="hidden" id="edit-ass-id"><label style="font-weight:bold;">Name</label><input type="text" id="edit-ass-name" class="input-std" style="margin-bottom:10px;"><label style="font-weight:bold;">Date Given</label><input type="date" id="edit-ass-date" class="input-std" style="margin-bottom:10px;"><label style="font-weight:bold;">Max Score</label><input type="number" id="edit-ass-max" class="input-std"><button class="btn btn-primary w-full" style="margin-top:20px;" onclick="APP.grades.saveEdit()">Save Changes</button></div></div>
    <div id="setup-modal" class="modal"><div class="modal-box"><span class="close-modal" onclick="document.getElementById('setup-modal').style.display='none'">&times;</span><h3>System Setup</h3><label style="font-weight:bold;">TA Full Name</label><input type="text" id="setup-name" class="input-std" style="margin-bottom:10px;"><div class="flex gap-10"><div class="w-full"><label style="font-weight:bold;">Start of Semester</label><input type="date" id="setup-date" class="input-std"></div><div class="w-full"><label style="font-weight:bold;">Total Weeks</label><input type="number" id="setup-weeks" value="13" class="input-std"></div></div><hr style="margin:15px 0; border:0; border-top:1px solid #eee;"><label style="font-weight:bold;">Course codes and groups</label><div class="flex gap-10" style="background:#f8fafc; padding:10px; border-radius:6px; margin-bottom:10px;"><input type="text" id="auto-code" class="input-std" placeholder="Course Code" style="margin:0;"><input type="number" id="auto-count" class="input-std" placeholder="Groups" style="width:80px; margin:0;"><button class="btn btn-primary" onclick="APP.setup.generateGroups()">Add</button></div><div id="setup-rows" style="max-height:200px; overflow-y:auto; margin-bottom:10px;"></div><button class="btn btn-gold w-full" style="margin-top:20px;" onclick="APP.setup.save()">Save Configuration</button></div></div>
    <div id="admin-backup-modal" class="modal"><div class="modal-box"><span class="close-modal" onclick="document.getElementById('admin-backup-modal').style.display='none'">&times;</span><h3>Admin System Backup</h3><div class="tab-container" style="display:flex; border-bottom:1px solid #ddd; margin-bottom:15px;"><div style="padding:10px 20px; cursor:pointer; font-weight:bold; border-bottom:2px solid var(--primary);" onclick="APP.admin.switchBackupTab('bk')">Backup TAs</div><div style="padding:10px 20px; cursor:pointer; color:#999;" onclick="APP.admin.switchBackupTab('rs')">Restore System</div></div><div id="adm-bk-tab"><div style="font-size:0.9rem; font-weight:bold; margin-bottom:5px;">Select TAs:</div><label style="display:block; margin-bottom:10px;"><input type="checkbox" onchange="APP.admin.toggleAllBackup(this)"> Select All</label><div id="adm-bk-list" class="chk-grid"></div><button class="btn btn-gold w-full" style="margin-top:15px;" onclick="APP.admin.processBackup()">Download Backup File</button></div><div id="adm-rs-tab" class="hidden"><p>Select a backup file to restore.</p><div class="flex gap-10"><input type="file" id="adm-rs-file" class="input-std"><button class="reset-file-btn" onclick="document.getElementById('adm-rs-file').value=''">CLEAR</button></div><button class="btn btn-danger w-full" style="margin-top:15px;" onclick="APP.admin.processRestore()">RESTORE DATA</button></div></div></div>
    <div id="backup-modal" class="modal"><div class="modal-box"><span class="close-modal" onclick="document.getElementById('backup-modal').style.display='none'">&times;</span><h3>Backup & Restore</h3><div id="bk-info" style="color:var(--text); font-weight:bold; margin-bottom:10px;"></div><button class="btn btn-gold w-full" onclick="APP.backup.download('json')">Download Backup (JSON)</button><hr style="margin:20px 0; border:0; border-top:1px solid #eee;"><div class="flex gap-10"><input type="file" id="restore-file" class="input-std"><button class="reset-file-btn" onclick="document.getElementById('restore-file').value=''">CLEAR</button></div><button class="btn btn-danger w-full" style="margin-top:10px;" onclick="APP.backup.restore()">Restore System</button></div></div>
    <div id="export-modal" class="modal"><div class="modal-box"><span class="close-modal" onclick="document.getElementById('export-modal').style.display='none'">&times;</span><h3 id="export-title">Export Data</h3><div style="font-size:0.85rem; font-weight:bold;">Select Groups/Items:</div><div id="export-checks" class="chk-grid"></div><button class="btn btn-primary w-full" style="margin-top:15px;" onclick="APP.export.process()">Download Excel</button></div></div>

    <div id="import-modal" class="modal">
        <div class="modal-box">
            <span class="close-modal" onclick="document.getElementById('import-modal').style.display='none'">&times;</span>
            <h3 id="import-title">Import Data</h3>
            
            <div id="imp-step-1">
                <div id="imp-std-chk-cont">
                    <div style="font-size:0.85rem; font-weight:bold;">1. Select Targets (for Student Import Only):</div>
                    <div id="import-checks" class="chk-grid"></div>
                </div>
                
                <div style="font-size:0.85rem; font-weight:bold; margin-top:10px;">2. Source File:</div>
                <div class="flex gap-10" style="margin-bottom:10px;">
                     <input type="file" id="import-file" class="input-std">
                     <button class="reset-file-btn" onclick="document.getElementById('import-file').value=''">CLEAR</button>
                </div>
                
                <div id="imp-text-area-cont">
                    <textarea id="import-text" class="input-std" style="height:100px;" placeholder="Or Paste Data (e.g. 10293847 John Doe)"></textarea>
                </div>

                <div id="imp-grade-btn-cont" class="hidden">
                    <button class="btn btn-gold w-full" style="margin-top:15px;" onclick="APP.import.preview()">Preview & Configure</button>
                </div>
                <div id="imp-std-btn-cont">
                    <button class="btn btn-primary w-full" style="margin-top:15px;" onclick="APP.import.process()">Run Standard Import</button>
                </div>
            </div>

            <div id="imp-step-2" class="hidden">
                <div id="imp-sheet-cont" class="hidden" style="margin-bottom:15px; background:#e0f2fe; padding:10px; border-radius:6px; border:1px solid #bae6fd;">
                    <label style="font-weight:bold; color:var(--primary); font-size:0.9rem;">Select Sheet from File:</label>
                    <select id="imp-sheet-sel" class="input-std" onchange="APP.import.parseSheet(this.value)"></select>
                </div>

                <div style="margin-bottom:15px; background:#fef3c7; padding:10px; border-radius:6px; border:1px solid #fcd34d;">
                    <label style="font-weight:bold; color:var(--primary); font-size:0.9rem;">Import these grades into:</label>
                    <div id="imp-target-checks" class="chk-grid" style="background:white; margin-top:5px;"></div>
                </div>

                <div style="font-weight:bold; color:var(--primary); margin-bottom:10px;">Confirm Assessment Details:</div>
                <div id="imp-preview-list" style="max-height:200px; overflow-y:auto;"></div>
                <div class="flex gap-10" style="margin-top:15px;">
                    <button class="btn btn-light w-full" onclick="APP.import.back()">Back</button>
                    <button class="btn btn-success w-full" onclick="APP.import.finalizeGradeImport()">Confirm Import</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const APP = {
            user: null, role: 'admin', data: {}, 
            sortState: { col: 'id', dir: 1 },

            // ====== INDEXED DB STORAGE ENGINE ======
            db: {
                dbName: "UG_Unified_DB_Mohammed_v13",
                dbVersion: 11,
                instance: null,
                init: function() {
                    return new Promise((resolve, reject) => {
                        const req = indexedDB.open(this.dbName, this.dbVersion);
                        req.onupgradeneeded = (e) => {
                            const db = e.target.result;
                            if (!db.objectStoreNames.contains('ta_store')) {
                                db.createObjectStore('ta_store', { keyPath: 'id' });
                            }
                        };
                        req.onsuccess = (e) => {
                            this.instance = e.target.result;
                            resolve();
                        };
                        req.onerror = (e) => reject(e);
                    });
                },
                load: async function(id) {
                    return new Promise((resolve) => {
                        const tx = this.instance.transaction('ta_store', 'readonly');
                        const store = tx.objectStore('ta_store');
                        const req = store.get(id);
                        req.onsuccess = (e) => {
                            const record = e.target.result;
                            APP.data = record ? record.data : { config: null, students: [], attendance: [], absent_attendance: [], grades: [], tasks: [], assessments: [], archives: [] };
                            if(!APP.data.absent_attendance) APP.data.absent_attendance = [];
                            resolve();
                        };
                    });
                },
                save: function() {
                    if(APP.role !== 'viewonly' && APP.role !== 'manager' && APP.user) {
                        const tx = this.instance.transaction('ta_store', 'readwrite');
                        const store = tx.objectStore('ta_store');
                        store.put({ id: APP.user, data: APP.data });
                    }
                },
                addToRegistry: function(id) {
                    // Handled automatically by ta_store keys
                },
                getRegistry: async function() {
                    return new Promise((resolve) => {
                        const tx = this.instance.transaction('ta_store', 'readonly');
                        const store = tx.objectStore('ta_store');
                        const req = store.getAllKeys();
                        req.onsuccess = (e) => {
                            resolve(e.target.result);
                        };
                    });
                },
                deleteTA: async function(id) {
                    return new Promise((resolve) => {
                        const tx = this.instance.transaction('ta_store', 'readwrite');
                        tx.objectStore('ta_store').delete(id);
                        tx.oncomplete = () => resolve();
                    });
                },
                getAllTAData: async function() {
                    return new Promise((resolve) => {
                        const tx = this.instance.transaction('ta_store', 'readonly');
                        const req = tx.objectStore('ta_store').getAll();
                        req.onsuccess = e => resolve(e.target.result);
                    });
                },
                getTAData: async function(id) {
                    return new Promise((resolve) => {
                        const tx = this.instance.transaction('ta_store', 'readonly');
                        const req = tx.objectStore('ta_store').get(id);
                        req.onsuccess = e => resolve(e.target.result);
                    });
                },
                batchPutTAs: async function(taArray) {
                    return new Promise((resolve) => {
                        const tx = this.instance.transaction('ta_store', 'readwrite');
                        taArray.forEach(item => {
                            tx.objectStore('ta_store').put({ id: item.id, data: item.data });
                        });
                        tx.oncomplete = () => resolve();
                    });
                }
            },

            auth: {
                adminAccessTA: async (id) => { 
                    APP.user = id; 
                    await APP.db.load(id); 
                    APP.nav.go('dashboard'); 
                    document.getElementById('nav-admin-back').classList.remove('hidden'); 
                    document.getElementById('sys-user-display').innerText = `VIEWING: ${(APP.data.config?APP.data.config.taName:'Unknown').toUpperCase()}`; 
                }
            },
            nav: {
                go: (view) => {
                    document.querySelectorAll('.container').forEach(c => c.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    const target = document.getElementById(`view-${view}`);
                    if(target) { target.classList.add('active'); if(view==='dashboard'){document.getElementById('nav-dash').classList.add('active');APP.dashboard.init();} if(view==='attendance'){document.getElementById('nav-att').classList.add('active');APP.attendance.init();} if(view==='database'){document.getElementById('nav-db').classList.add('active');APP.dbView.init();} if(view==='grades'){document.getElementById('nav-grade').classList.add('active');APP.grades.init();} }
                    if(view === 'admin') APP.admin.init();
                    const isAdm = view === 'admin';
                    ['nav-dash','nav-att','nav-db','nav-grade','nav-menu-btn'].forEach(id => document.getElementById(id).classList.toggle('hidden', isAdm));
                    const backBtn = document.getElementById('nav-admin-back');
                    if (isAdm || APP.role === 'ta') { backBtn.classList.add('hidden'); } else { backBtn.classList.remove('hidden'); }
                }
            },
            setup: {
                open: (edit) => { if(APP.role==='viewonly'||APP.role==='manager') return alert("Access Denied"); document.getElementById('setup-modal').style.display='flex'; const list=document.getElementById('setup-rows'); if(edit && APP.data.config) { document.getElementById('setup-name').value=APP.data.config.taName; document.getElementById('setup-date').value=APP.data.config.start; document.getElementById('setup-weeks').value=APP.data.config.weeks; list.innerHTML=''; APP.data.config.courses.forEach(c=>APP.setup.addRow(c.code,c.grp,c.startDate)); } },
                generateGroups: () => { const code=document.getElementById('auto-code').value.toUpperCase(); const count=parseInt(document.getElementById('auto-count').value); if(!code||!count) return alert("Enter code and count"); for(let i=1;i<=count;i++) APP.setup.addRow(code,i,''); document.getElementById('auto-code').value=''; document.getElementById('auto-count').value=''; },
                addRow: (c='',g='',d='') => { const div=document.createElement('div'); div.className='flex gap-10'; div.style.marginBottom='8px'; div.innerHTML=`<input class="input-std s-code" value="${c}" placeholder="Code" style="width:30%" disabled><input class="input-std s-grp" value="${g}" placeholder="Grp" style="width:20%" disabled><input type="date" class="input-std s-date" value="${d}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button>`; document.getElementById('setup-rows').appendChild(div); },
                save: () => { const taName=document.getElementById('setup-name').value; const start=document.getElementById('setup-date').value; const weeks=document.getElementById('setup-weeks').value; const rows=document.querySelectorAll('#setup-rows > div'); const courses=[]; rows.forEach(r=>{ const code=r.querySelector('.s-code').value.toUpperCase(); const grp=r.querySelector('.s-grp').value; const startDate=r.querySelector('.s-date').value; if(code&&grp&&startDate) courses.push({id:`${code}_G${grp}`,code,grp,startDate}); }); if(!taName||courses.length===0) return alert("Fill all fields"); APP.data.config={taName,start,weeks,courses}; APP.db.save(); location.reload(); },
                newSystem: () => { if(confirm("ARCHIVE and RESET system?")) { APP.setup.archiveSemester(); APP.data={config:null,students:[],attendance:[],absent_attendance:[],grades:[],tasks:[],assessments:[],archives:APP.data.archives}; APP.db.save(); location.reload(); } },
                archiveSemester: () => { APP.data.archives.push({date:new Date().toISOString(),data:JSON.parse(JSON.stringify(APP.data))}); alert("Archived"); APP.db.save(); }
            },
            dashboard: {
                init: () => { APP.utils.calcCurrentWeek(); const grid=document.getElementById('dash-grid'); const tasks=document.getElementById('dash-tasks'); grid.innerHTML=''; tasks.innerHTML=''; const map={}; APP.data.config.courses.forEach(c=>{ if(!map[c.code]) map[c.code]=[]; map[c.code].push(c); }); for(let code in map) { let html=`<div class="dash-card"><h3>${code}</h3>`; map[code].forEach(c=>{ let count=0; for(let w=1;w<=APP.data.config.weeks;w++) if(APP.data.tasks.includes(`${c.id}_W${w}`)) count++; const pct=Math.round((count/APP.data.config.weeks)*100); html+=`<div class="stat-line"><span>Group ${c.grp}</span> <strong>${count} / ${APP.data.config.weeks} (${pct}%)</strong></div>`; }); html+=`</div>`; grid.innerHTML+=html; } for(let w=1;w<=APP.data.config.weeks;w++) { const isCurrent=w===APP.utils.currentWeek; const currentBadge=isCurrent?'<span class="current-week-badge">CURRENT WEEK</span>':''; let html=''; APP.data.config.courses.forEach(c=>{ const tid=`${c.id}_W${w}`; const done=APP.data.tasks.includes(tid); const btnClass=done?'btn-gold':'btn-light'; const btnIcon=done?'<i class="fas fa-check-circle"></i> Yes':'<i class="fas fa-circle"></i> No'; html+=`<div class="task-row"><div style="font-weight:bold; color:var(--primary); font-size:1rem;">${c.code} <span style="font-weight:normal; color:var(--muted);">Group ${c.grp}</span></div><div class="flex"><span class="task-hint">Was assignment given for the week?</span><button id="btn-${tid}" class="btn ${btnClass}" onclick="APP.dashboard.toggle('${tid}')">${btnIcon}</button></div></div>`; }); const openClass=isCurrent?'open':''; const headerClass=isCurrent?'current-week':''; tasks.innerHTML+=`<div class="task-card"><div class="task-header ${headerClass}" onclick="this.nextElementSibling.classList.toggle('open')"><span>Week ${w} ${currentBadge}</span> <i class="fas fa-chevron-down"></i></div><div class="task-body ${openClass}">${html}</div></div>`; } },
                toggle: (tid) => { if(APP.role!=='ta'&&APP.role!=='admin') return; const idx=APP.data.tasks.indexOf(tid); if(idx>-1) APP.data.tasks.splice(idx,1); else APP.data.tasks.push(tid); APP.db.save(); APP.dashboard.init(); const w=tid.split('_W')[1]; const headers=document.querySelectorAll('.task-header'); if(headers[w-1]) headers[w-1].nextElementSibling.classList.add('open'); }
            },
            attendance: {
                current: null, init: () => { const cSel=document.getElementById('att-course'); const wSel=document.getElementById('att-week'); if(cSel.innerHTML==="") { APP.data.config.courses.forEach(c=>cSel.innerHTML+=`<option value="${c.id}">${c.code} G${c.grp}</option>`); for(let i=1;i<=APP.data.config.weeks;i++) wSel.innerHTML+=`<option value="${i}">Week ${i}</option>`; wSel.value=APP.utils.currentWeek; } APP.attendance.update(); },
                update: () => { const cid=document.getElementById('att-course').value; const w=parseInt(document.getElementById('att-week').value); const course=APP.data.config.courses.find(c=>c.id===cid); APP.attendance.current={cid,w,course}; const date=APP.utils.getWeekDate(course.startDate,w); document.getElementById('att-date-display').innerText=date.toDateString(); document.getElementById('att-week-badge').innerText=w===APP.utils.currentWeek?"CURRENT WEEK":`WEEK ${w}`; const isFuture=date>new Date(); document.getElementById('att-future-warning').style.display=isFuture?'block':'none'; document.getElementById('att-content').style.display=isFuture?'none':'block'; if(!isFuture) APP.attendance.render(); },
                render: () => { 
                    const {cid,w}=APP.attendance.current; const search=document.getElementById('att-search').value.toLowerCase(); const tbody=document.getElementById('att-tbody'); tbody.innerHTML=''; 
                    let list=APP.data.students.filter(s=>s.grp===cid&&(s.name.toLowerCase().includes(search)||s.id.includes(search))); 
                    list.forEach(s=>{ let t=0; for(let i=1;i<=13;i++) if(APP.data.attendance.includes(`${cid}_W${i}_${s.id}`)) t++; s.tempTotal=t; }); 
                    list=APP.utils.doSort(list,'att'); 
                    let present = 0;
                    list.forEach((s, index) => {
                        const aid = `${cid}_W${w}_${s.id}`;
                        const isP = APP.data.attendance.includes(aid);
                        const isA = APP.data.absent_attendance.includes(aid);
                        if(isP) present++;
                        tbody.innerHTML += `<tr>
                            <td>${index + 1}</td>
                            <td class="uppercase">${s.id}</td><td class="uppercase" style="font-weight:600;">${s.name}</td><td><button class="status-btn ${isP?'p-active':''}" onclick="APP.attendance.mark('${aid}', 'P')">P</button><button class="status-btn ${isA?'a-active':''}" onclick="APP.attendance.mark('${aid}', 'A')">A</button></td><td>${s.tempTotal}/13</td></tr>`; 
                    }); 
                    document.getElementById('att-headcount').innerText=`Present: ${present} / ${list.length}`; 
                },
                mark: (aid, type) => { if(APP.role!=='ta'&&APP.role!=='admin') return; const isP=APP.data.attendance.includes(aid); const isA=APP.data.absent_attendance.includes(aid); if(type==='P') { if(isP) APP.data.attendance=APP.data.attendance.filter(x=>x!==aid); else { APP.data.attendance.push(aid); APP.data.absent_attendance=APP.data.absent_attendance.filter(x=>x!==aid); } } else if(type==='A') { if(isA) APP.data.absent_attendance=APP.data.absent_attendance.filter(x=>x!==aid); else { APP.data.absent_attendance.push(aid); APP.data.attendance=APP.data.attendance.filter(x=>x!==aid); } } APP.db.save(); APP.attendance.render(); },
                manualAdd: () => {
                    const val = document.getElementById('att-manual').value.trim();
                    if(!val) return;
                    const currentGrpId = APP.attendance.current.cid; 
                    const currentCourseDef = APP.data.config.courses.find(c => c.id === currentGrpId);
                    const currentCourseCode = currentCourseDef ? currentCourseDef.code : '';

                    let existingStudent = APP.data.students.find(x => x.id === val || x.name.toUpperCase() === val.toUpperCase());
                    let finalId = existingStudent ? existingStudent.id : val;
                    let finalName = existingStudent ? existingStudent.name : val.toUpperCase();

                    const alreadyInCourse = APP.data.students.find(s => {
                        if (s.id !== finalId) return false;
                        const sCourseDef = APP.data.config.courses.find(c => c.id === s.grp);
                        return sCourseDef && sCourseDef.code === currentCourseCode;
                    });

                    if(!existingStudent && !alreadyInCourse) {
                        if(confirm(`Student "${val}" not found in database. Add them now?`)) {
                            finalId = prompt("Confirm ID for new student:", val.match(/\d+/) ? val : "");
                            if(!finalId) return;
                            finalName = val.match(/\d+/) ? "New Student" : val.toUpperCase();
                        } else return;
                    }

                    if(alreadyInCourse && alreadyInCourse.grp !== currentGrpId) {
                        alert(`Cannot add: Student is already in another group (${alreadyInCourse.grp}) for this course.`);
                        return;
                    }

                    if(!alreadyInCourse) {
                        APP.data.students.push({ id: finalId, name: finalName, grp: currentGrpId });
                    }

                    const aid = `${currentGrpId}_W${APP.attendance.current.w}_${finalId}`;
                    if(!APP.data.attendance.includes(aid)) APP.data.attendance.push(aid);
                    APP.data.absent_attendance = APP.data.absent_attendance.filter(x => x !== aid);
                    APP.db.save();
                    APP.attendance.render();
                    document.getElementById('att-manual').value = '';
                    alert(`Marked ${finalName} Present`);
                }
            },
            dbView: {
                init: () => { const pills=document.getElementById('db-pills'); pills.innerHTML=`<button class="btn btn-primary" onclick="APP.dbView.render('all')">All</button>`; APP.data.config.courses.forEach(c=>{ pills.innerHTML+=`<button class="btn btn-light" onclick="APP.dbView.render('${c.id}')">${c.code} G${c.grp}</button>`; }); APP.dbView.render(); },
                render: (filter) => { 
                    const search=document.getElementById('db-search').value.toLowerCase(); const tbody=document.getElementById('db-tbody'); tbody.innerHTML=''; 
                    let list=APP.data.students.filter(s=>s.name.toLowerCase().includes(search)||s.id.includes(search)); 
                    if(filter&&filter!=='all') list=list.filter(s=>s.grp===filter); 
                    list=APP.utils.doSort(list,'db'); 
                    list.forEach((s, index) => {
                        const grpName = APP.data.config.courses.find(c => c.id === s.grp);
                        tbody.innerHTML += `<tr>
                            <td><input type="checkbox" class="db-chk" value="${s.id}"></td>
                            <td>${index + 1}</td>
                            <td class="uppercase">${s.id}</td><td contenteditable="true" class="uppercase editable" onblur="APP.dbView.saveName('${s.id}', this.innerText)">${s.name}</td>
                            <td>${grpName ? `${grpName.code} G${grpName.grp}` : s.grp}</td>
                        </tr>`;
                    }); 
                },
                saveName: (id, name) => { const s=APP.data.students.find(x=>x.id===id); if(s) { s.name=name.toUpperCase(); APP.db.save(); } },
                deleteSelected: () => { if(APP.role!=='ta'&&APP.role!=='admin') return; const ids=Array.from(document.querySelectorAll('.db-chk:checked')).map(c=>c.value); if(confirm(`Delete ${ids.length} students?`)) { APP.data.students=APP.data.students.filter(s=>!ids.includes(s.id)); APP.db.save(); APP.dbView.render(); } },
                toggleAll: (el) => document.querySelectorAll('.db-chk').forEach(c=>c.checked=el.checked)
            },
            grades: {
                init: () => { 
                    const cid=document.getElementById('grade-course').value||(APP.data.config.courses[0]?APP.data.config.courses[0].id:''); 
                    if(!document.getElementById('grade-course').value&&cid) { 
                        const sel=document.getElementById('grade-course'); sel.innerHTML=''; 
                        APP.data.config.courses.forEach(c=>sel.innerHTML+=`<option value="${c.id}">${c.code} G${c.grp}</option>`); 
                        sel.value=cid; 
                    } 
                    const search=document.getElementById('grade-search').value.toLowerCase(); 
                    const th=document.getElementById('grade-thead'); 
                    const tb=document.getElementById('grade-tbody'); 
                    const cols=APP.data.assessments.filter(a=>a.grp===cid); 
                    const students=APP.data.students.filter(s=>s.grp===cid&&(s.name.toLowerCase().includes(search)||s.id.includes(search))); 
                    
                    let h = `<tr><th width="50">No.</th><th onclick="APP.utils.sort('gr','id')">ID <i class="fas fa-sort"></i></th><th onclick="APP.utils.sort('gr','name')">Name <i class="fas fa-sort"></i></th>`; 
                    cols.forEach(c=>{ const maxDisplay=c.max?` /${c.max}`:''; const dateDisplay=c.date?`<br><small style="font-weight:normal; font-size:0.75em; opacity:0.8;">${c.date}</small>`:''; h+=`<th><div class="gb-header-content" onclick="APP.grades.openEdit('${c.id}')"><span>${c.name}${maxDisplay}${dateDisplay}</span></div><div class="gb-sort-controls"><button class="gb-sort-btn" onclick="APP.grades.sortCol('${c.id}', 1)"><i class="fas fa-arrow-up"></i></button><button class="gb-sort-btn" onclick="APP.grades.sortCol('${c.id}', -1)"><i class="fas fa-arrow-down"></i></button></div></th>`; }); 
                    th.innerHTML=h+'</tr>'; 
                    
                    let list=students; 
                    if(APP.sortState.col.startsWith('ass_')) { const aid=APP.sortState.col.split('_')[1]; const dir=APP.sortState.dir; list.sort((a,b)=>{ const va=parseFloat((APP.data.grades.find(g=>g.id===`${a.id}_${aid}`)||{}).val)||0; const vb=parseFloat((APP.data.grades.find(g=>g.id===`${b.id}_${aid}`)||{}).val)||0; return (va>vb?1:-1)*dir; }); } 
                    else { list=APP.utils.doSort(students,'gr'); } 
                    
                    let b = '';
                    list.forEach((s, index) => {
                        b += `<tr><td>${index + 1}</td><td>${s.id}</td><td class="uppercase">${s.name}</td>`; 
                        cols.forEach(c=>{ 
                            const gid=`${s.id}_${c.id}`; 
                            const val=(APP.data.grades.find(g=>g.id===gid)||{}).val||''; 
                            const isError=c.max&&!isNaN(parseFloat(val))&&parseFloat(val)>parseFloat(c.max); 
                            b+=`<td><input type="text" class="input-std grade-input ${isError?'input-error':''}" style="width:70px;" value="${val}" onkeyup="APP.grades.validate(this, ${c.max})" onblur="APP.grades.save('${gid}', this.value)"></td>`; 
                        }); 
                        b+='</tr>'; 
                    }); 
                    tb.innerHTML=b; 
                },
                sortCol: (aid, dir) => { APP.sortState.col=`ass_${aid}`; APP.sortState.dir=dir; APP.grades.init(); },
                validate: (el, max) => { if(max&&!isNaN(parseFloat(el.value))&&parseFloat(el.value)>parseFloat(max)) el.classList.add('input-error'); else el.classList.remove('input-error'); },
                openCreateModal: () => { document.getElementById('new-ass-name').value=''; document.getElementById('new-ass-max').value=''; document.getElementById('new-ass-date').value=''; document.getElementById('assessment-modal').style.display='flex'; },
                create: () => { const name=document.getElementById('new-ass-name').value; const max=document.getElementById('new-ass-max').value; const date=document.getElementById('new-ass-date').value; if(!name) return alert("Name is required"); APP.data.assessments.push({id:Date.now(),name,grp:document.getElementById('grade-course').value,max,date}); APP.db.save(); document.getElementById('assessment-modal').style.display='none'; APP.grades.init(); },
                
                manage: () => { 
                    document.getElementById('manage-ass-modal').style.display='flex'; 
                    const cid=document.getElementById('grade-course').value; 
                    const list=document.getElementById('manage-ass-list'); 
                    list.innerHTML=''; 
                    const cols=APP.data.assessments.filter(a=>a.grp===cid); 
                    if(cols.length===0) list.innerHTML='<div style="text-align:center; padding:20px; color:#999;">No assessments found.</div>'; 
                    cols.forEach(c=>{ 
                        const count = APP.data.grades.filter(g => g.id.endsWith(`_${c.id}`)).length;
                        list.innerHTML+=`
                        <div class="manage-card">
                            <div class="manage-info">
                                <h4>${c.name}</h4>
                                <p>${c.date || 'No Date'} | Max: ${c.max || '-'} | Grades: ${count}</p>
                            </div>
                            <button class="btn btn-danger" style="font-size:0.8rem; padding: 5px 10px;" onclick="APP.grades.deleteOne('${c.id}')"><i class="fas fa-trash"></i></button>
                        </div>`; 
                    }); 
                },
                deleteOne: (id) => {
                    if(confirm("Delete this assessment and all its grades?")) {
                        APP.data.assessments = APP.data.assessments.filter(a => a.id.toString() !== id.toString());
                        APP.data.grades = APP.data.grades.filter(g => !g.id.endsWith(`_${id}`));
                        APP.db.save();
                        APP.grades.manage(); // Refresh list
                        APP.grades.init();
                    }
                },
                deleteSelected: () => {}, 

                openEdit: (aid) => { const a=APP.data.assessments.find(x=>x.id==aid); if(!a) return; document.getElementById('edit-ass-id').value=aid; document.getElementById('edit-ass-name').value=a.name; document.getElementById('edit-ass-date').value=a.date||''; document.getElementById('edit-ass-max').value=a.max||''; document.getElementById('edit-ass-modal').style.display='flex'; },
                saveEdit: () => { const aid=document.getElementById('edit-ass-id').value; const a=APP.data.assessments.find(x=>x.id==aid); if(a) { a.name=document.getElementById('edit-ass-name').value; a.date=document.getElementById('edit-ass-date').value; a.max=document.getElementById('edit-ass-max').value; APP.db.save(); document.getElementById('edit-ass-modal').style.display='none'; APP.grades.init(); } },
                save: (id, val) => { const g=APP.data.grades.find(x=>x.id===id); if(g) g.val=val; else APP.data.grades.push({id,val}); APP.db.save(); }
            },

            import: {
                type: '', 
                fileData: null,
                workbook: null,
                stagingData: null,
                
                open: (t) => {
                    APP.import.type = t;
                    document.getElementById('import-modal').style.display = 'flex';
                    document.getElementById('imp-step-1').classList.remove('hidden');
                    document.getElementById('imp-step-2').classList.add('hidden');
                    
                    const grid = document.getElementById('import-checks'); grid.innerHTML = '';
                    const textArea = document.getElementById('imp-text-area-cont');
                    const gradeBtn = document.getElementById('imp-grade-btn-cont');
                    const stdBtn = document.getElementById('imp-std-btn-cont');
                    const stdChk = document.getElementById('imp-std-chk-cont');

                    if(t === 'grades') {
                        // Grade Import Mode
                        stdChk.classList.add('hidden'); // Hide Targets in Step 1
                        textArea.classList.add('hidden');
                        gradeBtn.classList.remove('hidden');
                        stdBtn.classList.add('hidden');
                    } else {
                        // Standard Mode
                        stdChk.classList.remove('hidden');
                        textArea.classList.remove('hidden');
                        gradeBtn.classList.add('hidden');
                        stdBtn.classList.remove('hidden');
                        if(t === 'attendance') {
                            for(let i=1; i<=APP.data.config.weeks; i++) grid.innerHTML += `<label><input type="checkbox" class="imp-chk" value="W${i}"> Week ${i}</label>`;
                        } else {
                            APP.data.config.courses.forEach(c => grid.innerHTML += `<label><input type="checkbox" class="imp-chk" value="${c.id}"> ${c.code} G${c.grp}</label>`);
                        }
                    }
                },

                preview: () => {
                    const f = document.getElementById('import-file').files[0];
                    if(!f) return alert("Please select a file first.");
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        APP.import.workbook = XLSX.read(data, {type: 'array'});
                        
                        const sheetSelect = document.getElementById('imp-sheet-sel');
                        const sheetCont = document.getElementById('imp-sheet-cont');
                        
                        // Populate Sheet Selector
                        if(APP.import.workbook.SheetNames.length > 1) {
                            sheetCont.classList.remove('hidden');
                            sheetSelect.innerHTML = '';
                            APP.import.workbook.SheetNames.forEach((name, idx) => {
                                sheetSelect.innerHTML += `<option value="${idx}">${name}</option>`;
                            });
                        } else {
                            sheetCont.classList.add('hidden');
                        }

                        // Populate Target Group Selector (New in Step 2)
                        const targetGrid = document.getElementById('imp-target-checks');
                        targetGrid.innerHTML = '';
                        // Default check current active course if possible, else unchecked
                        const activeCid = document.getElementById('grade-course').value;
                        APP.data.config.courses.forEach(c => {
                            const isChecked = c.id === activeCid ? 'checked' : '';
                            targetGrid.innerHTML += `<label><input type="checkbox" class="imp-target-chk" value="${c.id}" ${isChecked}> ${c.code} G${c.grp}</label>`;
                        });

                        // Parse First Sheet
                        APP.import.parseSheet(0);
                        
                        document.getElementById('imp-step-1').classList.add('hidden');
                        document.getElementById('imp-step-2').classList.remove('hidden');
                    };
                    reader.readAsArrayBuffer(f);
                },

                parseSheet: (sheetIdx) => {
                    const sheetName = APP.import.workbook.SheetNames[sheetIdx];
                    const sheet = APP.import.workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(sheet, {header: 1}); // Array of Arrays
                    
                    if(json.length < 1) {
                        document.getElementById('imp-preview-list').innerHTML = '<div style="color:red">Empty Sheet</div>';
                        return;
                    }

                    // 1. Detect Header Row
                    let headerRowIdx = -1;
                    let colMap = { id: -1, name: -1, assignment: -1, grade: -1 };
                    
                    for(let i=0; i<Math.min(json.length, 15); i++) {
                        const row = json[i].map(x => x ? x.toString().toLowerCase() : "");
                        if(row.includes("user id") || row.includes("student id") || row.includes("id")) {
                            headerRowIdx = i;
                            colMap.id = row.findIndex(c => c.includes("user id") || c.includes("student id") || c === "id");
                            colMap.name = row.indexOf("name");
                            colMap.assignment = row.findIndex(c => c.includes("assignment") && !c.includes("submission"));
                            colMap.grade = row.findIndex(c => c === "grade" || c.includes("score"));
                            break;
                        }
                    }

                    if(headerRowIdx === -1) {
                        document.getElementById('imp-preview-list').innerHTML = '<div style="color:red">Could not detect "Student ID" header row.</div>';
                        return;
                    }

                    const headers = json[headerRowIdx];
                    const dataRows = json.slice(headerRowIdx + 1);
                    APP.import.stagingData = {};

                    // 2. Strategy A: Row-based
                    if(colMap.assignment > -1 && colMap.grade > -1) {
                        dataRows.forEach(r => {
                            const assName = r[colMap.assignment];
                            const sid = r[colMap.id];
                            const grade = r[colMap.grade];
                            
                            if(assName && sid) {
                                if(!APP.import.stagingData[assName]) APP.import.stagingData[assName] = {};
                                if(grade && grade.toString().toLowerCase() !== "no grade" && grade.toString().toLowerCase() !== "no submission") {
                                    APP.import.stagingData[assName][sid] = grade;
                                }
                            }
                        });
                    } 
                    // 3. Strategy B: Columnar
                    else {
                        headers.forEach((h, idx) => {
                            if(idx !== colMap.id && idx !== colMap.name && h && !h.toString().toLowerCase().includes("scale") && !h.toString().toLowerCase().includes("email") && !h.toString().toLowerCase().includes("last access")) {
                                let assName = h.toString();
                                if(assName.startsWith('#')) assName = assName.substring(1);
                                
                                if(!APP.import.stagingData[assName]) APP.import.stagingData[assName] = {};
                                
                                dataRows.forEach(r => {
                                    const sid = r[colMap.id];
                                    const val = r[idx];
                                    if(sid && val !== undefined && val !== null && val !== "" && val.toString().toLowerCase() !== "no grade") {
                                        APP.import.stagingData[assName][sid] = val;
                                    }
                                });
                            }
                        });
                    }

                    // 4. Render Preview
                    const list = document.getElementById('imp-preview-list');
                    list.innerHTML = '';
                    const detected = Object.keys(APP.import.stagingData);
                    
                    if(detected.length === 0) {
                        list.innerHTML = '<div style="color:#666">No assessable data found in this sheet.</div>';
                        return;
                    }

                    detected.forEach((assName, idx) => {
                        let max = '';
                        let cleanName = assName;
                        const match = assName.match(/\[(.*?)\]/);
                        if(match) { max = match[1]; cleanName = assName.replace(match[0], '').trim(); }

                        list.innerHTML += `
                            <div class="preview-row">
                                <div style="display:flex; align-items:center;">
                                    <input type="checkbox" class="imp-col-chk" checked data-name="${assName}">
                                </div>
                                <div class="w-full">
                                    <div class="preview-lbl">${assName}</div>
                                    <div class="flex gap-10" style="margin-top:5px;">
                                        <input type="text" class="input-std imp-col-name" value="${cleanName}" placeholder="Name">
                                        <input type="number" class="input-std imp-col-max" value="${max}" placeholder="Max" style="width:70px;">
                                        <input type="date" class="input-std imp-col-date">
                                    </div>
                                    <div style="font-size:0.75rem; color:#666; margin-top:2px;">${Object.keys(APP.import.stagingData[assName]).length} grades found</div>
                                </div>
                            </div>
                        `;
                    });
                },

                back: () => {
                    document.getElementById('imp-step-1').classList.remove('hidden');
                    document.getElementById('imp-step-2').classList.add('hidden');
                },

                finalizeGradeImport: () => {
                    const targets = Array.from(document.querySelectorAll('.imp-target-chk:checked')).map(c=>c.value);
                    if(targets.length === 0) return alert("Please select at least one Course Group to import into.");

                    const rows = document.querySelectorAll('.preview-row');
                    let createdCount = 0;
                    
                    rows.forEach(row => {
                        const chk = row.querySelector('.imp-col-chk');
                        if(chk && chk.checked) {
                            const originalName = chk.dataset.name;
                            const name = row.querySelector('.imp-col-name').value;
                            const max = row.querySelector('.imp-col-max').value;
                            const date = row.querySelector('.imp-col-date').value;
                            const gradeMap = APP.import.stagingData[originalName];

                            // Create Assessment for EACH target group
                            targets.forEach(grpId => {
                                const newAssId = Date.now() + Math.floor(Math.random()*10000);
                                APP.data.assessments.push({ id: newAssId, name, grp: grpId, max, date });
                                
                                // Populate Grades
                                for(let sid in gradeMap) {
                                    // Only add grade if student exists in THAT group
                                    if(APP.data.students.find(s => s.id == sid && s.grp === grpId)) {
                                        const gid = `${sid}_${newAssId}`;
                                        APP.data.grades.push({ id: gid, val: gradeMap[sid].toString() });
                                    }
                                }
                            });
                            createdCount++;
                        }
                    });

                    APP.db.save();
                    alert(`Imported ${createdCount} assessments across selected groups.`);
                    document.getElementById('import-modal').style.display = 'none';
                    APP.grades.init();
                },

                process: () => {
                    const fileInput = document.getElementById('import-file');
                    const txtArea = document.getElementById('import-text').value;
                    const chks = Array.from(document.querySelectorAll('.imp-chk:checked')).map(c=>c.value);
                    
                    if(chks.length === 0) return alert("Please select at least one target check box.");

                    if (fileInput.files.length > 0) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});
                            let combinedText = "";
                            
                            workbook.SheetNames.forEach(sheetName => {
                                const sheet = workbook.Sheets[sheetName];
                                const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
                                json.forEach(row => { combinedText += row.join("\t") + "\n"; });
                            });
                            APP.import.executeStandardImport(combinedText, chks);
                        };
                        reader.readAsArrayBuffer(fileInput.files[0]);
                    } else if (txtArea.trim().length > 0) {
                        APP.import.executeStandardImport(txtArea, chks);
                    } else {
                        alert("Please select a file or paste data.");
                    }
                },
                
                executeStandardImport: (txt, chks) => {
                    const lines = txt.split('\n');
                    let count = 0;
                    
                    lines.forEach(l => {
                        const m = l.match(/\b\d{7,10}\b/); 
                        if(m) {
                            const id = m[0];
                            if(APP.import.type === 'students') {
                                let name = l.replace(id, '').replace(/[,;\t]/g, ' ').replace(/\s+/g, ' ').trim() || "Unknown";
                                chks.forEach(grp => {
                                    const targetCourseDef = APP.data.config.courses.find(c => c.id === grp);
                                    const targetCourseCode = targetCourseDef ? targetCourseDef.code : null;
                                    
                                    const alreadyInCourse = APP.data.students.find(s => {
                                        if (s.id !== id) return false;
                                        const sCourseDef = APP.data.config.courses.find(c => c.id === s.grp);
                                        return sCourseDef && sCourseDef.code === targetCourseCode;
                                    });

                                    if(!alreadyInCourse) {
                                        APP.data.students.push({ id, name: name.toUpperCase(), grp });
                                        count++;
                                    }
                                });
                            } else if(APP.import.type === 'attendance') {
                                const cid = document.getElementById('att-course').value;
                                chks.forEach(w => {
                                    const aid = `${cid}_${w}_${id}`;
                                    if(!APP.data.attendance.includes(aid)) {
                                        APP.data.attendance.push(aid);
                                        count++;
                                    }
                                });
                            }
                        }
                    });
                    
                    APP.db.save();
                    alert(`Imported Successfully. Processed ${count} entries.`);
                    document.getElementById('import-modal').style.display = 'none';
                    document.getElementById('import-file').value = '';
                    document.getElementById('import-text').value = '';
                    if(APP.import.type === 'students') APP.dbView.init();
                    if(APP.import.type === 'attendance') APP.attendance.render();
                }
            },

            export: {
                type: '',
                open: (t) => {
                    APP.export.type = t;
                    document.getElementById('export-modal').style.display = 'flex';
                    const grid = document.getElementById('export-checks'); grid.innerHTML = '';
                    APP.data.config.courses.forEach(c => grid.innerHTML += `<label><input type="checkbox" class="exp-chk" value="${c.id}"> ${c.code} G${c.grp}</label>`);
                },
                process: () => {
                    const grps = Array.from(document.querySelectorAll('.exp-chk:checked')).map(c=>c.value);
                    const wb = XLSX.utils.book_new();
                    grps.forEach(g => {
                        const sts = APP.data.students.filter(s => s.grp === g);
                        let data = [];
                        if(APP.export.type === 'attendance') {
                            data = sts.map(s => {
                                let r = { ID: s.id, Name: s.name };
                                for(let w=1; w<=APP.data.config.weeks; w++) {
                                    const date = APP.utils.getWeekDate(APP.data.config.courses.find(c=>c.id===g).startDate, w);
                                    if(date > new Date()) r[`Week ${w}`] = "";
                                    else r[`Week ${w}`] = APP.data.attendance.includes(`${g}_W${w}_${s.id}`) ? "P" : (APP.data.absent_attendance && APP.data.absent_attendance.includes(`${g}_W${w}_${s.id}`) ? "A" : "");
                                }
                                return r;
                            });
                        } else if(APP.export.type === 'grades') {
                            data = sts.map(s => {
                                let r = { "Student ID": s.id, "Name": s.name }; 
                                APP.data.assessments.filter(a => a.grp === g).forEach(a => {
                                    const headerName = `#${a.name.toUpperCase()} [${a.max || '0'}]`;
                                    r[headerName] = (APP.data.grades.find(x => x.id === `${s.id}_${a.id}`)||{}).val || '';
                                });
                                return r;
                            });
                        } else {
                            data = sts;
                        }
                        const ws = XLSX.utils.json_to_sheet(data);
                        XLSX.utils.book_append_sheet(wb, ws, g);
                    });
                    const fname = APP.data.config.taName ? APP.data.config.taName.split(' ')[0] : 'TA';
                    XLSX.writeFile(wb, `${fname}_${APP.export.type}.xlsx`);
                    document.getElementById('export-modal').style.display = 'none';
                }
            },

            admin: {
                init: async () => { 
                    const list = document.getElementById('admin-ta-list'); list.innerHTML = ''; 
                    const allTAs = await APP.db.getAllTAData(); 
                    if(allTAs.length === 0) list.innerHTML = `<div style="padding:20px; color:#666;">No TAs registered yet.</div>`; 
                    allTAs.forEach(record => { 
                        const id = record.id;
                        const d = record.data || {}; 
                        const name = d.config ? d.config.taName : "Unknown"; 
                        const lastLogin = d.lastLogin ? new Date(d.lastLogin).toLocaleString() : "Never"; 
                        let actions = ''; 
                        if(APP.role === 'viewonly') { 
                            actions = `<button class="btn btn-gold" onclick="APP.admin.backupTA('${id}')">BACKUP DATA</button>`; 
                        } else if(APP.role === 'manager') { 
                            actions = `<button class="btn btn-gold" onclick="APP.admin.backupTA('${id}')">BACKUP DATA</button><button class="btn btn-danger" onclick="APP.admin.del('${id}')">DELETE</button>`; 
                        } else { 
                            actions = `<button class="btn btn-primary" onclick="APP.auth.adminAccessTA('${id}')">VIEW</button><button class="btn btn-danger" onclick="APP.admin.del('${id}')">DELETE</button>`; 
                        } 
                        const meta = APP.role === 'admin' ? `<p style="font-size:0.8rem; color:#666; margin:5px 0;">Last Active: ${lastLogin}</p>` : ''; 
                        list.innerHTML += `<div class="dash-card"><h3>${name}</h3><p style="font-size:0.9rem; color:#666;">Index: ${id}</p>${meta}<div class="flex gap-10" style="margin-top:10px;">${actions}</div></div>`; 
                    }); 
                },
                del: async (id) => { if(confirm("Permanently delete this TA's data?")) { await APP.db.deleteTA(id); APP.admin.init(); } },
                backupTA: async (id) => { 
                    const record = await APP.db.getTAData(id); 
                    if(!record) return; 
                    const d = record.data; 
                    const fname = d.config ? d.config.taName.split(' ')[0] : id; 
                    const payload = {}; payload[id] = d; 
                    const blob = new Blob([JSON.stringify(payload)],{type:'application/json'}); 
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${fname}_Backup.json`; a.click(); 
                },
                openBackupModal: () => { document.getElementById('admin-backup-modal').style.display='flex'; APP.admin.switchBackupTab('bk'); },
                switchBackupTab: (tab) => { document.getElementById('adm-bk-tab').classList.toggle('hidden',tab!=='bk'); document.getElementById('adm-rs-tab').classList.toggle('hidden',tab!=='rs'); if(tab==='bk') APP.admin.renderBackupList(); },
                renderBackupList: async () => { 
                    const list = document.getElementById('adm-bk-list'); list.innerHTML = ''; 
                    const allTAs = await APP.db.getAllTAData(); 
                    allTAs.forEach(record => { 
                        const id = record.id;
                        const d = record.data || {}; 
                        const name = d.config ? d.config.taName : id; 
                        list.innerHTML += `<label><input type="checkbox" class="adm-bk-chk" value="${id}"> ${name} (${id})</label>`; 
                    }); 
                },
                toggleAllBackup: (el) => { document.querySelectorAll('.adm-bk-chk').forEach(c=>c.checked=el.checked); },
                processBackup: async () => { 
                    const selected = Array.from(document.querySelectorAll('.adm-bk-chk:checked')).map(c=>c.value); 
                    if(selected.length === 0) return alert("Select TAs to backup"); 
                    const master = {}; 
                    for(let id of selected) { 
                        const record = await APP.db.getTAData(id);
                        if(record) master[id] = record.data; 
                    } 
                    const blob = new Blob([JSON.stringify(master)],{type:'application/json'}); 
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `FULL_SYSTEM_BACKUP.json`; a.click(); 
                },
                processRestore: () => { 
                    const f = document.getElementById('adm-rs-file').files[0]; 
                    if(!f) return alert("Select File"); 
                    const r = new FileReader(); 
                    r.onload = (e) => { 
                        try { 
                            const data = JSON.parse(e.target.result); 
                            if(data.config || data.students) { 
                                alert("Error: This file appears to be a raw data file, not a valid System Backup. Please use the individual user restore menu."); 
                                return; 
                            } 
                            const count = Object.keys(data).length; 
                            if(confirm(`Found data for ${count} TAs. Restore/Overwrite their data?`)) { 
                                const taArray = [];
                                for(let id in data) { 
                                    if(data[id] && data[id].config) { 
                                        taArray.push({ id: id, data: data[id] });
                                    } 
                                } 
                                APP.db.batchPutTAs(taArray).then(() => {
                                    alert("System Restored Successfully"); 
                                    location.reload(); 
                                });
                            } 
                        } catch(e){alert("Invalid Backup File");} 
                    }; 
                    r.readAsText(f); 
                }
            },
            utils: {
                currentWeek: 1,
                calcCurrentWeek: () => { if(APP.data.config&&APP.data.config.courses.length>0) { const start=new Date(APP.data.config.courses[0].startDate); const diff=Math.floor((new Date()-start)/(1000*60*60*24)); APP.utils.currentWeek=Math.max(1,Math.ceil((diff+1)/7)); } },
                getWeekDate: (startStr, w) => { const start=new Date(startStr); const d=new Date(start); d.setDate(start.getDate()+((w-1)*7)); return d; },
                sort: (ctx, col) => { if(APP.sortState.col===col) APP.sortState.dir*=-1; else { APP.sortState.col=col; APP.sortState.dir=1; } if(ctx==='att') APP.attendance.render(); if(ctx==='db') APP.dbView.render(); if(ctx.startsWith('gr')) APP.grades.init(); },
                doSort: (arr, ctx) => { const col=APP.sortState.col; const dir=APP.sortState.dir; return arr.sort((a,b)=>{ let va=a[col], vb=b[col]; if(col==='total') { va=a.tempTotal; vb=b.tempTotal; } return (va>vb?1:-1)*dir; }); }
            }
        };

        window.onload = async function() {
            await APP.db.init();
            APP.nav.go('admin');
        };
    </script>
</body>
</html>
</template>
</body>
</html>